function t(t){return t.name||t.toString()}var e=Object.freeze({__proto__:null,getComponentTypeName:t});const n=Symbol("operator"),o=Symbol("handler");class r{static select(t,e){return new r(e,!1).select(t)}static computeKey(e){let o=[];for(let r of e)"object"==typeof r&&n in r?o.push(r[n].toString()+t(r)):o.push(t(r));return o.sort().join("-")}constructor(t,e=!0){this._included=[],this._operated={};for(let e of t)if("object"==typeof e&&n in e){const t=e[n];t in this._operated?this._operated[t].components.push(e.component):this._operated[t]={components:[e.component],handler:e[o]}}else this._included.push(e);this.entityManager=null,this.persistent=e,this.entityIds=new Set,this.key=r.computeKey(t),this.onEntityCreate=this.onEntityCreate.bind(this),this.onEntityDestroy=this.onEntityDestroy.bind(this),this.onComponentAdd=this.onComponentAdd.bind(this),this.onComponentRemove=this.onComponentRemove.bind(this)}matches(t,e){if(this.entityManager!==t)return!1;if(!t.hasComponent(e,...this._included))return!1;for(let n of Object.getOwnPropertyNames(this._operated))if(!n[o].call(this,t,e,n.components))return!1;return!0}select(t){let e=this.entityManager===t;if(this.persistent&&e)return this.entityIds;const n=this.entityManager;this.entityManager=t,this.entityIds.clear();for(let e of t.getEntityIds())this.matches(t,e)&&this.entityIds.add(e);return this.persistent&&!e&&(n&&(n.entityHandler.off("create",this.onEntityCreate),n.entityHandler.off("destroy",this.onEntityDestroy),n.componentHandler.off("add",this.onComponentAdd),n.componentHandler.off("remove",this.onComponentRemove)),this.entityManager.entityHandler.on("create",this.onEntityCreate),this.entityManager.entityHandler.on("destroy",this.onEntityDestroy),this.entityManager.componentHandler.on("add",this.onComponentAdd),this.entityManager.componentHandler.on("remove",this.onComponentRemove)),this.entityIds}selectComponent(t,e=this._included[0]){let n=this.select(t),o=[];for(let r of n)o.push(t.getComponent(r,e));return o}clear(){this.persistent&&(this.entityManager.entityHandler.off("create",this.onEntityCreate),this.entityManager.entityHandler.off("destroy",this.onEntityDestroy),this.entityManager.componentHandler.off("add",this.onComponentAdd),this.entityManager.componentHandler.off("remove",this.onComponentRemove)),this.entityIds.clear(),this.entityManager=null}onEntityCreate(t){this.matches(this.entityManager,t)&&this.entityIds.add(t)}onEntityDestroy(t){this.entityIds.has(t)&&this.entityIds.delete(t)}onComponentAdd(t,e,n,o){this.onComponentRemove(t,e,n)}onComponentRemove(t,e,n){this.matches(this.entityManager,t)?this.entityIds.add(t):this.entityIds.has(t)&&this.entityIds.delete(t)}}class i{constructor(){this._entities=new Set,this._nextAvailableEntityId=1,this._listeners=new Map}addEntityListener(t,e,n,o){const r=o&&void 0!==o.handle?o.handle:n;if(this._listeners.has(t)){let o=this._listeners.get(t);if(e in o){o[e].set(r,n)}else{let t=new Map;t.set(r,n),o[e]=t}}else{let i=new Set,s=new Map;s.set(r,n),o.once&&i.add(r);let a={onces:i,[e]:s};this._listeners.set(t,a)}}removeEntityListener(t,e,n,o){if(this._listeners.has(t)){let o=this._listeners.get(t);e in o&&(o[e].delete(n),o.onces.has(n)&&o.onces.delete(n))}}dispatchEntityEvent(t,e,n){if(this._listeners.has(t)){let o=this._listeners.get(t);if(e in o){let t=o.onces,r=o[e];for(let[e,o]of r.entries())o.apply(void 0,n),t.has(e)&&r.delete(e)}}}addEntityId(t){this._entities.add(t)}deleteEntityId(t){this._entities.delete(t),this.dispatchEntityEvent(t,"destroy",[t])}hasEntityId(t){return this._entities.has(t)}getNextAvailableEntityId(){return this._nextAvailableEntityId++}getEntityIds(){return this._entities}}class s{constructor(t){if(!t)throw new Error("Cannot create entity in null world.");const e=t.createEntity();t.componentHandler.putComponent(e,s,this,void 0),this.id=e}copy(t){throw new Error("Unsupported operation; cannot be initialized by existing values.")}reset(){return!1}}class a{constructor(t){this._entityHandler=t,this.componentTypeInstanceMap=new Map}createComponent(t,e){let n,o=typeof t;if("object"===o){if(!("create"in t))throw new Error(`Instanced component class '${getComponentTypeName(t)}' must at least have a static create() function.`);n=t.create(this)}else if("function"===o){if(t.prototype instanceof s)throw new Error("This component cannot be added to an existing entity; it can only initialize itself.");n=new t(this)}else{if("symbol"===o)throw new Error("Symbols are not yet supported as components.");n=t}return e&&this.copyComponent(t,n,e),n}putComponent(t,e,n=e,o){let r;if(this.componentTypeInstanceMap.has(e)?r=this.componentTypeInstanceMap.get(e):this.componentTypeInstanceMap.set(e,r=new Map),r.has(t))throw new Error(`Cannot add more than one instance of component class '${getComponentTypeName(e)}' for entity '${t}'.`);r.set(t,n),this._entityHandler.dispatchEntityEvent(t,"componentadd",[t,e,n,o])}deleteComponent(t,e,n){let o;return this.componentTypeInstanceMap.get(e).delete(t),o=e!==n&&("reset"in e?e.reset(n):"reset"in n&&n.reset()),this._entityHandler.dispatchEntityEvent(t,"componentremove",[t,e,n]),n}copyComponent(t,e,n){if(t!==e)if("copy"in t)t.copy(e,n);else if("copy"in e)e.copy(n);else for(let t of Object.getOwnPropertyNames(n))e[t]=n[t]}hasComponentType(t){return this.componentTypeInstanceMap.has(t)}getComponentTypes(){return this.componentTypeInstanceMap.keys()}getComponentInstanceMapByType(t){return this.componentTypeInstanceMap.get(t)}getComponentInstanceMaps(){return this.componentTypeInstanceMap.values()}}class d{constructor(){this.entityHandler=new i,this.componentHandler=new a(this.entityHandler)}clear(){for(let t of this.entityHandler.getEntityIds())this.destroyEntity(t)}createEntity(...t){const e=this.entityHandler.getNextAvailableEntityId();this.entityHandler.addEntityId(e);for(let n of t)this.addComponent(e,n);return e}destroyEntity(t){for(let e of this.componentHandler.getComponentTypes())this.componentHandler.getComponentInstanceMapByType(e).has(t)&&this.removeComponent(t,e);this.entityHandler.deleteEntityId(t)}hasEntity(t){return this.entityHandler.hasEntityId(t)}getEntityIds(){return this.entityHandler.getEntityIds()}addComponent(e,n,o){try{let t=this.componentHandler.createComponent(n,o);return this.componentHandler.putComponent(e,n,t,o),t}catch(o){console.error(`Failed to add component '${t(n)}' to entity '${e}'.`),console.error(o)}}addTagComponent(e,n){try{let t=typeof n;if("symbol"===t)throw new Error("Symbols are not yet supported as tag components.");if("number"===t)throw new Error("Numbers are not yet supported as tag components.");if("string"!==t)throw new Error(`Component of type '${t}' cannot be a tag component.`);return this.componentHandler.putComponent(e,n),n}catch(o){console.error(`Failed to add tag component '${t(n)}' to entity '${e}'.`),console.error(o)}}removeComponent(e,n){try{let t=this.getComponent(e,n);return this.componentHandler.deleteComponent(e,n,t),t}catch(o){console.error(`Failed to remove component '${t(n)}' from entity '${e}'.`),console.error(o)}}clearComponents(t){for(let e of this.componentHandler.getComponentInstanceMaps())if(e.has(t)){let n=e.get(t);this.componentHandler.deleteComponent(t,componentType,n)}}getComponentTypesByEntityId(t){let e=[];for(let n of this.componentHandler.getComponentTypes()){this.componentHandler.getComponentInstanceMapByType(n).has(t)&&e.push(n)}return e}getComponent(t,e){return this.componentHandler.getComponentInstanceMapByType(e).get(t)}hasComponent(t,...e){for(let n of e){if(!this.componentHandler.hasComponentType(n))return!1;if(!this.componentHandler.getComponentInstanceMapByType(n).has(t))return!1}return!0}countComponents(t){let e=0;for(let n of this.componentHandler.getComponentInstanceMaps())n.has(t)&&++e;return e}find(t){return r.select(this,t)}[Symbol.iterator](){return this.getEntityIds()[Symbol.iterator]()}}function c(t,e=Symbol(t.name)){let n=function(n){return{[OPERATOR]:e,[HANDLER]:t,component:n}};return Object.defineProperty(n,"name",{value:name,configurable:!0}),n}const l=c((function(t,e,n){return!t.hasComponent(e,...n)}),Symbol("!"));var p=Object.freeze({__proto__:null,createQueryOperator:c,Not:l});function h(t,e){return{}}function y(t,e){Object.assign(t,e)}function u(t){Object.getOwnPropertyNames(t).forEach(e=>delete t[e])}var m=Object.freeze({__proto__:null,createComponentFactory:function(t,e=h,n=y,o=u){return{name:t,create:e,copy:n,reset:o}}});const f=Symbol("defaultUndefined");class g{static get defaultValues(){return null}constructor(t,e,n=!0){"defaultValues"in this.constructor||(n?(this.constructor.defaultValues=null,this.constructor.defaultValues=new this.constructor):this.constructor.defaultValues=f)}copy(t){for(let e of Object.getOwnPropertyNames(t))this[e]=t[e]}reset(){if("defaultValues"in this.constructor){let t=this.constructor.defaultValues;if(t===f){for(let t of Object.getOwnPropertyNames(this))this[t]=void 0;return!0}return!!t&&(this.copy(this,this.constructor.defaultValues),!0)}return!1}}class C{}class E extends s{constructor(t){super(t),this.entityManager=t}destroy(){this.entityManager.destroyEntity(this.id)}addComponent(t,e){return this.entityManager.addComponent(this.id,t,e),this}addTagComponent(t){return this.entityManager.addTagComponent(this.id,t),this}removeComponent(t){return this.entityManager.removeComponent(this.id,t),this}hasComponent(t){return this.entityManager.hasComponent(this.id,t)}getComponent(t){return this.entityManager.getComponent(this.id,t)}}class v extends E{constructor(t){super(t),this.onComponentAdd=this.onComponentAdd.bind(this),this.onComponentRemove=this.onComponentRemove.bind(this),this.entityManager.entityHandler.addEntityListener(this.id,"componentadd",this.onComponentAdd),this.entityManager.entityHandler.addEntityListener(this.id,"componentremove",this.onComponentRemove)}onDestroy(){}onComponentAdd(t,e,n,o){this.id===t&&function(t,e,n){if("object"==typeof n){let o=Object.getOwnPropertyNames(t),r={};for(let t of Object.getOwnPropertyNames(n)){if(o.includes(t))throw new Error(`Conflicting property names in entity for component '${getComponentTypeName(e)}'.`);r[t]={get:()=>n[t],set(e){n[t]=e},configurable:!0}}Object.defineProperties(t,r)}}(this,e,n)}onComponentRemove(t,e,n){this.id===t&&(e===s?(this.entityManager.entityHandler.removeEntityListener(this.id,"componentadd",this.onComponentAdd),this.entityManager.entityHandler.removeEntityListener(this.id,"componentremove",this.onComponentRemove),this.onDestroy()):function(t,e,n){if("object"==typeof n)for(let e of Object.getOwnPropertyNames(n))delete t[e]}(this,0,n))}}var b=Object.freeze({__proto__:null,getEntityById:function(t,e){return getComponent(e,EntityComponent)},getEntities:function(t){let e=[],n=t.query([EntityComponent]);for(let o of n){let n=t.getComponent(o,EntityComponent);e.push(n)}return e}});class w{constructor(t){this.entityManager=t,this.id=t.createEntity()}add(t,e){return this.entityManager.addComponent(this.id,t,e),this}remove(t){return this.entityManager.removeComponent(this.id,t),this}has(...t){return this.entityManager.hasComponent(this.id,...t)}destroy(){this.entityManager.destroyEntity(this.id)}getEntityId(){return this.id}}var M=Object.freeze({__proto__:null,EntityWrapperBase:w,create:function(t){return new w(t)}});const _=Symbol("functionName"),I=Symbol("functionArguments");function H(t,e=[]){let n=t;for(let t of e)n="object"==typeof t&&_ in t?n[t[_]](...t[I]):n[t];return n}function O(t,e){return[...t,e]}function j(t,e,n=[]){return[...t,{[_]:e,[I]:n}]}class T extends Array{static createRecord(t,e,n,o=[]){return{type:t,path:o,key:e,value:n}}addRecord(t,e,n,o=[]){let r=T.createRecord(t,e,n,o);return this.push(r),r}addRecords(t){this.push(...t)}}function R(t,e,n){switch(n.type){case"new":case"edit":return e[n.key]=n.value,!0;case"delete":return delete e[n.key],!0}return!1}var S=Object.freeze({__proto__:null,isType:function(t){return Array.isArray(t)},applyDiff:function(t,e,n){switch(n.type){case"arrayObjectEdit":return e[n.key]=n.value,!0;case"arrayObjectAppend":return(o=n.key).length<r&&(o.length=r),e[n.key]=n.value,!0;case"arrayObjectSplice":return e.splice(n.key,n.value),!0}var o,r;return!1},computeDiff:function(t,e,n=[],o={}){let r=new T;const i=Math.min(t.length,e.length);for(let s=0;s<i;++s){let i=N(t[s],e[s],O(n,s),o);i?r.addRecords(i):r.addRecord("arrayObjectEdit",s,e[s],n)}if(!o.preserveSource&&t.length>e.length)r.addRecord("arrayObjectSplice",e.length,t.length-e.length,n);else if(e.length>t.length)for(let o=t.length;o<e.length;++o)r.addRecord("arrayObjectAppend",o,e[o],n);return r}});var A=Object.freeze({__proto__:null,isType:function(t){return t instanceof Set},applyDiff:function(t,e,n){switch(n.type){case"setAdd":return e.add(n.key),!0;case"setDelete":return e.delete(n.key),!0}return!1},computeDiff:function(t,e,n=[],o={}){let r=new T;for(let o of e)t.has(o)||r.addRecord("setAdd",o,void 0,n);if(!o.preserveSource)for(let o of t)e.has(o)||r.addRecord("setDelete",o,void 0,n);return r}});const D={handlers:[S,Object.freeze({__proto__:null,isType:function(t){return t instanceof Map},applyDiff:function(t,e,n){switch(n.type){case"mapNew":case"mapSet":return e.set(n.key,n.value),!0;case"mapDelete":return e.delete(n.key),!0}return!1},computeDiff:function(t,e,n=[],o={}){let r=new T;for(let[i,s]of e)if(t.has(i)){let e=N(t.get(i),s,j(n,"get",[i]),o);e?r.addRecords(e):r.addRecord("mapSet",i,s,n)}else r.addRecord("mapNew",i,s,n);if(!o.preserveSource)for(let o of t.keys())e.has(o)||r.addRecord("mapDelete",o,void 0,n);return r}}),A],preserveSource:!0,maxDepth:1e3};function N(t,e,n=[],o=D){if(n.length>=o.maxDepth)return null;if(typeof t!=typeof e)return null;if("object"==typeof t){for(let r of o.handlers){let i=r.isType(t);if(i^r.isType(e))return null;if(i)return r.computeDiff(t,e,n,o)}return function(t,e,n=[],o={}){let r=new T,i=new Set(Object.getOwnPropertyNames(t));for(let s of Object.getOwnPropertyNames(e))if(i.has(s)){i.delete(s);let a=N(t[s],e[s],O(n,s),o);a?r.addRecords(a):r.addRecord("edit",s,e[s],n)}else r.addRecord("new",s,e[s],n);if(!o.preserveSource)for(let t of i)r.addRecord("delete",t,void 0,n);return r}(t,e,n,o)}return t===e?[]:null}function $(t,e,n=D){let o=t;for(let r of e){o=H(t,r.path);let e=!1;for(let i of n.handlers)if(e=i.applyDiff(t,o,r),e)break;e||R(0,o,r)}return t}function k(t,e,n){const o=t.entityConstructor,r=t.entityManagers,i=e.entityConstructor;e.entityManagers;let s=new d,a=n&&n.worldObjectWrapper?n.worldObjectWrapper(s):s,c=o(a),l=i(a),p=new Map;for(let t of s.getComponentTypesByEntityId(l)){let e=s.getComponent(l,t),n=s.getComponent(c,t);if(n){let o=N(n,e);p.set(t,o)}else p.set(t,!0)}for(let t of s.getComponentTypesByEntityId(c))p.has(t)||p.set(t,!1);s.clear();for(let e of r)for(let n of t.entities.get(e).values())for(let[t,o]of p.entries())if("boolean"==typeof o)o?e.addComponent(n,t):e.removeComponent(n,t);else{$(e.getComponent(n,t),o)}}class P{constructor(t,e){this.moduleId=t.id,this.entityConstructor=e,this.entities=new Map}addEntity(t,e){if(this.entities.has(t))this.entities.get(t).add(e);else{let n=new Set;n.add(e),this.entities.set(t,n)}t.entityHandler.addEntityListener(e,"destroy",this.removeEntity.bind(this,t,e),{handle:`${this.moduleId}:${e}`})}removeEntity(t,e){t.entityHandler.removeEntityListener(e,"destroy",`${this.moduleId}:${e}`);let n=this.entities.get(t);n.delete(e),n.size<=0&&this.entities.delete(t)}replaceWith(t,e){(e&&e.replaceStrategy||k).call(void 0,this,t,e&&e.replaceOpts),this.entityConstructor=t.entityConstructor;for(let e of t.entityManagers)for(let n of t.entities.get(e).values())t.removeEntity(e,n),this.addEntity(e,n)}isEmpty(){return this.entities.size<=0}get entityManagers(){return this.entities.keys()}}const z=new Map;var x=Object.freeze({__proto__:null,enableForEntity:function(t,e,n){if(!z.has(t.id))throw new Error("Module must be accepted first for HER to enable hot entity replacement.");return z.get(t.id).addEntity(e,n),n},acceptForModule:function(t,e,n){let o=new P(t,e);if(z.has(t.id)){console.log(`Reloading '${t.id}'...`),z.get(t.id).replaceWith(o,n)}else console.log(`Preparing '${t.id}'...`),z.set(t.id,o);return t},getInstanceForModuleId:function(t){return HER_MODULES.get(t)}});export{e as Component,g as ComponentBase,m as ComponentFactory,b as Entity,E as EntityBase,s as EntityComponent,d as EntityManager,r as EntityQuery,M as EntityWrapper,k as FineDiffStrategy,P as HotEntityModule,x as HotEntityReplacement,p as QueryOperator,v as ReflexiveEntity,C as TagComponent};
