!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).Entity={})}(this,(function(t){"use strict";function e(t){return t.name||t.toString()}var n=Object.freeze({__proto__:null,getComponentTypeName:e});const o=Symbol("operator"),r=Symbol("handler");class i{static select(t,e){return new i(e,!1).select(t)}static computeKey(t){let n=[];for(let r of t)"object"==typeof r&&o in r?n.push(r[o].toString()+e(r)):n.push(e(r));return n.sort().join("-")}constructor(t,e=!0){this._included=[],this._operated={};for(let e of t)if("object"==typeof e&&o in e){const t=e[o];t in this._operated?this._operated[t].components.push(e.component):this._operated[t]={components:[e.component],handler:e[r]}}else this._included.push(e);this.entityManager=null,this.persistent=e,this.entityIds=new Set,this.key=i.computeKey(t),this.onEntityCreate=this.onEntityCreate.bind(this),this.onEntityDestroy=this.onEntityDestroy.bind(this),this.onComponentAdd=this.onComponentAdd.bind(this),this.onComponentRemove=this.onComponentRemove.bind(this)}matches(t,e){if(this.entityManager!==t)return!1;if(!t.hasComponent(e,...this._included))return!1;for(let n of Object.getOwnPropertyNames(this._operated))if(!n[r].call(this,t,e,n.components))return!1;return!0}select(t){let e=this.entityManager===t;if(this.persistent&&e)return this.entityIds;const n=this.entityManager;this.entityManager=t,this.entityIds.clear();for(let e of t.getEntityIds())this.matches(t,e)&&this.entityIds.add(e);return this.persistent&&!e&&(n&&(n.entityHandler.off("create",this.onEntityCreate),n.entityHandler.off("destroy",this.onEntityDestroy),n.componentHandler.off("add",this.onComponentAdd),n.componentHandler.off("remove",this.onComponentRemove)),this.entityManager.entityHandler.on("create",this.onEntityCreate),this.entityManager.entityHandler.on("destroy",this.onEntityDestroy),this.entityManager.componentHandler.on("add",this.onComponentAdd),this.entityManager.componentHandler.on("remove",this.onComponentRemove)),this.entityIds}selectComponent(t,e=this._included[0]){let n=this.select(t),o=[];for(let r of n)o.push(t.getComponent(r,e));return o}clear(){this.persistent&&(this.entityManager.entityHandler.off("create",this.onEntityCreate),this.entityManager.entityHandler.off("destroy",this.onEntityDestroy),this.entityManager.componentHandler.off("add",this.onComponentAdd),this.entityManager.componentHandler.off("remove",this.onComponentRemove)),this.entityIds.clear(),this.entityManager=null}onEntityCreate(t){this.matches(this.entityManager,t)&&this.entityIds.add(t)}onEntityDestroy(t){this.entityIds.has(t)&&this.entityIds.delete(t)}onComponentAdd(t,e,n,o){this.onComponentRemove(t,e,n)}onComponentRemove(t,e,n){this.matches(this.entityManager,t)?this.entityIds.add(t):this.entityIds.has(t)&&this.entityIds.delete(t)}}class s{constructor(){this._entities=new Set,this._nextAvailableEntityId=1,this._listeners=new Map}addEntityListener(t,e,n,o){const r=o&&void 0!==o.handle?o.handle:n;if(this._listeners.has(t)){let o=this._listeners.get(t);if(e in o){o[e].set(r,n)}else{let t=new Map;t.set(r,n),o[e]=t}}else{let i=new Set,s=new Map;s.set(r,n),o.once&&i.add(r);let a={onces:i,[e]:s};this._listeners.set(t,a)}}removeEntityListener(t,e,n,o){if(this._listeners.has(t)){let o=this._listeners.get(t);e in o&&(o[e].delete(n),o.onces.has(n)&&o.onces.delete(n))}}dispatchEntityEvent(t,e,n){if(this._listeners.has(t)){let o=this._listeners.get(t);if(e in o){let t=o.onces,r=o[e];for(let[e,o]of r.entries())o.apply(void 0,n),t.has(e)&&r.delete(e)}}}addEntityId(t){this._entities.add(t)}deleteEntityId(t){this._entities.delete(t),this.dispatchEntityEvent(t,"destroy",[t])}hasEntityId(t){return this._entities.has(t)}getNextAvailableEntityId(){return this._nextAvailableEntityId++}getEntityIds(){return this._entities}}class a{constructor(t){if(!t)throw new Error("Cannot create entity in null world.");const e=t.createEntity();t.componentHandler.putComponent(e,a,this,void 0),this.id=e}copy(t){throw new Error("Unsupported operation; cannot be initialized by existing values.")}reset(){return!1}}class d{constructor(t){this._entityHandler=t,this.componentTypeInstanceMap=new Map}createComponent(t,e){let n,o=typeof t;if("object"===o){if(!("create"in t))throw new Error(`Instanced component class '${getComponentTypeName(t)}' must at least have a static create() function.`);n=t.create(this)}else if("function"===o){if(t.prototype instanceof a)throw new Error("This component cannot be added to an existing entity; it can only initialize itself.");n=new t(this)}else{if("symbol"===o)throw new Error("Symbols are not yet supported as components.");n=t}return e&&this.copyComponent(t,n,e),n}putComponent(t,e,n=e,o){let r;if(this.componentTypeInstanceMap.has(e)?r=this.componentTypeInstanceMap.get(e):this.componentTypeInstanceMap.set(e,r=new Map),r.has(t))throw new Error(`Cannot add more than one instance of component class '${getComponentTypeName(e)}' for entity '${t}'.`);r.set(t,n),this._entityHandler.dispatchEntityEvent(t,"componentadd",[t,e,n,o])}deleteComponent(t,e,n){let o;return this.componentTypeInstanceMap.get(e).delete(t),o=e!==n&&("reset"in e?e.reset(n):"reset"in n&&n.reset()),this._entityHandler.dispatchEntityEvent(t,"componentremove",[t,e,n]),n}copyComponent(t,e,n){if(t!==e)if("copy"in t)t.copy(e,n);else if("copy"in e)e.copy(n);else for(let t of Object.getOwnPropertyNames(n))e[t]=n[t]}hasComponentType(t){return this.componentTypeInstanceMap.has(t)}getComponentTypes(){return this.componentTypeInstanceMap.keys()}getComponentInstanceMapByType(t){return this.componentTypeInstanceMap.get(t)}getComponentInstanceMaps(){return this.componentTypeInstanceMap.values()}}class c{constructor(){this.entityHandler=new s,this.componentHandler=new d(this.entityHandler)}clear(){for(let t of this.entityHandler.getEntityIds())this.destroyEntity(t)}createEntity(...t){const e=this.entityHandler.getNextAvailableEntityId();this.entityHandler.addEntityId(e);for(let n of t)this.addComponent(e,n);return e}destroyEntity(t){for(let e of this.componentHandler.getComponentTypes())this.componentHandler.getComponentInstanceMapByType(e).has(t)&&this.removeComponent(t,e);this.entityHandler.deleteEntityId(t)}hasEntity(t){return this.entityHandler.hasEntityId(t)}getEntityIds(){return this.entityHandler.getEntityIds()}addComponent(t,n,o){try{let e=this.componentHandler.createComponent(n,o);return this.componentHandler.putComponent(t,n,e,o),e}catch(o){console.error(`Failed to add component '${e(n)}' to entity '${t}'.`),console.error(o)}}addTagComponent(t,n){try{let e=typeof n;if("symbol"===e)throw new Error("Symbols are not yet supported as tag components.");if("number"===e)throw new Error("Numbers are not yet supported as tag components.");if("string"!==e)throw new Error(`Component of type '${e}' cannot be a tag component.`);return this.componentHandler.putComponent(t,n),n}catch(o){console.error(`Failed to add tag component '${e(n)}' to entity '${t}'.`),console.error(o)}}removeComponent(t,n){try{let e=this.getComponent(t,n);return this.componentHandler.deleteComponent(t,n,e),e}catch(o){console.error(`Failed to remove component '${e(n)}' from entity '${t}'.`),console.error(o)}}clearComponents(t){for(let e of this.componentHandler.getComponentInstanceMaps())if(e.has(t)){let n=e.get(t);this.componentHandler.deleteComponent(t,componentType,n)}}getComponentTypesByEntityId(t){let e=[];for(let n of this.componentHandler.getComponentTypes()){this.componentHandler.getComponentInstanceMapByType(n).has(t)&&e.push(n)}return e}getComponent(t,e){return this.componentHandler.getComponentInstanceMapByType(e).get(t)}hasComponent(t,...e){for(let n of e){if(!this.componentHandler.hasComponentType(n))return!1;if(!this.componentHandler.getComponentInstanceMapByType(n).has(t))return!1}return!0}countComponents(t){let e=0;for(let n of this.componentHandler.getComponentInstanceMaps())n.has(t)&&++e;return e}find(t){return i.select(this,t)}[Symbol.iterator](){return this.getEntityIds()[Symbol.iterator]()}}function l(t,e=Symbol(t.name)){let n=function(n){return{[OPERATOR]:e,[HANDLER]:t,component:n}};return Object.defineProperty(n,"name",{value:name,configurable:!0}),n}const p=l((function(t,e,n){return!t.hasComponent(e,...n)}),Symbol("!"));var h=Object.freeze({__proto__:null,createQueryOperator:l,Not:p});function y(t,e){return{}}function u(t,e){Object.assign(t,e)}function f(t){Object.getOwnPropertyNames(t).forEach(e=>delete t[e])}var m=Object.freeze({__proto__:null,createComponentFactory:function(t,e=y,n=u,o=f){return{name:t,create:e,copy:n,reset:o}}});const g=Symbol("defaultUndefined");class C extends a{constructor(t){super(t),this.entityManager=t}destroy(){this.entityManager.destroyEntity(this.id)}addComponent(t,e){return this.entityManager.addComponent(this.id,t,e),this}addTagComponent(t){return this.entityManager.addTagComponent(this.id,t),this}removeComponent(t){return this.entityManager.removeComponent(this.id,t),this}hasComponent(t){return this.entityManager.hasComponent(this.id,t)}getComponent(t){return this.entityManager.getComponent(this.id,t)}}var E=Object.freeze({__proto__:null,getEntityById:function(t,e){return getComponent(e,EntityComponent)},getEntities:function(t){let e=[],n=t.query([EntityComponent]);for(let o of n){let n=t.getComponent(o,EntityComponent);e.push(n)}return e}});class v{constructor(t){this.entityManager=t,this.id=t.createEntity()}add(t,e){return this.entityManager.addComponent(this.id,t,e),this}remove(t){return this.entityManager.removeComponent(this.id,t),this}has(...t){return this.entityManager.hasComponent(this.id,...t)}destroy(){this.entityManager.destroyEntity(this.id)}getEntityId(){return this.id}}var b=Object.freeze({__proto__:null,EntityWrapperBase:v,create:function(t){return new v(t)}});const M=Symbol("functionName"),w=Symbol("functionArguments");function _(t,e=[]){let n=t;for(let t of e)n="object"==typeof t&&M in t?n[t[M]](...t[w]):n[t];return n}function I(t,e){return[...t,e]}function H(t,e,n=[]){return[...t,{[M]:e,[w]:n}]}class O extends Array{static createRecord(t,e,n,o=[]){return{type:t,path:o,key:e,value:n}}addRecord(t,e,n,o=[]){let r=O.createRecord(t,e,n,o);return this.push(r),r}addRecords(t){this.push(...t)}}function j(t,e,n){switch(n.type){case"new":case"edit":return e[n.key]=n.value,!0;case"delete":return delete e[n.key],!0}return!1}var R=Object.freeze({__proto__:null,isType:function(t){return Array.isArray(t)},applyDiff:function(t,e,n){switch(n.type){case"arrayObjectEdit":return e[n.key]=n.value,!0;case"arrayObjectAppend":return(o=n.key).length<r&&(o.length=r),e[n.key]=n.value,!0;case"arrayObjectSplice":return e.splice(n.key,n.value),!0}var o,r;return!1},computeDiff:function(t,e,n=[],o={}){let r=new O;const i=Math.min(t.length,e.length);for(let s=0;s<i;++s){let i=A(t[s],e[s],I(n,s),o);i?r.addRecords(i):r.addRecord("arrayObjectEdit",s,e[s],n)}if(!o.preserveSource&&t.length>e.length)r.addRecord("arrayObjectSplice",e.length,t.length-e.length,n);else if(e.length>t.length)for(let o=t.length;o<e.length;++o)r.addRecord("arrayObjectAppend",o,e[o],n);return r}});var T=Object.freeze({__proto__:null,isType:function(t){return t instanceof Set},applyDiff:function(t,e,n){switch(n.type){case"setAdd":return e.add(n.key),!0;case"setDelete":return e.delete(n.key),!0}return!1},computeDiff:function(t,e,n=[],o={}){let r=new O;for(let o of e)t.has(o)||r.addRecord("setAdd",o,void 0,n);if(!o.preserveSource)for(let o of t)e.has(o)||r.addRecord("setDelete",o,void 0,n);return r}});const S={handlers:[R,Object.freeze({__proto__:null,isType:function(t){return t instanceof Map},applyDiff:function(t,e,n){switch(n.type){case"mapNew":case"mapSet":return e.set(n.key,n.value),!0;case"mapDelete":return e.delete(n.key),!0}return!1},computeDiff:function(t,e,n=[],o={}){let r=new O;for(let[i,s]of e)if(t.has(i)){let e=A(t.get(i),s,H(n,"get",[i]),o);e?r.addRecords(e):r.addRecord("mapSet",i,s,n)}else r.addRecord("mapNew",i,s,n);if(!o.preserveSource)for(let o of t.keys())e.has(o)||r.addRecord("mapDelete",o,void 0,n);return r}}),T],preserveSource:!0,maxDepth:1e3};function A(t,e,n=[],o=S){if(n.length>=o.maxDepth)return null;if(typeof t!=typeof e)return null;if("object"==typeof t){for(let r of o.handlers){let i=r.isType(t);if(i^r.isType(e))return null;if(i)return r.computeDiff(t,e,n,o)}return function(t,e,n=[],o={}){let r=new O,i=new Set(Object.getOwnPropertyNames(t));for(let s of Object.getOwnPropertyNames(e))if(i.has(s)){i.delete(s);let a=A(t[s],e[s],I(n,s),o);a?r.addRecords(a):r.addRecord("edit",s,e[s],n)}else r.addRecord("new",s,e[s],n);if(!o.preserveSource)for(let t of i)r.addRecord("delete",t,void 0,n);return r}(t,e,n,o)}return t===e?[]:null}function D(t,e,n=S){let o=t;for(let r of e){o=_(t,r.path);let e=!1;for(let i of n.handlers)if(e=i.applyDiff(t,o,r),e)break;e||j(0,o,r)}return t}function N(t,e,n){const o=t.entityConstructor,r=t.entityManagers,i=e.entityConstructor;e.entityManagers;let s=new c,a=n&&n.worldObjectWrapper?n.worldObjectWrapper(s):s,d=o(a),l=i(a),p=new Map;for(let t of s.getComponentTypesByEntityId(l)){let e=s.getComponent(l,t),n=s.getComponent(d,t);if(n){let o=A(n,e);p.set(t,o)}else p.set(t,!0)}for(let t of s.getComponentTypesByEntityId(d))p.has(t)||p.set(t,!1);s.clear();for(let e of r)for(let n of t.entities.get(e).values())for(let[t,o]of p.entries())if("boolean"==typeof o)o?e.addComponent(n,t):e.removeComponent(n,t);else{D(e.getComponent(n,t),o)}}class ${constructor(t,e){this.moduleId=t.id,this.entityConstructor=e,this.entities=new Map}addEntity(t,e){if(this.entities.has(t))this.entities.get(t).add(e);else{let n=new Set;n.add(e),this.entities.set(t,n)}t.entityHandler.addEntityListener(e,"destroy",this.removeEntity.bind(this,t,e),{handle:`${this.moduleId}:${e}`})}removeEntity(t,e){t.entityHandler.removeEntityListener(e,"destroy",`${this.moduleId}:${e}`);let n=this.entities.get(t);n.delete(e),n.size<=0&&this.entities.delete(t)}replaceWith(t,e){(e&&e.replaceStrategy||N).call(void 0,this,t,e&&e.replaceOpts),this.entityConstructor=t.entityConstructor;for(let e of t.entityManagers)for(let n of t.entities.get(e).values())t.removeEntity(e,n),this.addEntity(e,n)}isEmpty(){return this.entities.size<=0}get entityManagers(){return this.entities.keys()}}const k=new Map;var x=Object.freeze({__proto__:null,enableForEntity:function(t,e,n){if(!k.has(t.id))throw new Error("Module must be accepted first for HER to enable hot entity replacement.");return k.get(t.id).addEntity(e,n),n},acceptForModule:function(t,e,n){let o=new $(t,e);if(k.has(t.id)){console.log(`Reloading '${t.id}'...`),k.get(t.id).replaceWith(o,n)}else console.log(`Preparing '${t.id}'...`),k.set(t.id,o);return t},getInstanceForModuleId:function(t){return HER_MODULES.get(t)}});t.Component=n,t.ComponentBase=class{static get defaultValues(){return null}constructor(t,e,n=!0){"defaultValues"in this.constructor||(n?(this.constructor.defaultValues=null,this.constructor.defaultValues=new this.constructor):this.constructor.defaultValues=g)}copy(t){for(let e of Object.getOwnPropertyNames(t))this[e]=t[e]}reset(){if("defaultValues"in this.constructor){let t=this.constructor.defaultValues;if(t===g){for(let t of Object.getOwnPropertyNames(this))this[t]=void 0;return!0}return!!t&&(this.copy(this,this.constructor.defaultValues),!0)}return!1}},t.ComponentFactory=m,t.Entity=E,t.EntityBase=C,t.EntityComponent=a,t.EntityManager=c,t.EntityQuery=i,t.EntityWrapper=b,t.FineDiffStrategy=N,t.HotEntityModule=$,t.HotEntityReplacement=x,t.QueryOperator=h,t.ReflexiveEntity=class extends C{constructor(t){super(t),this.onComponentAdd=this.onComponentAdd.bind(this),this.onComponentRemove=this.onComponentRemove.bind(this),this.entityManager.entityHandler.addEntityListener(this.id,"componentadd",this.onComponentAdd),this.entityManager.entityHandler.addEntityListener(this.id,"componentremove",this.onComponentRemove)}onDestroy(){}onComponentAdd(t,e,n,o){this.id===t&&function(t,e,n){if("object"==typeof n){let o=Object.getOwnPropertyNames(t),r={};for(let t of Object.getOwnPropertyNames(n)){if(o.includes(t))throw new Error(`Conflicting property names in entity for component '${getComponentTypeName(e)}'.`);r[t]={get:()=>n[t],set(e){n[t]=e},configurable:!0}}Object.defineProperties(t,r)}}(this,e,n)}onComponentRemove(t,e,n){this.id===t&&(e===a?(this.entityManager.entityHandler.removeEntityListener(this.id,"componentadd",this.onComponentAdd),this.entityManager.entityHandler.removeEntityListener(this.id,"componentremove",this.onComponentRemove),this.onDestroy()):function(t,e,n){if("object"==typeof n)for(let e of Object.getOwnPropertyNames(n))delete t[e]}(this,0,n))}},t.TagComponent=class{},Object.defineProperty(t,"__esModule",{value:!0})}));
