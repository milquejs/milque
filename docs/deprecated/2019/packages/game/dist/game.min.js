!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).Game={})}(this,(function(t){"use strict";class e extends HTMLElement{static currentTime(){return performance.now()}static get observedAttributes(){return["onstart","onstop","onpreupdate","onupdate","onfixedupdate","onpostupdate","onpause","onresume"]}constructor(t=!0,e=!1){super(),this._controlled=e,this._connectedStart=t,this._animationFrameHandle=null,this.prevFrameTime=0,this.started=!1,this.paused=!1,this.fixedTimeStep=1/60,this.prevAccumulatedTime=0,this._onstart=null,this._onstop=null,this._onpreupdate=null,this._onupdate=null,this._onfixedupdate=null,this._onpostupdate=null,this._onpause=null,this._onresume=null,this.onAnimationFrame=this.onAnimationFrame.bind(this),this.onWindowFocus=this.onWindowFocus.bind(this),this.onWindowBlur=this.onWindowBlur.bind(this)}setFixedUpdatesPerSecond(t){return this.fixedTimeStep=1/t,this}connectedCallback(){window.addEventListener("focus",this.onWindowFocus),window.addEventListener("blur",this.onWindowBlur),this._connectedStart&&this.start()}disconnectedCallback(){window.removeEventListener("focus",this.onWindowFocus),window.removeEventListener("blur",this.onWindowBlur),this.stop()}attributeChangedCallback(t,e,s){switch(t){case"onstart":this._onstart=new Function("event",`with(document){with(this){${s}}}`).bind(this);break;case"onstop":this._onstop=new Function("event",`with(document){with(this){${s}}}`).bind(this);break;case"onpreupdate":this._onpreupdate=new Function("event",`with(document){with(this){${s}}}`).bind(this);break;case"onupdate":this._onupdate=new Function("event",`with(document){with(this){${s}}}`).bind(this);break;case"onfixedupdate":this._onfixedupdate=new Function("event",`with(document){with(this){${s}}}`).bind(this);break;case"onpostupdate":this._onpostupdate=new Function("event",`with(document){with(this){${s}}}`).bind(this);break;case"onpause":this._onpause=new Function("event",`with(document){with(this){${s}}}`).bind(this);break;case"onresume":this._onresume=new Function("event",`with(document){with(this){${s}}}`).bind(this)}}onWindowFocus(){this.started&&this.resume()}onWindowBlur(){this.started&&this.pause()}onAnimationFrame(t){if(this._controlled)throw new Error("Cannot run controlled game loop; call step() instead.");if(!this.started)throw new Error("Must be called after start().");this.animationFrameHandle=requestAnimationFrame(this.onAnimationFrame),this.step(t)}step(t=e.currentTime()){if(!this.started)return!1;const s=.001*(t-this.prevFrameTime);if(this.prevFrameTime=t,this.paused)return!1;if(this.dispatchEvent(new CustomEvent("preupdate",{detail:{delta:s},bubbles:!1,composed:!0})),this.dispatchEvent(new CustomEvent("update",{detail:{delta:s},bubbles:!1,composed:!0})),this.prevAccumulatedTime+=s,this.prevAccumulatedTime>250*this.fixedTimeStep){let t=250*this.fixedTimeStep,e=(this.prevAccumulatedTime-t)/this.fixedTimeStep;this.prevAccumulatedTime=t,console.error(`[ApplicationLoop] Too many updates! Skipped ${e} fixed updates.`)}for(;this.prevAccumulatedTime>=this.fixedTimeStep;)this.prevAccumulatedTime-=this.fixedTimeStep,this.dispatchEvent(new CustomEvent("fixedupdate",{bubbles:!1,composed:!0}));this.dispatchEvent(new CustomEvent("postupdate",{detail:{delta:s},bubbles:!1,composed:!0}))}start(){if(this.started)throw new Error("Loop already started.");this.started=!0,this.prevFrameTime=e.currentTime(),this.dispatchEvent(new CustomEvent("start",{bubbles:!1,composed:!0})),this.controlled||this.onAnimationFrame(this.prevFrameTime)}stop(){if(!this.started)throw new Error("Loop not yet started.");this.started=!1,this.dispatchEvent(new CustomEvent("stop",{bubbles:!1,composed:!0})),this._controlled||this.animationFrameHandle&&(cancelAnimationFrame(this.animationFrameHandle),this.animationFrameHandle=null)}pause(){this.paused||(this.paused=!0,this.dispatchEvent(new CustomEvent("pause",{bubbles:!1,composed:!0})))}resume(){this.pause&&(this.paused=!1,this.dispatchEvent(new CustomEvent("resume",{bubbles:!1,composed:!0})))}get onstart(){return this._onstart}set onstart(t){this._onstart&&this.removeEventListener("start",this._onstart),this._onstart=t,this._onstart&&this.addEventListener("start",t)}get onstop(){return this._onstop}set onstop(t){this._onstop&&this.removeEventListener("stop",this._onstop),this._onstop=t,this._onstop&&this.addEventListener("stop",t)}get onpreupdate(){return this._onpreupdate}set onpreupdate(t){this._onpreupdate&&this.removeEventListener("preupdate",this._onpreupdate),this._onpreupdate=t,this._onpreupdate&&this.addEventListener("preupdate",t)}get onupdate(){return this._onupdate}set onupdate(t){this._onupdate&&this.removeEventListener("update",this._onupdate),this._onupdate=t,this._onupdate&&this.addEventListener("update",t)}get onfixedupdate(){return this._onfixedupdate}set onfixedupdate(t){this._onfixedupdate&&this.removeEventListener("fixedupdate",this._onfixedupdate),this._onfixedupdate=t,this._onfixedupdate&&this.addEventListener("fixedupdate",t)}get onpostupdate(){return this._onpostupdate}set onpostupdate(t){this._onpostupdate&&this.removeEventListener("postupdate",this._onpostupdate),this._onpostupdate=t,this._onpostupdate&&this.addEventListener("postupdate",t)}get onpause(){return this._onpause}set onpause(t){this._onpause&&this.removeEventListener("pause",this._onpause),this._onpause=t,this._onpause&&this.addEventListener("pause",t)}get onresume(){return this._onresume}set onresume(t){this._onresume&&this.removeEventListener("resume",this._onresume),this._onresume=t,this._onresume&&this.addEventListener("resume",t)}}window.customElements.define("application-loop",e),t.ApplicationLoop=e,Object.defineProperty(t,"__esModule",{value:!0})}));
