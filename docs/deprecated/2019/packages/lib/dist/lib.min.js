!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@milque/input"),require("@milque/game"),require("@milque/display"),require("@milque/util"),require("@milque/math")):"function"==typeof define&&define.amd?define(["exports","@milque/input","@milque/game","@milque/display","@milque/util","@milque/math"],e):e((t=t||self).Lib={},t.input,t.game,t.display,t.util,t.math)}(this,(function(t,e,r,n,i,a){"use strict";const o=e.Input.createContext().disable(),s=o.registerRange("x","mouse[pos].x"),l=o.registerRange("y","mouse[pos].y"),u=o.registerState("ldown",{"mouse[0].up":0,"mouse[0].down":1}),d=o.registerState("rdown",{"mouse[2].up":0,"mouse[2].down":1}),h=o.registerAction("click","mouse.up"),p=o.registerAction("lclick","mouse[0].up"),c=o.registerAction("rclick","mouse[2].up");var f=Object.freeze({__proto__:null,CONTEXT:o,POS_X:s,POS_Y:l,LEFT_DOWN:u,RIGHT_DOWN:d,CLICK:h,LEFT_CLICK:p,RIGHT_CLICK:c});const m=e.Input.createContext().disable(),x=m.registerState("up",{"key[ArrowUp].up":0,"key[ArrowUp].down":1,"key[w].up":0,"key[w].down":1}),y=m.registerState("down",{"key[ArrowDown].up":0,"key[ArrowDown].down":1,"key[s].up":0,"key[s].down":1}),g=m.registerState("left",{"key[ArrowLeft].up":0,"key[ArrowLeft].down":1,"key[a].up":0,"key[a].down":1}),w=m.registerState("right",{"key[ArrowRight].up":0,"key[ArrowRight].down":1,"key[d].up":0,"key[d].down":1});var _=Object.freeze({__proto__:null,CONTEXT:m,UP:x,DOWN:y,LEFT:g,RIGHT:w});var S=Object.freeze({__proto__:null,createSpawner:function(t){return{entities:new Set,factory:t,create(...t){return this.factory.apply(null,t)},destroy(t){this.entities.delete(t)},spawn(...t){let e=this.create(...t);return this.entities.add(e),e},clear(){this.entities.clear()},[Symbol.iterator](){return this.entities.values()}}}});const v=Symbol("gameInfo");async function k(t){t||(t={});let e=t.load&&await t.load(t)||Object.isExtensible(t)&&t||{},r={game:t,view:null,viewport:null,display:null,loop:null,onframe:P.bind(void 0,e),onpreupdate:T.bind(void 0,e),onupdate:O.bind(void 0,e),onfixedupdate:C.bind(void 0,e),onpostupdate:L.bind(void 0,e),onfirstupdate:b.bind(void 0,e)};return Object.defineProperty(e,v,{value:r,enumerable:!1,configurable:!0}),e}function M(t){let e=document.querySelector("display-port");e||(e=new n.DisplayPort,e.toggleAttribute("full"),e.toggleAttribute("debug"),document.body.appendChild(e));let i=t.view||new n.View,a=t.viewport||{x:0,y:0,get width(){return e.getCanvas().clientWidth},get height(){return e.getCanvas().clientHeight}},o=new r.ApplicationLoop,s=t[v];return s.view=i,s.viewport=a,s.display=e,s.loop=o,o.addEventListener("update",s.onfirstupdate,{once:!0}),o.start(),t}function b(t,e){let{game:r,display:n,loop:i,onpreupdate:a,onupdate:o,onpostupdate:s,onfixedupdate:l,onframe:u}=t[v];r.start&&r.start.call(t),a.call(t,e),o.call(t,e),l.call(t,e),s.call(t,e),i.addEventListener("preupdate",a),i.addEventListener("update",o),i.addEventListener("fixedupdate",l),i.addEventListener("postupdate",s),n.addEventListener("frame",u)}function T(t,e){let{game:r}=t[v],n=e.detail.delta;r.preupdate&&r.preupdate.call(t,n)}function O(t,e){let{game:r}=t[v],n=e.detail.delta;r.update&&r.update.call(t,n)}function C(t,e){let{game:r}=t[v];r.fixedupdate&&r.fixedupdate.call(t)}function L(t,e){let{game:r}=t[v],n=e.detail.delta;r.postupdate&&r.postupdate.call(t,n)}function P(t,e){let{game:r,display:n,view:i,viewport:a}=t[v],o=e.detail.context;i.context.setTransform(1,0,0,1,0,0),i.context.clearRect(0,0,i.width,i.height),r.render&&r.render.call(t,i,t),n.clear("black"),i.drawBufferToCanvas(o,a.x,a.y,a.width,a.height)}function E(t){let{game:e,loop:r,display:n,onframe:i,onpreupdate:a,onupdate:o,onfixedupdate:s,onpostupdate:l,onfirstupdate:u}=t[v];return r.removeEventListener("update",u),r.removeEventListener("preupdate",a),r.removeEventListener("update",o),r.removeEventListener("fixedupdate",s),r.removeEventListener("postupdate",l),n.removeEventListener("frame",i),r.stop(),e.stop&&e.stop.call(t),t}async function A(t){let{game:e}=t[v];return e.unload&&await e.unload(t),t}var R=Object.freeze({__proto__:null,getGameInfo:function(t){return t[v]},load:k,start:M,pause:async function(t){let{loop:e}=t[v];e.pause()},resume:async function(t){let{loop:e}=t[v];e.resume()},stop:E,unload:A});async function U(t){return M(await k(t))}async function q(t){return E(t),await A(t),t}var D=Object.freeze({__proto__:null,randomHexColor:function(){return"#"+Math.floor(16777215*Math.random()).toString(16)},loadImage:function(t){let e=new Image;return e.src=t,e},clearScreen:function(t,e,r){t.fillStyle="black",t.fillRect(0,0,e,r)},drawText:function(t,e,r,n,i=0,a=16,o="white"){t.translate(r,n),i&&t.rotate(i),t.textAlign="center",t.textBaseline="middle",t.font=`${a}px sans-serif`,t.fillStyle=o,t.fillText(e,0,0),i&&t.rotate(-i),t.translate(-r,-n)},drawBox:function(t,e,r,n=0,i=16,a=i,o="white",s=!1){t.translate(e,r),n&&t.rotate(n),s?(t.strokeStyle=o,t.strokeRect(-i/2,-a/2,i,a)):(t.fillStyle=o,t.fillRect(-i/2,-a/2,i,a)),n&&t.rotate(-n),t.translate(-e,-r)},intersectBox:function(t,e){return 2*Math.abs(t.x-e.x)<t.width+e.width&&2*Math.abs(t.y-e.y)<t.height+e.height},applyMotion:function(t,e=1,r=e){1!==e&&(t.dx*=e),1!==r&&(t.dy*=r),t.x+=t.dx,t.y+=t.dy},drawCircle:function(t,e,r,n=16,i="white",a=!1){t.fillStyle=i,t.strokeStyle=i,t.beginPath(),t.arc(e,r,n,0,2*Math.PI),a?t.stroke():t.fill()}});const I={};class j{constructor(){this.registry=new Map,this.sharedContext={},this._scene=null,this._nextScene=null,this._nextLoadOpts=null,this._nextTransition=null}setSharedContext(t){return this.sharedContext=t,this}register(t,e){if("string"!=typeof t)throw new Error("Scene name must be a string.");return this.registry.set(t,e),this}unregister(t){return this.registry.delete(t),this}nextScene(t,e=null,r={}){if(this._nextScene)throw new Error("Cannot change scenes during a scene transition.");if("string"==typeof t){if(!this.registry.has(t))throw new Error(`Cannot find scene with name '${t}'.`);t=this.registry.get(t)}if("function"==typeof t)t=new t;else{if("object"!=typeof t)throw new Error("Scene type not supported.");Object.isExtensible(t)||(n=t,t={...n})}var n;this._nextScene=t,this._nextLoadOpts=r,this._nextTransition=e||I}update(t){if(this._transition)this._updateStep(t,this._transition);else if(this._nextScene){const t=this._nextScene,e=this._nextLoadOpts,r=this._nextTransition;this._nextScene=null,this._nextLoadOpts=null,this._nextTransition=null,this._transition=r;let n=Promise.resolve(),i=this._scene;i&&("onStop"in i&&i.onStop(this.sharedContext),"unload"in i&&(n=n.then(()=>i.unload(this.sharedContext)))),"load"in t&&(n=n.then(()=>t.load(this.sharedContext,e))),n=n.then(()=>{this._scene=t,this._transition=null,"onStart"in this._scene&&this._scene.onStart(this.sharedContext)})}else this._scene&&this._updateStep(t,this._scene)}_updateStep(t,e){"onPreUpdate"in e&&e.onPreUpdate(t),this.emit("preupdate",t),"onUpdate"in e&&e.onUpdate(t),this.emit("update",t),"onPostUpdate"in e&&e.onPostUpdate(t),this.emit("postupdate",t)}getCurrentScene(){return this._scene}getNextScene(){return this._nextScene}[Symbol.iterator](){return this.registry[Symbol.iterator]()}}i.Eventable.mixin(j);class F{getProjectionMatrix(){return[1,0,0,1,0,0]}getViewMatrix(){return[1,0,0,1,0,0]}}class z{constructor(t=0,e=0){this.matrix=[1,0,0,1,t,e]}setMatrix(t,e,r,n,i,a){return this.matrix[0]=t,this.matrix[1]=e,this.matrix[2]=r,this.matrix[3]=n,this.matrix[4]=i,this.matrix[5]=a,this}setPosition(t,e){return this.matrix[4]=t,this.matrix[5]=e,this}setRotation(t){return this.rotation=t,this}setScale(t,e=t){let r=Math.sin(this.rotation);return this.matrix[0]=t,this.matrix[1]=r*e,this.matrix[2]=-r*t,this.matrix[3]=e,this}get x(){return this.matrix[4]}set x(t){this.matrix[4]=t}get y(){return this.matrix[5]}set y(t){this.matrix[5]=t}get rotation(){return Math.atan2(-this.matrix[2],this.matrix[0])}set rotation(t){let e=this.scaleX,r=this.scaleY;t=Math.abs(t),this.matrix[1]=Math.sin(t)*r,this.matrix[2]=-Math.sin(t)*e}get scaleX(){return this.matrix[0]}set scaleX(t){let e=this.rotation;this.matrix[0]=t,this.matrix[2]=-Math.sin(e)*t}get scaleY(){return this.matrix[3]}set scaleY(t){let e=this.rotation;this.matrix[1]=Math.sin(e)*t,this.matrix[3]=t}get a(){return this.matrix[0]}get b(){return this.matrix[1]}get c(){return this.matrix[2]}get d(){return this.matrix[3]}get e(){return this.matrix[4]}get f(){return this.matrix[5]}get 0(){return this.matrix[0]}set 0(t){this.matrix[0]=t}get 1(){return this.matrix[1]}set 1(t){this.matrix[1]=t}get 2(){return this.matrix[2]}set 2(t){this.matrix[2]=t}get 3(){return this.matrix[3]}set 3(t){this.matrix[3]=t}get 4(){return this.matrix[4]}set 4(t){this.matrix[4]=t}get 5(){return this.matrix[5]}set 5(t){this.matrix[5]=t}get 6(){return 0}get 7(){return 0}get 8(){return 1}get length(){return 9}}const G=new DOMPointReadOnly(0,0,0,1),X=new DOMPointReadOnly(32,32,0,1),N=1/Math.log(2);function W(t,e,r,n,i=32,a=i,o=1,s=!1){t.beginPath();for(let r=n%a;r<e.height;r+=a)t.moveTo(0,r),t.lineTo(e.width,r);for(let n=r%i;n<e.width;n+=i)t.moveTo(n,0),t.lineTo(n,e.height);if(t.strokeStyle="#333333",t.lineWidth=o,t.stroke(),t.lineWidth=1,s){const s=Math.min(i/4,16);t.textAlign="left",t.textBaseline="top",t.font=`bold ${s}px monospace`,t.fillStyle="#333333";for(let s=n%a;s<e.height;s+=a)for(let l=r%i;l<e.width;l+=i)t.fillText(`(${Math.round((l-r)/i)},${Math.round((s-n)/a)})`,l+2*o,s+2*o)}}function $(t,e,r,n,i=n){const a=.6*n;t.textAlign="center",t.textBaseline="middle",t.font=`${a}px monospace`,t.translate(e,r),t.beginPath(),t.moveTo(0,0),t.lineTo(n,0),t.strokeStyle="#FF0000",t.stroke(),t.fillStyle="#FF0000",t.fillText("x",n+a,0),t.beginPath(),t.moveTo(0,0),t.lineTo(0,i),t.strokeStyle="#00FF00",t.stroke(),t.fillStyle="#00FF00",t.fillText("y",0,i+a);const o=a/4;t.fillStyle="#0000FF",t.fillRect(-o/2,-o/2,o,o),t.fillText("z",a/2,a/2),t.translate(-e,-r)}var B=Object.freeze({__proto__:null,drawWorldGrid:function(t,e,r){const n=new DOMMatrixReadOnly(r.getViewMatrix()),i=new DOMMatrixReadOnly(r.getProjectionMatrix()).multiply(n),a=i.transformPoint(G),o=i.transformPoint(X),s=o.x-a.x,l=o.y-a.y,u=Math.floor((Math.log(e.width)-Math.log(s))*N);let d=Math.pow(2,u)*s,h=Math.pow(2,u)*l;0!==d&&0!==h&&(W(t,e,a.x,a.y,d,h,1,!1),W(t,e,a.x,a.y,d/2,h/2,.75,!1),W(t,e,a.x,a.y,d/4,h/4,.5,!1),W(t,e,a.x,a.y,d/8,h/8,.25,!1))},drawWorldTransformGizmo:function(t,e,r){const n=new DOMMatrixReadOnly(r.getViewMatrix()).transformPoint(G),i=e.width/32;t.fillStyle="#666666",t.textAlign="left",t.textBaseline="top",t.font=`${i}px monospace`,t.fillText(`(${-Math.floor(n.x)},${-Math.floor(n.y)})`,32,32),$(t,8,8,32,32)},drawGrid:W,drawTransformGizmo:$});const H=e.Input.createContext().disable(),Y=H.registerState("up",{"key[ArrowUp].up":0,"key[ArrowUp].down":1,"key[w].up":0,"key[w].down":1}),V=H.registerState("down",{"key[ArrowDown].up":0,"key[ArrowDown].down":1,"key[s].up":0,"key[s].down":1}),K=H.registerState("left",{"key[ArrowLeft].up":0,"key[ArrowLeft].down":1,"key[a].up":0,"key[a].down":1}),Z=H.registerState("right",{"key[ArrowRight].up":0,"key[ArrowRight].down":1,"key[d].up":0,"key[d].down":1}),J=H.registerState("zoomin",{"key[z].up":0,"key[z].down":1}),Q=H.registerState("zoomout",{"key[x].up":0,"key[x].down":1}),tt=H.registerState("rollleft",{"key[q].up":0,"key[q].down":1}),et=H.registerState("rollright",{"key[e].up":0,"key[e].down":1});var rt=Object.freeze({__proto__:null,CONTEXT:H,UP:Y,DOWN:V,LEFT:K,RIGHT:Z,ZOOM_IN:J,ZOOM_OUT:Q,ROLL_LEFT:tt,ROLL_RIGHT:et,doCameraMove:function(t,e=6,r=.02,n=.01){const i=Z.value-K.value,a=V.value-Y.value,o=Q.value-J.value;et.value,tt.value;let s=o*r+1,l=t.transform.scaleX*s,u=t.transform.scaleY*s;t.transform.setScale(l,u);let d=i*e/l,h=a*e/u;t.transform.x+=d,t.transform.y+=h}});t.AbstractCamera=F,t.Camera2D=class extends F{static applyTransform(t,e,r=0,n=0){e.setOffset(r,n),t.setTransform(...e.getProjectionMatrix()),t.transform(...e.getViewMatrix())}static resetTransform(t){t.setTransform(1,0,0,1,0,0)}static followTarget(t,e,r=1){e&&(t.transform.x=a.lerp(t.transform.x,e.x,r),t.transform.y=a.lerp(t.transform.y,e.y,r))}constructor(t=0,e=0,r=1){super(),this.target=null,this.speed=r,this.transform=new z,this.offsetX=t,this.offsetY=e}setOffset(t,e){return this.offsetX=t,this.offsetY=e,this}getProjectionMatrix(){return[this.transform.matrix[0],0,0,this.transform.matrix[3],this.offsetX,this.offsetY]}getViewMatrix(){let t=[...this.transform.matrix];return t[0]=Math.cos(this.transform.rotation),t[3]=t[0],t[4]=-t[4],t[5]=-t[5],t}},t.Camera2DControls=rt,t.CameraHelper=B,t.EntitySpawner=S,t.GameInterface=R,t.MouseControls=f,t.MoveControls=_,t.SceneBase=class{async load(t,e){}async unload(t){}onStart(t){}onStop(t){}onPreUpdate(t){}onUpdate(t){}onPostUpdate(t){}},t.SceneManager=j,t.Transform2D=z,t.Utils=D,t.nextUp=async function(t,e){return await q(t),await U(e)},t.shutDown=q,t.startUp=U,Object.defineProperty(t,"__esModule",{value:!0})}));
