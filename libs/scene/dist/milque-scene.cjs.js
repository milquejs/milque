"use strict";var e=require("gl-matrix");const t=e.vec3.fromValues(0,1,0);class s{constructor(e,t){this.projectionMatrix=e,this.viewMatrix=t}resize(e,t){return this}}const r=Math.PI/3;const i=Math.PI/180;const n=100;function o(e,t,s){e?(s.nodes[e].children.push(t),s.nodes[t].parent=e):(s.roots.push(t),s.nodes[t].parent=0)}function l(e,t,s){if(e){let r=s.nodes[e].children,i=r.indexOf(t);r.splice(i,1),s.nodes[t].parentNode=0}else{let e=s.roots,r=e.indexOf(t);e.splice(r,1),s.nodes[t].parentNode=0}}function h(e,t,s,r,i){if(s>=n)return;let o=r(t,e);if(!1===o)return;let l=e.nodes[t],a=i?i(l.children,t,e):l.children;for(let t of a)h(e,t,s+1,r,i);"function"==typeof o&&o(t,e)}function a(e,t){delete t.nodes[e]}function c(e,t){let s=e.components;if(t in s)return s[t];{let e={};return s[t]=e,e}}function u(e,t,s,r){return c(e,s.name)[t]=r,r}function d(e,t,s){let r=c(e,s.name),i=r[t];delete r[t],s.delete(i)}function p(e,t){let s=t.name,r=c(e,s),i=Object.values(r);!function(e,t){let s={};e.components[t]=s}(e,s);for(let e of i)t.delete(e)}const f=Symbol("nextAvailableEntityId");function m(e){return++e[f]}class v{dispatch(e=null){}dispatchImmediately(e=null){}flush(e=1e3){}}function g(e,t){return e.priority-t.priority}exports.Camera=s,exports.CommandTopic=class extends v{constructor(){super(),this.messages=[],this.queued=[]}dispatch(e){this.queued.push(e)}dispatchImmediately(e){this.messages.push(e)}flush(e=1e3){let t=this.queued.splice(0,Math.min(e,this.queued.length));this.messages.push(...t)}*poll(e=1e3){let t=0;for(;t<e&&this.messages.length>0;){let e=this.messages.shift();yield e,++t}}},exports.ComponentClass=class{constructor(e,t=(()=>null),s=(()=>{})){this.name=e,this.new=t,this.delete=s}},exports.EntityManager=class{constructor(){this.components={},this[f]=1,this.queue=[]}flush(){for(;this.queue.length>0;){let[e,...t]=this.queue.shift();switch(e){case"attach":{let[e,s,r]=t;u(this,e,s,r)}break;case"detach":{let[e,s]=t;d(this,e,s)}break;case"clear":{let[e]=t;p(this,e)}}}}createAndAttach(...e){let t=m(this),s=[t];for(let r of e){let e=this.attach(t,r);s.push(e)}return s}create(){return m(this)}destroy(e){for(let t of Object.values(this.components))e in t&&delete t[e]}exists(e){for(let t of Object.values(this.components))if(e in t)return!0;return!1}attach(e,t){let s=t.new();return this.queue.push(["attach",e,t,s]),s}attachImmediately(e,t){let s=t.new();return u(this,e,t,s)}detach(e,t){this.queue.push(["detach",e,t])}detachImmediately(e,t){d(this,e,t)}clear(e){this.queue.push(["clear",e])}clearImmediately(e){p(this,e)}get(e,t){let s=c(this,t.name);return s?null:s[e]||null}count(e){let t=c(this,e.name);return t?0:Object.keys(t).length}reset(){this.components={},this[f]=1,this.queue.length=0}},exports.EntityQuery=class{constructor(...e){this.selectors=e}count(e){let t=0,s=this.findAll(e);for(;!s.next().done;)++t;return t}find(e){let t=this.findAll(e).next();return t.done?[]:t.value}*findAll(e){if(this.selectors.length<=0)return;let t=c(e,this.selectors[0].name),s=new Array(this.selectors.length+1);for(let r of Object.keys(t)){let t=Number(r),i=!0;s[0]=t;let n=1;for(let r of this.selectors){let o=c(e,r.name);if(!(t in o)){i=!1;break}let l=o[t];s[n++]=l}i&&(yield s)}}},exports.EntityTemplate=class{constructor(...e){this.componentClasses=e}create(e){let t=m(e),s=[t];for(let r of this.componentClasses){let i=e.attach(t,r);s.push(i)}return s}destroy(e,t){for(let s of this.componentClasses)e.detach(t,s)}},exports.EventTopic=class extends v{constructor(){super(),this.listeners=[],this.queued=[]}on(e){return this.listeners.push(e),this}off(e){let t=this.listeners.indexOf(e);return t>=0&&this.listeners.splice(t,1),this}once(e){let t=s=>(this.off(t),e(s));return this.on(t),this}dispatch(e=null){this.queued.push(e)}dispatchImmediately(e=null){for(let t of this.listeners){if(!0===t(e))break}}flush(e=1e3){let t=0;for(;this.queued.length>0&&t++<e;){let e=this.queued.shift();this.dispatchImmediately(e)}}count(){return this.listeners.length}},exports.FirstPersonCameraController=class{constructor(t={locky:!1}){this.locky=t.locky,this.position=e.vec3.create(),this.forward=e.vec3.fromValues(0,0,-1),this.right=e.vec3.fromValues(1,0,0),this.up=e.vec3.fromValues(0,1,0),this.forwardAmount=0,this.rightAmount=0,this.upAmount=0,this.pitch=0,this.yaw=-90}look(e,t,s=1){return s*=1e3,this.pitch=Math.min(89.9,Math.max(-89.9,this.pitch+t*s)),this.yaw=(this.yaw+e*s)%360,this}move(e,t=0,s=0,r=1){return this.forwardAmount+=e*r,this.rightAmount+=t*r,this.upAmount+=s*r,this}apply(t){let{position:s,forward:r,right:n,up:o,forwardAmount:l,rightAmount:h,upAmount:a,pitch:c,yaw:u}=this,d=u*i,p=c*i,f=Math.cos(d),m=Math.cos(p),v=Math.sin(d),g=f*m,y=Math.sin(p),x=v*m;e.vec3.normalize(r,e.vec3.set(r,g,this.locky?0:y,x)),e.vec3.normalize(n,e.vec3.cross(n,r,o));let b=e.vec3.create();e.vec3.scale(b,r,l),e.vec3.add(s,s,b),e.vec3.scale(b,n,h),e.vec3.add(s,s,b),e.vec3.scale(b,o,a),e.vec3.add(s,s,b),this.forwardAmount=0,this.rightAmount=0,this.upAmount=0,this.locky&&e.vec3.set(r,g,y,x);let A=e.vec3.add(b,s,r);return e.mat4.lookAt(t,s,A,o),t}},exports.OrthographicCamera=class extends s{constructor(t,s,r,i,n=-1e3,o=1e3){super(e.mat4.create(),e.mat4.create()),this.orthoBounds={left:void 0===t?void 0:Number(t),top:void 0===s?void 0:Number(s),right:void 0===r?void 0:Number(r),bottom:void 0===i?void 0:Number(i)},this.clippingPlane={near:Number(n),far:Number(o)}}resize(t,s){const{near:r,far:i}=this.clippingPlane,{left:n,top:o,right:l,bottom:h}=this.orthoBounds;let a=this.projectionMatrix,c=void 0!==n;if(void 0!==t)if(c){const c=t/s;e.mat4.ortho(a,n*c,l*c,h,o,r,i)}else e.mat4.ortho(a,0,t,s,0,r,i);else c?e.mat4.ortho(a,n,l,h,o,r,i):e.mat4.ortho(a,-1,1,1,-1,-1,1);return this}},exports.PerspectiveCamera=class extends s{constructor(t=r,s=.1,i=1e3){super(e.mat4.create(),e.mat4.create()),this.fieldOfView=Number(t),this.clippingPlane={near:Number(s),far:Number(i)}}resize(t,s){const r=void 0===t?1:t/s,{near:i,far:n}=this.clippingPlane;return e.mat4.perspective(this.projectionMatrix,this.fieldOfView,r,i,n),this}},exports.PriorityEventTopic=class extends v{constructor(){super(),this.listeners=[],this.queued=[]}on(e,t){return this.listeners.push({priority:e,callback:t}),this.listeners.sort(g),this}off(e){for(let t=0;t<this.listeners.length;++t)if(this.listeners.at(t).callback===e){this.listeners.splice(t,1);break}return this}once(e,t){let s=e=>(this.off(s),t(e));return this.on(e,s)}count(){return this.listeners.length}dispatch(e=null){return this.queued.push(e),this}dispatchImmediately(e=null){for(let t of this.listeners){if(!0===t.callback(e))break}return this}flush(e=1e3){let t=0;for(;this.queued.length>0&&t++<e;){let e=this.queued.shift();this.dispatchImmediately(e)}return this}},exports.SceneGraph=class{constructor(){this.nodes={},this.roots=[],this._nextAvailableSceneNodeId=1}createSceneNode(e){let t=this._nextAvailableSceneNodeId++,s={parent:0,children:[]};return this.nodes[t]=s,o(e,t,this),t}createSceneNodes(e,t){let s=[];for(let r=0;r<e;++r)s.push(this.createSceneNode(t));return s}deleteSceneNode(e){if(!(e in this.nodes))throw new Error("Cannot delete non-existant scene node for scene graph.");l(this.nodes[e].parent,e,this),h(this,e,0,a)}deleteSceneNodes(e){for(let t of e)this.deleteSceneNode(t)}getSceneNodeInfo(e){return this.nodes[e]}parentSceneNode(e,t){l(this.nodes[e].parent,e,this),o(t,e,this)}replaceSceneNode(e,t){let s=this.nodes[e],r=s.parent,i=s.children.slice();if(l(r,e,this),s.children.length=0,t){let e=this.nodes[t];l(e.parent,t,this),e.children.push(...i),o(r,t,this)}else if(r){this.nodes[r].children.push(...i)}else this.roots.push(...i);for(let e of i)this.nodes[e].parent=r}walk(e,t={}){const{from:s,childFilter:r}=t;let i;i=s?Array.isArray(s)?s:[s]:this.roots,r&&(i=r(i,0,this));for(let t of i)h(this,t,0,e,r)}},exports.Topic=v,exports.lookAt=function(s,r,i,n=0,o=1){let l=e.vec3.create(),h=e.quat.create();e.mat4.getTranslation(l,s),e.mat4.getRotation(h,s);let a=e.vec3.fromValues(r,i,n);e.mat4.lookAt(s,l,a,t);let c=e.quat.create();e.mat4.getRotation(c,s),e.quat.slerp(h,h,c,o),e.mat4.fromRotationTranslation(s,h,l)},exports.panTo=function(t,s,r,i=0,n=1){let o=e.vec3.create();e.mat4.getTranslation(o,t);let l=e.vec3.fromValues((s-o[0])*n,(r-o[1])*n,(i-o[2])*n);e.mat4.translate(t,t,l)},exports.screenToWorldRay=function(t,s,r,i,n,o=!1){let l=e.vec4.fromValues(s,r,-1,1),h=e.mat4.create();return e.mat4.invert(h,i),e.vec4.transformMat4(l,l,h),l[2]=-1,l[3]=0,e.mat4.invert(h,n),e.vec4.transformMat4(l,l,h),t[0]=l[0],t[1]=l[1],t[2]=l[2],o&&e.vec3.normalize(t,t),t};
//# sourceMappingURL=milque-scene.cjs.js.map
