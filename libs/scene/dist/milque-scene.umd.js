!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("gl-matrix")):"function"==typeof define&&define.amd?define(["exports","gl-matrix"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).milque=e.milque||{},e.milque.scene={}),e.glMatrix)}(this,(function(e,t){"use strict";const s=t.vec3.fromValues(0,1,0);class i{constructor(e,t){this.projectionMatrix=e,this.viewMatrix=t}resize(e,t){return this}}const n=Math.PI/3;const r=Math.PI/180;const o=100;function a(e,t,s){e?(s.nodes[e].children.push(t),s.nodes[t].parent=e):(s.roots.push(t),s.nodes[t].parent=0)}function l(e,t,s){if(e){let i=s.nodes[e].children,n=i.indexOf(t);i.splice(n,1),s.nodes[t].parentNode=0}else{let e=s.roots,i=e.indexOf(t);e.splice(i,1),s.nodes[t].parentNode=0}}function h(e,t,s,i,n){if(s>=o)return;let r=i(t,e);if(!1===r)return;let a=e.nodes[t],l=n?n(a.children,t,e):a.children;for(let t of l)h(e,t,s+1,i,n);"function"==typeof r&&r(t,e)}function c(e,t){delete t.nodes[e]}class u{constructor(){this.queries={},this.keyQueryMapping={},this.onEntityComponentChanged=this.onEntityComponentChanged.bind(this)}onEntityComponentChanged(e,t,s,i,n){for(let r of Object.values(this.keyQueryMapping)){let o=this.queries[r.key];if(n){let e=o.indexOf(t);e>=0&&o.splice(e,1)}else if(s){if(r.hasSelector(d(s))){let e=o.indexOf(t);e>=0&&o.splice(e,1)}else if(r.hasSelector(s)&&r.test(e,t)){o.indexOf(t)<0&&o.push(t)}}else if(i)if(r.hasSelector(d(i))&&r.test(e,t)){o.indexOf(t)<0&&o.push(t)}else if(r.hasSelector(i)&&r.test(e,t)){let e=o.indexOf(t);e>=0&&o.splice(e,1)}}}findAny(e,t){let s=this.findAll(e,t);return s.length<=0?null:s[Math.floor(Math.random()*s.length)]}findAll(e,t){const s=t.key;let i;return s in this.keyQueryMapping?i=this.queries[s]:(i=[],this.keyQueryMapping[s]=t,this.queries[s]=i,t.hydrate(e,i)),i}count(e,t){return this.findAll(e,t).length}clear(e){const t=e.key;t in this.keyQueryMapping&&(delete this.keyQueryMapping[t],delete this.queries[t])}reset(){this.keyQueryMapping={},this.queries={}}}function d(e){return{type:"not",name:e.name,value:e}}function m(e){return"type"in e&&"not"===e.type}function f(e,t,s,i){e[0]=s;let n=1;for(let r of i)m(r)?e[n]=null:e[n]=t.get(s,r),++n;return e}class p{dispatch(e=null){}dispatchImmediately(e=null){}flush(e=1e3){}}function y(e,t){return e.priority-t.priority}e.AnimationFrameLoop=class{constructor(e,t){const{animationFrameHandler:s=window}=t||{};this.handle=0,this.detail={prevTime:-1,currentTime:-1,deltaTime:0},this.animationFrameHandler=s,this.callback=e,this.next=this.next.bind(this),this.start=this.start.bind(this),this.cancel=this.cancel.bind(this)}next(e=performance.now()){this.handle=this.animationFrameHandler.requestAnimationFrame(this.next);let t=this.detail;t.prevTime=t.currentTime,t.currentTime=e,t.deltaTime=t.currentTime-t.prevTime,this.callback(this)}start(){return this.handle=this.animationFrameHandler.requestAnimationFrame(this.next),this}cancel(){return this.animationFrameHandler.cancelAnimationFrame(this.handle),this}},e.Camera=i,e.CommandTopic=class extends p{constructor(){super(),this.messages=[],this.queued=[]}dispatch(e){this.queued.push(e)}dispatchImmediately(e){this.messages.push(e)}flush(e=1e3){let t=this.queued.splice(0,Math.min(e,this.queued.length));this.messages.push(...t)}*poll(e=1e3){let t=0;for(;t<e&&this.messages.length>0;){let e=this.messages.shift();yield e,++t}}},e.ComponentClass=class{constructor(e,t=(()=>null),s=(()=>{})){this.name=e,this.new=t,this.delete=s}},e.EntityManager=class{constructor(){this.components={},this.nameClassMapping={},this.nextAvailableEntityId=1,this.queue=[],this.queryManager=new u}entityComponentChangedCallback(e,t,s,i){this.queryManager.onEntityComponentChanged(this,e,t,s,i)}flush(){for(;this.queue.length>0;){let[e,...t]=this.queue.shift();switch(e){case"attach":{let[e,s,i]=t;this.attachImmediately(e,s,i)}break;case"detach":{let[e,s]=t;this.detachImmediately(e,s)}break;case"clear":{let[e]=t;this.clearImmediately(e)}}}}create(){return this.nextAvailableEntityId++}destroy(e){const t=this.components;for(const s of Object.keys(t)){const i=t[s];e in i&&(delete i[e],this.entityComponentChangedCallback(e,null,this.nameClassMapping[s],!1))}this.entityComponentChangedCallback(e,null,null,!0)}exists(e,...t){if(t.length>0){for(const s of t){if(!(e in this.mapOf(s)))return!1}return!0}for(let t of Object.values(this.components))if(e in t)return!0;return!1}attach(e,t){let s=t.new();return this.queue.push(["attach",e,t,s]),s}attachImmediately(e,t,s){return void 0===s&&(s=t.new()),this.mapOf(t)[e]=s,this.entityComponentChangedCallback(e,t,null,!1),s}detach(e,t){this.queue.push(["detach",e,t])}detachImmediately(e,t){let s=this.mapOf(t),i=s[e];delete s[e],t.delete(i),this.entityComponentChangedCallback(e,null,t,!1)}clear(e){this.queue.push(["clear",e])}clearImmediately(e){const t=e.name,s=this.components,i=s[t];let n=Object.keys(i).map(Number),r=Object.values(i);s[t]={},this.nameClassMapping[t]=e;for(let t of r)e.delete(t);for(let t of n)this.entityComponentChangedCallback(t,null,e,!1)}get(e,t){return this.mapOf(t)[e]||null}count(e){return Object.keys(this.mapOf(e)).length}keysOf(e){return Object.keys(this.mapOf(e)).map(Number)}valuesOf(e){return Object.values(this.mapOf(e))}mapOf(e){const t=e.name,s=this.components;if(t in s)return s[t];{let i={};return s[t]=i,this.nameClassMapping[t]=e,i}}entityIds(){let e=new Set;for(let t of Object.values(this.components))for(let s of Object.keys(t))e.add(s);return e}componentClasses(){return Object.values(this.nameClassMapping)}reset(){const e=this.components;let t=new Set;for(const s of Object.keys(e)){const i=this.nameClassMapping[s],n=e[s];for(let e of Object.keys(n))t.add(Number(e));this.clearImmediately(i)}for(let e of t)this.entityComponentChangedCallback(e,null,null,!0);t.clear(),this.queryManager.reset(),this.components={},this.nextAvailableEntityId=1,this.queue.length=0}},e.EntityTemplate=class{constructor(...e){this.componentClasses=e}create(e){let t=e.create(),s=[t];for(let i of this.componentClasses){let n=e.attach(t,i);s.push(n)}return s}destroy(e,t){for(let s of this.componentClasses)e.detach(t,s)}},e.EventTopic=class extends p{constructor(){super(),this.listeners=[],this.queued=[]}on(e){return this.listeners.push(e),this}off(e){let t=this.listeners.indexOf(e);return t>=0&&this.listeners.splice(t,1),this}once(e){let t=s=>(this.off(t),e(s));return this.on(t),this}dispatch(e=null){this.queued.push(e)}dispatchImmediately(e=null){for(let t of this.listeners){if(!0===t(e))break}}flush(e=1e3){let t=0;for(;this.queued.length>0&&t++<e;){let e=this.queued.shift();this.dispatchImmediately(e)}}count(){return this.listeners.length}},e.FirstPersonCameraController=class{constructor(e={locky:!1}){this.locky=e.locky,this.position=t.vec3.create(),this.forward=t.vec3.fromValues(0,0,-1),this.right=t.vec3.fromValues(1,0,0),this.up=t.vec3.fromValues(0,1,0),this.forwardAmount=0,this.rightAmount=0,this.upAmount=0,this.pitch=0,this.yaw=-90}look(e,t,s=1){return s*=1e3,this.pitch=Math.min(89.9,Math.max(-89.9,this.pitch+t*s)),this.yaw=(this.yaw+e*s)%360,this}move(e,t=0,s=0,i=1){return this.forwardAmount+=e*i,this.rightAmount+=t*i,this.upAmount+=s*i,this}apply(e){let{position:s,forward:i,right:n,up:o,forwardAmount:a,rightAmount:l,upAmount:h,pitch:c,yaw:u}=this,d=u*r,m=c*r,f=Math.cos(d),p=Math.cos(m),y=Math.sin(d),g=f*p,v=Math.sin(m),b=y*p;t.vec3.normalize(i,t.vec3.set(i,g,this.locky?0:v,b)),t.vec3.normalize(n,t.vec3.cross(n,i,o));let C=t.vec3.create();t.vec3.scale(C,i,a),t.vec3.add(s,s,C),t.vec3.scale(C,n,l),t.vec3.add(s,s,C),t.vec3.scale(C,o,h),t.vec3.add(s,s,C),this.forwardAmount=0,this.rightAmount=0,this.upAmount=0,this.locky&&t.vec3.set(i,g,v,b);let k=t.vec3.add(C,s,i);return t.mat4.lookAt(e,s,k,o),e}},e.Not=d,e.OrthographicCamera=class extends i{constructor(e,s,i,n,r=-1e3,o=1e3){super(t.mat4.create(),t.mat4.create()),this.orthoBounds={left:void 0===e?void 0:Number(e),top:void 0===s?void 0:Number(s),right:void 0===i?void 0:Number(i),bottom:void 0===n?void 0:Number(n)},this.clippingPlane={near:Number(r),far:Number(o)}}resize(e,s){const{near:i,far:n}=this.clippingPlane,{left:r,top:o,right:a,bottom:l}=this.orthoBounds;let h=this.projectionMatrix,c=void 0!==r;if(void 0!==e)if(c){const c=e/s;t.mat4.ortho(h,r*c,a*c,l,o,i,n)}else t.mat4.ortho(h,0,e,s,0,i,n);else c?t.mat4.ortho(h,r,a,l,o,i,n):t.mat4.ortho(h,-1,1,1,-1,-1,1);return this}},e.PerspectiveCamera=class extends i{constructor(e=n,s=.1,i=1e3){super(t.mat4.create(),t.mat4.create()),this.fieldOfView=Number(e),this.clippingPlane={near:Number(s),far:Number(i)}}resize(e,s){const i=void 0===e?1:e/s,{near:n,far:r}=this.clippingPlane;return t.mat4.perspective(this.projectionMatrix,this.fieldOfView,i,n,r),this}},e.PriorityEventTopic=class extends p{constructor(){super(),this.listeners=[],this.queued=[]}on(e,t){return this.listeners.push({priority:e,callback:t}),this.listeners.sort(y),this}off(e){for(let t=0;t<this.listeners.length;++t)if(this.listeners.at(t).callback===e){this.listeners.splice(t,1);break}return this}once(e,t){let s=e=>(this.off(s),t(e));return this.on(e,s)}count(){return this.listeners.length}dispatch(e=null){return this.queued.push(e),this}dispatchImmediately(e=null){for(let t of this.listeners){if(!0===t.callback(e))break}return this}flush(e=1e3){let t=0;for(;this.queued.length>0&&t++<e;){let e=this.queued.shift();this.dispatchImmediately(e)}return this}},e.Query=class{constructor(...e){this.selectors=e,this.key=e.map((e=>m(e)?`!${e.name}`:e.name)).sort().join("&")}hasSelector(e){return m(e)?this.selectors.findIndex((t=>m(t)&&t.name===e.name))>=0:this.selectors.findIndex((t=>t.name===e.name))>=0}test(e,t){for(let s of this.selectors)if(m(s)){const i=s.value;if(e.exists(t,i))return!1}else{const i=s;if(!e.exists(t,i))return!1}return!0}hydrate(e,t){if(this.selectors.length<=0)return t.length=0,t;let s=e.entityIds();for(let i of s)this.test(e,i)&&t.push(i);return t}count(e){return e.queryManager.count(e,this)}findAny(e){const t=e.queryManager;let s=new Array(this.selectors.length+1),i=t.findAny(e,this);return null===i?s.fill(void 0):(f(s,e,i,this.selectors),s)}*findAll(e){const t=e.queryManager;let s=new Array(this.selectors.length+1),i=t.findAll(e,this);for(let t of i)f(s,e,t,this.selectors),yield s}},e.QueryManager=u,e.SceneGraph=class{constructor(){this.nodes={},this.roots=[],this._nextAvailableSceneNodeId=1}createSceneNode(e){let t=this._nextAvailableSceneNodeId++,s={parent:0,children:[]};return this.nodes[t]=s,a(e,t,this),t}createSceneNodes(e,t){let s=[];for(let i=0;i<e;++i)s.push(this.createSceneNode(t));return s}deleteSceneNode(e){if(!(e in this.nodes))throw new Error("Cannot delete non-existant scene node for scene graph.");l(this.nodes[e].parent,e,this),h(this,e,0,c)}deleteSceneNodes(e){for(let t of e)this.deleteSceneNode(t)}getSceneNodeInfo(e){return this.nodes[e]}parentSceneNode(e,t){l(this.nodes[e].parent,e,this),a(t,e,this)}replaceSceneNode(e,t){let s=this.nodes[e],i=s.parent,n=s.children.slice();if(l(i,e,this),s.children.length=0,t){let e=this.nodes[t];l(e.parent,t,this),e.children.push(...n),a(i,t,this)}else if(i){this.nodes[i].children.push(...n)}else this.roots.push(...n);for(let e of n)this.nodes[e].parent=i}walk(e,t={}){const{from:s,childFilter:i}=t;let n;n=s?Array.isArray(s)?s:[s]:this.roots,i&&(n=i(n,0,this));for(let t of n)h(this,t,0,e,i)}},e.Topic=p,e.isSelectorNot=m,e.lookAt=function(e,i,n,r=0,o=1){let a=t.vec3.create(),l=t.quat.create();t.mat4.getTranslation(a,e),t.mat4.getRotation(l,e);let h=t.vec3.fromValues(i,n,r);t.mat4.lookAt(e,a,h,s);let c=t.quat.create();t.mat4.getRotation(c,e),t.quat.slerp(l,l,c,o),t.mat4.fromRotationTranslation(e,l,a)},e.panTo=function(e,s,i,n=0,r=1){let o=t.vec3.create();t.mat4.getTranslation(o,e);let a=t.vec3.fromValues((s-o[0])*r,(i-o[1])*r,(n-o[2])*r);t.mat4.translate(e,e,a)},e.screenToWorldRay=function(e,s,i,n,r,o=!1){let a=t.vec4.fromValues(s,i,-1,1),l=t.mat4.create();return t.mat4.invert(l,n),t.vec4.transformMat4(a,a,l),a[2]=-1,a[3]=0,t.mat4.invert(l,r),t.vec4.transformMat4(a,a,l),e[0]=a[0],e[1]=a[1],e[2]=a[2],o&&t.vec3.normalize(e,e),e}}));
//# sourceMappingURL=milque-scene.umd.js.map
