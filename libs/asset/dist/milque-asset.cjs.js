"use strict";var e=require("picomatch"),t=require("fflate");class s{constructor(t){let r;r="object"==typeof t&&t instanceof s?t.source:String(t),this.source=r,this._re=e.makeRe(r)}test(e){return this._re.test(e)}}const r=/^([_\w\d]+)\:\/\//,i=5e3;function n(e,t,s){const{cache:r,loadings:i}=e;return r[t]=s,t in i&&(i[t].resolve(s),delete i[t]),s}async function o(e,t,s=i){const{cache:r,loadings:n}=e;if(t in r)return r[t];if(t in n)return n[t].promise;{let e=new u(s);return n[t]=e,e.promise}}function a(e,t){return e.cache[t]}class u{constructor(e){this.active=!1,this._resolve=null,this._reject=null,this._reason=null,this._value=null,this._timeoutHandle=Number.isFinite(e)&&e>0?setTimeout((()=>{this.reject(`Asset loading exceeded timeout of ${e} ms.`)}),e):null,this._promise=new Promise(((e,t)=>{this._value?e(this._value):this._resolve=e,this._reason?t(this._reason):this._reject=t}))}get promise(){return this._promise}resolve(e){this._timeoutHandle&&(clearTimeout(this._timeoutHandle),this._timeoutHandle=null),this._resolve?this._resolve(e):this._value=e}reject(e){this._timeoutHandle&&(clearTimeout(this._timeoutHandle),this._timeoutHandle=null),this._reject?this._reject(e):this._reason=e}}const l=5e3,c={cache:{},loadings:{},defaults:[]};function h(e){return a(c,e)}var f=Object.freeze({__proto__:null,cache:function(e,t){return n(c,e,t)},current:h,get:function(e){return h(e)},keys:function(){return e=c,Object.keys(e.cache);var e},loadAssetPack:async function(e,s){let r=await fetch(e),i=await r.arrayBuffer();await new Promise(((e,r)=>{t.unzip(new Uint8Array(i),((t,i)=>{if(t)r(t);else{for(let[e,t]of Object.entries(i))e=e.replaceAll("\\","/"),s(t,e);e()}}))}))},loadAssetPackAsRaw:async function(e,s){let r=await fetch(e),i=await r.arrayBuffer();await new Promise(((e,r)=>{t.unzip(new Uint8Array(i),((t,i)=>{if(t)r(t);else{for(let[e,t]of Object.entries(i)){e=e.replaceAll("\\","/");let r=e.indexOf("/");r>=0&&(e=e.substring(r+1));let i="raw://"+e;n(c,i,t),s&&s(t,i,e)}e()}}))}))},loadAssetRefs:async function(e,t=l){let s=[];for(let r of e)s.push(r.preload(c,t));await Promise.allSettled(s)}});exports.AssetManager=f,exports.AssetRef=class{constructor(e,t,s){this.uri=e,this.source=t,this.loader=s,this.store=null}get current(){return a(this.store,this.uri)}set current(e){n(this.store,this.uri,e)}get default(){return function(e,t){const{defaults:s}=e;for(let r of s)if(r.glob.test(t))return a(e,r.uri);return null}(this.store,this.uri)}get loaded(){return o(this.store,this.uri)}async preload(e,t,s){return this.store=e,void 0!==s?n(e,this.uri,s):await async function(e,t,s,a,l=i){const{cache:c,loadings:h}=e;if(t in c)return c[t];let f;if(t in h){if(f=h[t],f.active)return h[t].promise}else f=new u(l),h[t]=f;let d=[f.promise];return r.test(s)?d.push(o(e,s,l).then((e=>a(e))).then((s=>n(e,t,s)))):d.push(fetch(s).then((e=>e.arrayBuffer())).then((e=>a(e))).then((s=>n(e,t,s)))),await Promise.race(d)}(this.store,this.uri,this.source,this.loader,t),this}async unload(){return function(e,t){const{cache:s,loadings:r}=e;t in r&&(r[t].reject(new Error("Stop loading to delete asset.")),delete r[t]),t in s&&delete s[t]}(this.store,this.uri),this.store=null,this}},exports.GlobExp=s;
//# sourceMappingURL=milque-asset.cjs.js.map
