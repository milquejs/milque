{"version":3,"file":"index.js","sources":["../../src/AnimationFrameLoop.js"],"sourcesContent":["/**\n * @template {keyof AnimationFrameEventMap} K\n * @typedef {(this: AnimationFrameLoop, ev: AnimationFrameEventMap[K]) => any} AnimationFrameCallback\n */\n\n/**\n * @typedef {{\n *  \"frame\": CustomEvent<AnimationFrameDetail>,\n *  \"fixedframe\": CustomEvent<FixedFrameDetail>,\n *  \"postframe\": CustomEvent<AnimationFrameDetail>,\n * }} AnimationFrameEventMap\n */\n\n/** @typedef {{ accumulatedTime: number, skippedFrames: number }} FixedFrameDetail */\n/** @typedef {{ prevTime: number, currentTime: number, deltaTime: number }} AnimationFrameDetail */\n\nconst DEFAULT_MIN_FIXED_FRAMES = 30;\nconst DEFAULT_MAX_FIXED_FRAMES = 100;\n\nexport class AnimationFrameLoop extends EventTarget {\n\n  static now() {\n    return document.timeline.currentTime;\n  }\n\n  /** Time of last frame in milliseconds */\n  prevTime = -1;\n  /** Time of current frame in milliseconds */\n  currentTime = -1;\n  /** Time since last frame in milliseconds */\n  deltaTime = 0;\n\n  /** Time accumulated since the last fixed frame in milliseconds */\n  accumulatedTime = 0;\n  /** Number of frames skipped since last fixed frame */\n  skippedFrames = 0;\n\n  /** Number of fixed frames per second */\n  fixedFrames = {\n    min: 0,\n    max: 0,\n  };\n\n  #event = new CustomEvent('frame', {\n    detail: /** @type {AnimationFrameDetail} */ (this),\n  });\n  #fixedEvent = new CustomEvent('fixedframe', {\n    detail: /** @type {FixedFrameDetail} */ (this),\n  });\n  #postEvent = new CustomEvent('postframe', {\n    detail: /** @type {AnimationFrameDetail} */ (this),\n  });\n\n  /**\n   * @readonly\n   * @protected\n   */\n  animationFrameProvider;\n\n  /**\n   * @protected\n   * @type {ReturnType<requestAnimationFrame>}\n   */\n  handle = 0;\n\n  /**\n   * @param {object} [opts]\n   * @param {AnimationFrameProvider} [opts.animationFrameProvider]\n   * @param {number|{min: number, max: number}} [opts.fixedFrames]\n   * @param {() => DOMHighResTimeStamp} [opts.currentTimeProvider]\n   */\n  constructor(opts = {}) {\n    super();\n\n    /** @protected */\n    this.animationFrameProvider = opts?.animationFrameProvider ?? window;\n    /** @protected */\n    this.currentTimeProvider = opts?.currentTimeProvider ?? AnimationFrameLoop.now;\n\n    if (typeof opts?.fixedFrames === 'object') {\n      this.fixedFrames.max = Number(opts.fixedFrames.max);\n      this.fixedFrames.min = Number(opts.fixedFrames.min);\n    } else if (typeof opts?.fixedFrames === 'number') {\n      this.fixedFrames.max = this.fixedFrames.min = Number(opts.fixedFrames);\n    } else {\n      this.fixedFrames.max = DEFAULT_MAX_FIXED_FRAMES;\n      this.fixedFrames.min = DEFAULT_MIN_FIXED_FRAMES;\n    }\n\n    /** @protected */\n    this.next = this.next.bind(this);\n    this.start = this.start.bind(this);\n    this.cancel = this.cancel.bind(this);\n  }\n\n  get running() {\n    return this.handle !== 0;\n  }\n\n  /**\n   * @override\n   * @template {keyof AnimationFrameEventMap} K\n   * @param {K} type\n   * @param {AnimationFrameCallback<K>|EventListenerObject|null} listener\n   * @param {boolean | AddEventListenerOptions} [options]\n   */\n  addEventListener(type, listener, options) {\n    super.addEventListener(type, /** @type {any} */ (listener), options);\n  }\n\n  /**\n   * @override\n   * @template {keyof AnimationFrameEventMap} K\n   * @param {K} type\n   * @param {AnimationFrameCallback<K>|EventListenerObject|null} listener\n   * @param {boolean | AddEventListenerOptions} [options]\n   */\n  removeEventListener(type, listener, options) {\n    super.removeEventListener(type, /** @type {any} */ (listener), options);\n  }\n\n  /** @protected */\n  next(now = performance.now()) {\n    this.handle = this.animationFrameProvider.requestAnimationFrame(this.next);\n    this.prevTime = this.currentTime;\n    this.currentTime = now;\n    this.deltaTime = this.currentTime - this.prevTime;\n    this.dispatchFrame();\n    this.dispatchFixedFrames();\n\n    // Update the frame time again, since earlier callbacks might take a while...\n    now = performance.now();\n    this.currentTime = now;\n    this.deltaTime = this.currentTime - this.prevTime;\n    this.dispatchPostFrame();\n  }\n\n  /** @protected */\n  dispatchFrame() {\n    this.dispatchEvent(this.#event);\n  }\n\n  /** @protected */\n  dispatchPostFrame() {\n    this.dispatchEvent(this.#postEvent);\n  }\n\n  /** @protected */\n  dispatchFixedFrames() {\n    let i = countAvailableFixedUpdates(this, this.deltaTime, this.fixedFrames.min, this.fixedFrames.max);\n    if (i > 0) {\n      this.dispatchEvent(this.#fixedEvent);\n    }\n    // Only emit skipped-frames once.\n    this.skippedFrames = 0;\n    // ... now do the rest.\n    for (; i > 1; --i) {\n      this.dispatchEvent(this.#fixedEvent);\n    }\n  }\n\n  start() {\n    this.handle = this.animationFrameProvider.requestAnimationFrame(this.next);\n    return this;\n  }\n\n  cancel() {\n    this.animationFrameProvider.cancelAnimationFrame(this.handle);\n    return this;\n  }\n}\n\n/**\n * @param {{ accumulatedTime: number, skippedFrames: number }} out\n * @param {number} deltaTime\n * @param {number} minUpdatesPerSecond\n * @param {number} maxUpdatesPerSecond\n */\nfunction countAvailableFixedUpdates(\n  out,\n  deltaTime,\n  minUpdatesPerSecond,\n  maxUpdatesPerSecond\n) {\n  let result = out.accumulatedTime + deltaTime;\n  const millisPerUpdate = 1_000 / minUpdatesPerSecond;\n  const overTime = result - maxUpdatesPerSecond * millisPerUpdate;\n  if (overTime > 0) {\n    const skippedUpdates = Math.trunc(overTime / millisPerUpdate);\n    out.skippedFrames = skippedUpdates;\n    result -= skippedUpdates * millisPerUpdate;\n  }\n  out.accumulatedTime = result % millisPerUpdate;\n  return Math.trunc(result / millisPerUpdate);\n}\n"],"names":[],"mappings":"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"}