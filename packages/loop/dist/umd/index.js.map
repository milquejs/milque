{"version":3,"file":"index.js","sources":["../../src/AnimationFrameLoop.js"],"sourcesContent":["/**\n * @template {keyof AnimationFrameEventMap} K\n * @typedef {(this: AnimationFrameLoop, ev: AnimationFrameEventMap[K]) => any} AnimationFrameCallback\n */\n\n/**\n * @typedef {{\n *  \"frame\": CustomEvent<AnimationFrameDetail>,\n *  \"fixedframe\": CustomEvent<FixedFrameDetail>,\n *  \"postframe\": CustomEvent<AnimationFrameDetail>,\n * }} AnimationFrameEventMap\n */\n\n/** @typedef {{ accumulatedTime: number, skippedFrames: number }} FixedFrameDetail */\n/** @typedef {{ prevTime: number, currentTime: number, deltaTime: number }} AnimationFrameDetail */\n\nconst DEFAULT_MIN_FIXED_FRAMES = 30;\nconst DEFAULT_MAX_FIXED_FRAMES = 100;\n\nexport class AnimationFrameLoop extends EventTarget {\n\n  static now() {\n    return document.timeline.currentTime;\n  }\n\n  /** Time of last frame in milliseconds */\n  prevTime = -1;\n  /** Time of current frame in milliseconds */\n  currentTime = -1;\n  /** Time since last frame in milliseconds */\n  deltaTime = 0;\n\n  /** Time accumulated since the last fixed frame in milliseconds */\n  accumulatedTime = 0;\n  /** Number of frames skipped since last fixed frame */\n  skippedFrames = 0;\n\n  /** Number of fixed frames per second */\n  fixedFrames = {\n    min: 0,\n    max: 0,\n  };\n\n  #event = new CustomEvent('frame', {\n    detail: /** @type {AnimationFrameDetail} */ (this),\n  });\n  #fixedEvent = new CustomEvent('fixedframe', {\n    detail: /** @type {FixedFrameDetail} */ (this),\n  });\n  #postEvent = new CustomEvent('postframe', {\n    detail: /** @type {AnimationFrameDetail} */ (this),\n  });\n\n  /**\n   * @readonly\n   * @protected\n   */\n  animationFrameProvider;\n\n  /**\n   * @protected\n   * @type {ReturnType<requestAnimationFrame>}\n   */\n  handle = 0;\n\n  /**\n   * @param {object} [opts]\n   * @param {AnimationFrameProvider} [opts.animationFrameProvider]\n   * @param {number|{min: number, max: number}} [opts.fixedFrames]\n   * @param {() => DOMHighResTimeStamp} [opts.currentTimeProvider]\n   */\n  constructor(opts = {}) {\n    super();\n\n    /** @protected */\n    this.animationFrameProvider = opts?.animationFrameProvider ?? window;\n    /** @protected */\n    this.currentTimeProvider = opts?.currentTimeProvider ?? AnimationFrameLoop.now;\n\n    if (typeof opts?.fixedFrames === 'object') {\n      this.fixedFrames.max = Number(opts.fixedFrames.max);\n      this.fixedFrames.min = Number(opts.fixedFrames.min);\n    } else if (typeof opts?.fixedFrames === 'number') {\n      this.fixedFrames.max = this.fixedFrames.min = Number(opts.fixedFrames);\n    } else {\n      this.fixedFrames.max = DEFAULT_MAX_FIXED_FRAMES;\n      this.fixedFrames.min = DEFAULT_MIN_FIXED_FRAMES;\n    }\n\n    /** @protected */\n    this.next = this.next.bind(this);\n    this.start = this.start.bind(this);\n    this.cancel = this.cancel.bind(this);\n  }\n\n  get running() {\n    return this.handle !== 0;\n  }\n\n  /**\n   * @override\n   * @template {keyof AnimationFrameEventMap} K\n   * @param {K} type\n   * @param {AnimationFrameCallback<K>|EventListenerObject|null} listener\n   * @param {boolean | AddEventListenerOptions} [options]\n   */\n  addEventListener(type, listener, options) {\n    super.addEventListener(type, /** @type {any} */ (listener), options);\n  }\n\n  /**\n   * @override\n   * @template {keyof AnimationFrameEventMap} K\n   * @param {K} type\n   * @param {AnimationFrameCallback<K>|EventListenerObject|null} listener\n   * @param {boolean | AddEventListenerOptions} [options]\n   */\n  removeEventListener(type, listener, options) {\n    super.removeEventListener(type, /** @type {any} */ (listener), options);\n  }\n\n  /** @protected */\n  next(now = performance.now()) {\n    this.handle = this.animationFrameProvider.requestAnimationFrame(this.next);\n    this.prevTime = this.currentTime;\n    this.currentTime = now;\n    this.deltaTime = this.currentTime - this.prevTime;\n    this.dispatchFrame();\n    this.dispatchFixedFrames();\n\n    // Update the frame time again, since earlier callbacks might take a while...\n    now = performance.now();\n    this.currentTime = now;\n    this.deltaTime = this.currentTime - this.prevTime;\n    this.dispatchPostFrame();\n  }\n\n  /** @protected */\n  dispatchFrame() {\n    this.dispatchEvent(this.#event);\n  }\n\n  /** @protected */\n  dispatchPostFrame() {\n    this.dispatchEvent(this.#postEvent);\n  }\n\n  /** @protected */\n  dispatchFixedFrames() {\n    let i = countAvailableFixedUpdates(this, this.deltaTime, this.fixedFrames.min, this.fixedFrames.max);\n    if (i > 0) {\n      this.dispatchEvent(this.#fixedEvent);\n    }\n    // Only emit skipped-frames once.\n    this.skippedFrames = 0;\n    // ... now do the rest.\n    for (; i > 1; --i) {\n      this.dispatchEvent(this.#fixedEvent);\n    }\n  }\n\n  start() {\n    this.handle = this.animationFrameProvider.requestAnimationFrame(this.next);\n    return this;\n  }\n\n  cancel() {\n    this.animationFrameProvider.cancelAnimationFrame(this.handle);\n    return this;\n  }\n}\n\n/**\n * @param {{ accumulatedTime: number, skippedFrames: number }} out\n * @param {number} deltaTime\n * @param {number} minUpdatesPerSecond\n * @param {number} maxUpdatesPerSecond\n */\nfunction countAvailableFixedUpdates(\n  out,\n  deltaTime,\n  minUpdatesPerSecond,\n  maxUpdatesPerSecond\n) {\n  let result = out.accumulatedTime + deltaTime;\n  const millisPerUpdate = 1_000 / minUpdatesPerSecond;\n  const overTime = result - maxUpdatesPerSecond * millisPerUpdate;\n  if (overTime > 0) {\n    const skippedUpdates = Math.trunc(overTime / millisPerUpdate);\n    out.skippedFrames = skippedUpdates;\n    result -= skippedUpdates * millisPerUpdate;\n  }\n  out.accumulatedTime = result % millisPerUpdate;\n  return Math.trunc(result / millisPerUpdate);\n}\n"],"names":["AnimationFrameLoop","EventTarget","now","document","timeline","currentTime","prevTime","deltaTime","accumulatedTime","skippedFrames","fixedFrames","min","max","event","CustomEvent","detail","fixedEvent","postEvent","animationFrameProvider","handle","constructor","opts","super","this","window","currentTimeProvider","Number","next","bind","start","cancel","running","addEventListener","type","listener","options","removeEventListener","performance","requestAnimationFrame","dispatchFrame","dispatchFixedFrames","dispatchPostFrame","dispatchEvent","i","out","minUpdatesPerSecond","maxUpdatesPerSecond","result","millisPerUpdate","overTime","skippedUpdates","Math","trunc","countAvailableFixedUpdates","cancelAnimationFrame"],"mappings":"6OAmBO,MAAMA,UAA2BC,YAEtC,UAAOC,GACL,OAAOC,SAASC,SAASC,WAC3B,CAGAC,UAAW,EAEXD,aAAc,EAEdE,UAAY,EAGZC,gBAAkB,EAElBC,cAAgB,EAGhBC,YAAc,CACZC,IAAK,EACLC,IAAK,GAGPC,GAAS,IAAIC,YAAY,QAAS,CAChCC,OAAM,OAERC,GAAc,IAAIF,YAAY,aAAc,CAC1CC,OAAM,OAERE,GAAa,IAAIH,YAAY,YAAa,CACxCC,OAAM,OAORG,uBAMAC,OAAS,EAQT,WAAAC,CAAYC,EAAO,IACjBC,QAGAC,KAAKL,uBAAyBG,GAAMH,wBAA0BM,OAE9DD,KAAKE,oBAAsBJ,GAAMI,qBAAuBzB,EAAmBE,IAE1C,iBAAtBmB,GAAMX,aACfa,KAAKb,YAAYE,IAAMc,OAAOL,EAAKX,YAAYE,KAC/CW,KAAKb,YAAYC,IAAMe,OAAOL,EAAKX,YAAYC,MACT,iBAAtBU,GAAMX,YACtBa,KAAKb,YAAYE,IAAMW,KAAKb,YAAYC,IAAMe,OAAOL,EAAKX,cAE1Da,KAAKb,YAAYE,IApEU,IAqE3BW,KAAKb,YAAYC,IAtEU,IA0E7BY,KAAKI,KAAOJ,KAAKI,KAAKC,KAAKL,MAC3BA,KAAKM,MAAQN,KAAKM,MAAMD,KAAKL,MAC7BA,KAAKO,OAASP,KAAKO,OAAOF,KAAKL,KACjC,CAEA,WAAIQ,GACF,OAAuB,IAAhBR,KAAKJ,MACd,CASA,gBAAAa,CAAiBC,EAAMC,EAAUC,GAC/Bb,MAAMU,iBAAiBC,EAAI,EAAiCE,EAC9D,CASA,mBAAAC,CAAoBH,EAAMC,EAAUC,GAClCb,MAAMc,oBAAoBH,EAAI,EAAiCE,EACjE,CAGA,IAAAR,CAAKzB,EAAMmC,YAAYnC,OACrBqB,KAAKJ,OAASI,KAAKL,uBAAuBoB,sBAAsBf,KAAKI,MACrEJ,KAAKjB,SAAWiB,KAAKlB,YACrBkB,KAAKlB,YAAcH,EACnBqB,KAAKhB,UAAYgB,KAAKlB,YAAckB,KAAKjB,SACzCiB,KAAKgB,gBACLhB,KAAKiB,sBAGLtC,EAAMmC,YAAYnC,MAClBqB,KAAKlB,YAAcH,EACnBqB,KAAKhB,UAAYgB,KAAKlB,YAAckB,KAAKjB,SACzCiB,KAAKkB,mBACP,CAGA,aAAAF,GACEhB,KAAKmB,cAAcnB,MAAKV,EAC1B,CAGA,iBAAA4B,GACElB,KAAKmB,cAAcnB,MAAKN,EAC1B,CAGA,mBAAAuB,GACE,IAAIG,EA6BR,SACEC,EACArC,EACAsC,EACAC,GAEA,IAAIC,EAASH,EAAIpC,gBAAkBD,EACnC,MAAMyC,EAAkB,IAAQH,EAC1BI,EAAWF,EAASD,EAAsBE,EAChD,GAAIC,EAAW,EAAG,CAChB,MAAMC,EAAiBC,KAAKC,MAAMH,EAAWD,GAC7CJ,EAAInC,cAAgByC,EACpBH,GAAUG,EAAiBF,CAC7B,CAEA,OADAJ,EAAIpC,gBAAkBuC,EAASC,EACxBG,KAAKC,MAAML,EAASC,EAC7B,CA7CYK,CAA2B9B,KAAMA,KAAKhB,UAAWgB,KAAKb,YAAYC,IAAKY,KAAKb,YAAYE,KAOhG,IANI+B,EAAI,GACNpB,KAAKmB,cAAcnB,MAAKP,GAG1BO,KAAKd,cAAgB,EAEdkC,EAAI,IAAKA,EACdpB,KAAKmB,cAAcnB,MAAKP,EAE5B,CAEA,KAAAa,GAEE,OADAN,KAAKJ,OAASI,KAAKL,uBAAuBoB,sBAAsBf,KAAKI,MAC9DJ,IACT,CAEA,MAAAO,GAEE,OADAP,KAAKL,uBAAuBoC,qBAAqB/B,KAAKJ,QAC/CI,IACT"}