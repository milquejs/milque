"use strict";var e=require("picomatch"),t=require("fflate");class r{constructor(t){let s;s="object"==typeof t&&t instanceof r?t.source:String(t),this.source=s,this._re=e.makeRe(s)}test(e){return this._re.test(e)}}const s=/^([_\w\d]+)\:\/\//;async function n(e,t,r,n,a,u){const{loadings:l}=e;let c;t in l?c=l[t]:(c=new f(u),l[t]=c);const h=f.nextAttempt(c);let p=[c.promise];return s.test(r)?p.push(o(e,r,u).then((e=>n(e,a))).then((r=>f.isCurrentAttempt(c,h)?i(e,t,r):void 0))):p.push(n(r).then((r=>f.isCurrentAttempt(c,h)?i(e,t,r):void 0))),await Promise.race(p)}function i(e,t,r){const{store:s,loadings:n}=e;return s[t]=r,t in n&&(n[t].resolve(r),delete n[t]),r}async function o(e,t,r){const{store:s,loadings:n}=e;if(t in s)return s[t];if(t in n)return n[t].promise;{let e=new f(r);return n[t]=e,e.promise}}function a(e,t){return e.store[t]}function u(e,t){return t in e.store}function l(e,t){return t in e.loadings}class c{constructor(e,t){this.glob=e,this.uri=t}}class f{static nextAttempt(e){return++e._promiseHandle}static isCurrentAttempt(e,t){return e._promiseHandle===t}constructor(e){this._promiseHandle=0,this._resolve=null,this._reject=null,this._reason=null,this._value=null,this._timeoutHandle=Number.isFinite(e)&&e>0?setTimeout((()=>{this.reject(`Asset loading exceeded timeout of ${e} ms.`)}),e):null,this._promise=new Promise(((e,t)=>{this._value?e(this._value):this._resolve=e,this._reason?t(this._reason):this._reject=t}))}get promise(){return this._promise}resolve(e){this._timeoutHandle&&(clearTimeout(this._timeoutHandle),this._timeoutHandle=null),this._resolve?this._resolve(e):this._value=e}reject(e){this._timeoutHandle&&(clearTimeout(this._timeoutHandle),this._timeoutHandle=null),this._reject?this._reject(e):this._reason=e}}class h{constructor(e,t,r,s=e,n=null){this.uri=e,this.loader=t,this.opts=r,this.initial=n,this.filepath=s,this.source=null,this.current=null}cache(e,t){return e.cache(this.uri,t),this.source=e,this.current=t,this}get(e){let t;return t=e.exists(this.uri)?e.current(this.uri):this.initial&&this.initial instanceof h?this.initial.get(e):this.initial,this.source=e,this.current=t,t}async load(e,t=5e3){let r;if(e.exists(this.uri))r=e.current(this.uri);else if(r=await e.load(this.uri,this.filepath,this.loader,this.opts,t),!r)if(this.initial&&this.initial instanceof h){let s=this.initial;r=await e.load(s.uri,s.filepath,s.loader,s.opts,t)}else r=this.initial;return this.source=e,this.current=r,r}async reload(e,t=5e3){let r=await e.reload(this.uri,this.filepath,this.loader,this.opts,t);return this.source=e,this.current=r,r}}const p=/(.+?)\s+(.*)/,d=/(.+)=(.+)/;function m(e,t){let r=t.split(/\s+/);for(let t of r){let r=d.exec(t);if(!r)continue;let[s,n,i]=r,o=JSON.parse(`[${i}]`);1===o.length?e[n]=o[0]:e[n]=o}}exports.AssetManager=class{constructor(e=null){this.parent=e,this.store={},this.loadings={},this.defaults=[]}get(e){const t=this;if(u(t,e))return a(t,e);let r=function(e,t){const{defaults:r}=e;for(let s of r)if(s.glob.test(t))return a(e,s.uri);return null}(t,e);if(r)return r;throw new Error(`Asset '${e}' not found.`)}async resolve(e,t,r,s,n){return this.get(e)||await this.load(e,t,r,s,n)}fallback(e,t){return function(e,t,s){const{defaults:n}=e;"string"==typeof t&&(t=new r(t));const o=`__default://[${n.length}]`;return i(e,o,s),n.push(new c(t,o)),s}(this,e,t)}cache(e,t){return i(this,e,t)}async load(e,t,r,s,i){const c=this;return u(c,e)?a(c,e):l(c,e)?await o(c,e,i):await n(c,e,t,r,s,i)}async reload(e,t,r,s,i){return await n(this,e,t,r,s,i)}unload(e){!function(e,t){const{store:r,loadings:s}=e;t in s&&(s[t].reject(new Error("Stop loading to delete asset.")),delete s[t]),t in r&&delete r[t]}(this,e)}clear(e){!function(e,t){"string"==typeof t&&(t=new r(t));const{store:s,loadings:n}=e;for(let[e,r]of Object.entries(n))t.test(e)&&(r.reject(new Error(`Stop loading to clear assets matching ${t}`)),delete n[e]);for(let e of Object.keys(s))t.test(e)&&delete s[e]}(this,e)}current(e){return a(this,e)}exists(e){return function(e,t){return Boolean(e.store[t])}(this,e)}loading(e){const t=this;return l(t,e)?function(e,t){const{loadings:r}=e;return t in r?r[t].promise:null}(t,e):null}keys(){return function(e){return Object.keys(e.store)}(this)}reset(){!function(e){const{store:t,loadings:r,defaults:s}=e;for(let[e,t]of Object.entries(r))t.reject(new Error("Stop loading to clear all assets.")),delete r[e];for(let e of Object.keys(t))delete t[e];s.length=0}(this)}},exports.AssetRef=h,exports.AtlasLoader=async function e(t,r={onprogress:void 0}){if("string"==typeof t){const s=await fetch(t);return e(await s.arrayBuffer(),r)}if(!(t instanceof ArrayBuffer||ArrayBuffer.isView(t)))throw new Error(`Cannot load from source - must be an ArrayBuffer or fetchable url, but got instead: ${t}`);const s=t;let n={},i=(new TextDecoder).decode(s).split("\n"),o=i.length,a=0;r.onprogress&&r.onprogress(0,0,o);for(let e of i){if(++a,e=e.trim(),e.length<=0)continue;if(e.startsWith("#"))continue;if(e.startsWith("//"))continue;let t=[],s=0,i=e.indexOf(" ");for(;i>=0;)t.push(e.substring(s,i)),s=i+1,i=e.indexOf(" ",s);t.push(e.substring(s));let u=t[0],l=Number.parseInt(t[1]),c=Number.parseInt(t[2]),f=Number.parseInt(t[3]),h=Number.parseInt(t[4]),p=t.length>=6?Number.parseInt(t[5]):1,d=t.length>=7?Number.parseInt(t[6]):p,m=t.length>=8?Number.parseInt(t[7]):p>d?Math.ceil(p/d):1;n[u]={u:l,v:c,w:f,h:h,frames:p,cols:d,rows:m,name:u},r.onprogress&&r.onprogress(a/o,a,o)}return r.onprogress&&r.onprogress(1,a,a),n},exports.AudioBufferLoader=async function e(t,r){const{audioContext:s}=r||{};if("string"==typeof t){const r=await fetch(t);return e(await r.arrayBuffer(),{audioContext:s})}if(!(t instanceof ArrayBuffer||ArrayBuffer.isView(t)))throw new Error(`Cannot load from source - must be an ArrayBuffer or fetchable url, but got instead: ${t}`);const n=t;let i=new ArrayBuffer(n.byteLength);return new Uint8Array(i).set(n),await s.decodeAudioData(i)},exports.BMFontLoader=async function e(t){if("string"==typeof t){const r=await fetch(t);return e(await r.arrayBuffer())}if(!(t instanceof ArrayBuffer||ArrayBuffer.isView(t)))throw new Error(`Cannot load from source - must be an ArrayBuffer or fetchable url, but got instead: ${t}`);const r=t;return function(e){let t=e.split("\n"),r={},s={},n={},i=[],o=[];for(let e of t){let t=p.exec(e);if(!t)continue;let[a,u,l]=t;switch(u){case"info":m(r,l);break;case"common":m(s,l);break;case"page":m(n,l);break;case"chars":break;case"char":let e={};m(e,l),"id"in e&&i.push(e);break;case"kerning":let t={};m(t,l),"first"in t&&o.push(t)}}return{info:r,common:s,page:n,chars:i,kernings:o}}((new TextDecoder).decode(r))},exports.GlobExp=r,exports.ImageLoader=async function e(t,r){let{imageType:s}=r||{};if("string"==typeof t){const n=await fetch(t),i=await n.arrayBuffer();if(void 0===s){let e=t.lastIndexOf(".");if(e<0)throw new Error("Cannot load from url - unknown image type.");s="image/"+t.slice(e+1)}return e(i,{...r,imageType:s})}if(!(t instanceof ArrayBuffer||ArrayBuffer.isView(t)))throw new Error(`Cannot load from source - must be an ArrayBuffer or fetchable url, but got instead: ${t}`);void 0===s&&(s="image/png");let n=new Blob([t],{type:s}),i=URL.createObjectURL(n),o=new Image;return new Promise(((e,t)=>{o.addEventListener("load",(()=>{e(o)})),o.addEventListener("error",(e=>{t(e)})),o.src=i}))},exports.JSONLoader=async function e(t){if("string"==typeof t){const r=await fetch(t);return e(await r.arrayBuffer())}if(!(t instanceof ArrayBuffer||ArrayBuffer.isView(t)))throw new Error(`Cannot load from source - must be an ArrayBuffer or fetchable url, but got instead: ${t}`);const r=t;return JSON.parse((new TextDecoder).decode(r))},exports.OBJLoader=async function e(t){if("string"==typeof t){const r=await fetch(t);return e(await r.arrayBuffer())}if(!(t instanceof ArrayBuffer||ArrayBuffer.isView(t)))throw new Error(`Cannot load from source - must be an ArrayBuffer or fetchable url, but got instead: ${t}`);const r=t;return function(e){const t=[],r=[],s=[],n=[],i=[],o=[],a=/^#.*/g,u=/v\s+(\S+)\s+(\S+)\s+(\S+)/g,l=/vn\s+(\S+)\s+(\S+)\s+(\S+)/g,c=/vt\s+(\S+)\s+(\S+)/g,f=/f\s+(([^/\s]*)\/([^/\s]*)\/?([^/\s]*))\s+(([^/\s]*)\/([^/\s]*)\/?([^/\s]*))\s+(([^/\s]*)\/([^/\s]*)\/?([^/\s]*))(\s+(([^/\s]*)\/([^/\s]*)\/?([^/\s]*)))?/g,h=/f\s+([^/\s]+)\s+([^/\s]+)\s+([^/\s]+)/g;let p,d,m,b,w,g,y=!1,N=null;e=e.replace(a,"");for(;null!=(N=u.exec(e));)p=Number.parseFloat(N[1]),d=Number.parseFloat(N[2]),m=Number.parseFloat(N[3]),t.push(p),t.push(d),t.push(m);for(;null!=(N=l.exec(e));)p=Number.parseFloat(N[1]),d=Number.parseFloat(N[2]),m=Number.parseFloat(N[3]),s.push(p),s.push(d),s.push(m);for(;null!=(N=c.exec(e));)p=Number.parseFloat(N[1]),d=Number.parseFloat(N[2]),r.push(p),r.push(d);for(;null!=(N=f.exec(e));)p=Number.parseInt(N[2]),Number.isNaN(p)&&(p=1),d=Number.parseInt(N[6]),Number.isNaN(d)&&(d=1),m=Number.parseInt(N[10]),Number.isNaN(m)&&(m=1),n.push(p),n.push(d),n.push(m),p=Number.parseInt(N[4]),Number.isNaN(p)?(p=Number.parseInt(N[3]),d=Number.parseInt(N[7]),m=Number.parseInt(N[11]),o.push(p),o.push(d),o.push(m),i.push(1),i.push(1),i.push(1)):(d=Number.parseInt(N[8]),Number.isNaN(d)&&(d=1),m=Number.parseInt(N[12]),Number.isNaN(m)&&(m=1),o.push(p),o.push(d),o.push(m),p=Number.parseInt(N[3]),Number.isNaN(p)&&(p=1),d=Number.parseInt(N[7]),Number.isNaN(d)&&(d=1),m=Number.parseInt(N[11]),Number.isNaN(m)&&(m=1),i.push(p),i.push(d),i.push(m)),void 0!==N[13]&&(b=Number.parseInt(N[15]),Number.isNaN(b)&&(b=1),n.push(b),b=Number.parseInt(N[17]),Number.isNaN(b)?(b=Number.parseInt(N[16]),o.push(b),i.push(1)):(o.push(b),b=Number.parseInt(N[16]),i.push(b)),y=!0);for(;null!=(N=h.exec(e));)p=Number.parseInt(N[2]),d=Number.parseInt(N[6]),m=Number.parseInt(N[10]),n.push(p),n.push(d),n.push(m),i.push(1),i.push(1),i.push(1),o.push(1),o.push(1),o.push(1),void 0!==N[13]&&(b=Number.parseInt(N[14]),n.push(b),i.push(1),o.push(1),y=!0);g=n.length;const A=new Float32Array(3*g);for(let e=0;e<g;++e)w=n[e]-1,A[3*e+0]=t[3*w+0],A[3*e+1]=t[3*w+1],A[3*e+2]=t[3*w+2];g=i.length;const x=new Float32Array(2*g);for(let e=0;e<g;++e)w=i[e]-1,x[2*e+0]=r[2*w+0],x[2*e+1]=r[2*w+1];g=o.length;const B=new Float32Array(3*g);for(let e=0;e<g;++e)w=o[e]-1,B[3*e+0]=s[3*w+0],B[3*e+1]=s[3*w+1],B[3*e+2]=s[3*w+2];g=n.length;const _=new Uint16Array(g);for(let e=0;e<g;++e)_[e]=e;y&&console.warn("WebGL does not support quad faces, only triangles.");return{positions:A,texcoords:x,normals:B,indices:_}}((new TextDecoder).decode(r))},exports.TextLoader=async function e(t){if("string"==typeof t){const r=await fetch(t);return e(await r.arrayBuffer())}if(!(t instanceof ArrayBuffer||ArrayBuffer.isView(t)))throw new Error("Cannot load from source - must be an array buffer or fetchable url");const r=t;return(new TextDecoder).decode(r)},exports.cacheAssetPackAsRaw=async function(e,r,s){const n=e;let o=await fetch(r),a=await o.arrayBuffer();await new Promise(((e,r)=>{t.unzip(new Uint8Array(a),((t,o)=>{if(t)r(t);else{for(let[e,t]of Object.entries(o)){e=e.replaceAll("\\","/");let r=e.indexOf("/");r>=0&&(e=e.substring(r+1));let o="raw://"+e;i(n,o,t),s&&s(t,o,e)}e()}}))}))},exports.loadAssetPack=async function(e,r){let s=await fetch(e),n=await s.arrayBuffer();await new Promise(((e,s)=>{t.unzip(new Uint8Array(n),((t,n)=>{if(t)s(t);else{for(let[e,t]of Object.entries(n))e=e.replaceAll("\\","/"),r(t,e);e()}}))}))},exports.preloadAssetRefs=async function(e,t,r=5e3){let s=[];for(let n of t)s.push(n.load(e,r));await Promise.allSettled(s)};
//# sourceMappingURL=milque-asset.cjs.js.map
