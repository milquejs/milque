!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Milque={})}(this,function(t){"use strict";function e(t){return"new"in t?t.new():new t}function n(t,e){"delete"in t&&"function"==typeof t.delete&&t.delete(e)}var s=Object.freeze({__proto__:null,create:function(t,e,n){return{name:t,new:e,delete:n}},deleteComponentInstance:n,isSameComponentClass:function(t,e){return t&&e&&"name"in t&&"name"in e&&t.name===e.name},newComponentInstance:e});const i=4294967295;class o{constructor(t,e=16,n=1e4){if(this.componentClass=t,n<=0)throw new Error(`Max capacity must be positive, but was "${n}".`);if(e>n)throw new Error(`Cannot initialize capacity over max "${n}".`);const s=r(n),o=new ArrayBuffer(e,{maxByteLength:s.BYTES_PER_ELEMENT*i});this.sparse=new s(o);const a=r(i),c=new ArrayBuffer(e,{maxByteLength:a.BYTES_PER_ELEMENT*n});this.entityIds=new a(c),this.entityIdArrayType=a,this.instances=new Array,this.size=0,this.maxCapacity=n}get capacity(){return Math.trunc(this.entityIds.buffer.byteLength/this.entityIdArrayType.BYTES_PER_ELEMENT)}ensureCapacity(t,e){if(e>=this.sparse.length){const t=Math.pow(2,Math.ceil(Math.log2(e+1))),n=this.sparse.byteLength,s=Math.min(this.sparse.buffer.maxByteLength,Math.max(this.sparse.BYTES_PER_ELEMENT,Math.max(2*n,t)));this.sparse.buffer.resize(s)}const n=Math.max(this.size,t+1);if(n>this.maxCapacity)throw new Error(`Exceeded max capacity - cannot insert more objects than "${this.maxCapacity}".`);if(n>this.instances.length&&(this.size=n,this.instances.length=n),n>=this.entityIds.length){const t=Math.pow(2,Math.ceil(Math.log2(n))),e=this.entityIds.byteLength,s=Math.min(this.entityIds.buffer.maxByteLength,Math.max(this.entityIds.BYTES_PER_ELEMENT,Math.max(2*e,t)));this.entityIds.buffer.resize(s)}}insert(t,n=void 0){void 0===n&&(n=e(this.componentClass));const s=this.sparse[t];if(s>=0&&this.entityIds[s]===t)return this.instances[s]=n,n;const i=this.size;return this.ensureCapacity(i,t),this.sparse[t]=i,this.instances[i]=n,this.entityIds[i]=t,n}delete(t){if(this.size<=0)return!1;const e=this.sparse[t];if(!(e>=0&&this.entityIds[e]===t))return!1;let s=this.instances[e];if(this.sparse[t]=0,n(this.componentClass,s),this.size>1){const t=this.size-1,n=this.instances[t],s=this.entityIds[t];this.sparse[s]=e,this.instances[e]=n,this.entityIds[e]=s}return this.size-=1,this.instances.length=this.size,!0}clear(){let t=Array.from(this.entityIds);for(let e of t)this.delete(e)}lookup(t){return this.instances[this.sparse[t]]}keyOf(t){return this.entityIds[this.instances.indexOf(t)]}has(t){return this.entityIds[this.sparse[t]]===t}keys(){return this.createEntityIdBufferView()}values(){return this.instances}createEntityIdBufferView(){return new(0,this.entityIdArrayType)(this.entityIds.buffer,0,this.size)}}function r(t){if(t<=256)return Uint8Array;if(t<=65536)return Uint16Array;if(t<=4294967296)return Uint32Array;throw new Error(`Max value is too big - no typed uint array big enough for value "${t}".`)}function a(t){let e=t.unclaimedEntityIds.pop();return void 0===e&&(e=t.nextAvailableEntityId,t.nextAvailableEntityId+=1),e}function c(t,e,n){if(t.deadEntityIds.includes(e))throw new Error("Cannot attach components to a dead entity.");if(!(n.name in t.components)){let e=new o(n);t.components[n.name]=e}return t.components[n.name].insert(e)}var h=Object.freeze({__proto__:null,attachComponent:c,createPool:function(){return{components:{},nextAvailableEntityId:1,unclaimedEntityIds:[],deadEntityIds:[]}},deleteEntity:function(t,e){t.deadEntityIds.push(e);for(let n of Object.values(t.components))n.delete(e);t.deadEntityIds.splice(t.deadEntityIds.indexOf(e),1),t.unclaimedEntityIds.push(e)},detachComponent:function(t,e,n){if(!(n.name in t.components))throw new Error(`Cannot detach component - no mapping exists for component class "${n.name}".`);return t.components[n.name].delete(e)},lookupComponent:function(t,e,n){let s=t.components[n.name];return s?.has(e)?s.lookup(e):null},lookupEntity:function(t,e,n){return t.components[e.name].keyOf(n)},newEntity:a,resetPool:function(t){for(let e of Object.values(t.components))e.clear();t.nextAvailableEntityId=1,t.unclaimedEntityIds.length=0,t.deadEntityIds.length=0},values:function(t,e){return t.components[e.name]?.values()??[]}});function u(t){return Math.trunc(Number(t??0))}function l(t){const e=[],n=[],s=[];for(let[n,s]of Object.entries(t))e.push(s);if(1===e.length&&e[0].name===u.name)throw new Error("Cannot match only for EntityId, must include at least 1 other component class!");const i=function(t,e,n){return[...t.map(t=>`&${t.name}`),...e.map(t=>`|${t.name}`),...n.map(t=>`~${t.name}`)].sort().join("")}(e,n,s);return{matchId:i,template:t,all:e,any:n,none:s,maybe:[]}}u.NONE=u(0);var f=Object.freeze({__proto__:null,createMatch:l});function m(t,e,n=void 0){const s=e.template,i=Object.entries(s),o=Object.values(s);if(o.length<=0)return null;const r=p(t,o);if(!r)return null;void 0===n&&(n=t.components[r.name]?.keys()[0]);let a={};for(let[e,s]of i){const i=s.name;if(i===u.name){a[e]=n;continue}const o=t.components[i];if(!o.has(n))return null;a[e]=o.lookup(n)}return a}function*y(t,e){const n=e.template,s=Object.entries(n),i=Object.values(n);if(i.length<=0)return;const o=p(t,i);if(o)for(let e of t.components[o.name]?.keys()){let n={};for(let[i,o]of s){const s=o.name;if(s===u.name){n[i]=e;continue}const r=t.components[s];r.has(e)&&(n[i]=r.lookup(e))}yield d(n)}}function p(t,e){let n=null,s=Number.POSITIVE_INFINITY;for(let i of e){const e=i.name;if(e===u.name)continue;let o=t.components[e];if(!o)return null;let r=o.size;r<s&&(n=i,s=r)}if(!n)throw new Error("Cannot find any non-EntityId component class to match for query.");return n}function d(t){return t}class E{static from(t){return new E(t)}constructor(t){this.components=t,this.match=l(t)}newEntity(t){let e=a(t),n={};for(let[s,i]of Object.entries(this.components)){i.name!==u.name?n[s]=c(t,e,i):n[s]=e}return n}query(t,e=void 0){return m(t,this.match,e)}queryAll(t){return y(t,this.match)}asMatch(){return this.match}}t.Archetype=E,t.ComponentFactory=s,t.EntityId=u,t.LocalEntityPool=h,t.MatchFactory=f,t.queryMatch=m,t.queryMatchAll=y});
//# sourceMappingURL=index.js.map
