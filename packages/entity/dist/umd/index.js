!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Milque={})}(this,(function(t){"use strict";function e(t){return"new"in t?t.new():new t}function n(t,e){"delete"in t&&"function"==typeof t.delete&&t.delete(e)}var s=Object.freeze({__proto__:null,create:function(t,e,n){return{name:t,new:e,delete:n}},deleteComponentInstance:n,isSameComponentClass:function(t,e){return t&&e&&"name"in t&&"name"in e&&t.name===e.name},newComponentInstance:e});const i=4294967295;class o{constructor(t,e=16,n=1e4){if(this.componentClass=t,n<=0)throw new Error(`Max capacity must be positive, but was "${n}".`);if(e>n)throw new Error(`Cannot initialize capacity over max "${n}".`);const s=r(n),o=new ArrayBuffer(e,{maxByteLength:s.BYTES_PER_ELEMENT*i});this.sparse=new s(o);const a=r(i),c=new ArrayBuffer(e,{maxByteLength:a.BYTES_PER_ELEMENT*n});this.entityIds=new a(c),this.entityIdArrayType=a,this.instances=new Array,this.size=0,this.maxCapacity=n}get capacity(){return Math.trunc(this.entityIds.buffer.byteLength/this.entityIdArrayType.BYTES_PER_ELEMENT)}ensureCapacity(t,e){if(e>=this.sparse.length){const t=Math.pow(2,Math.ceil(Math.log2(e+1))),n=this.sparse.byteLength,s=Math.min(this.sparse.buffer.maxByteLength,Math.max(this.sparse.BYTES_PER_ELEMENT,Math.max(2*n,t)));this.sparse.buffer.resize(s)}const n=Math.max(this.size,t+1);if(n>this.maxCapacity)throw new Error(`Exceeded max capacity - cannot insert more objects than "${this.maxCapacity}".`);if(n>this.instances.length&&(this.size=n,this.instances.length=n),n>=this.entityIds.length){const t=Math.pow(2,Math.ceil(Math.log2(n))),e=this.entityIds.byteLength,s=Math.min(this.entityIds.buffer.maxByteLength,Math.max(this.entityIds.BYTES_PER_ELEMENT,Math.max(2*e,t)));this.entityIds.buffer.resize(s)}}insert(t,n=void 0){void 0===n&&(n=e(this.componentClass));const s=this.sparse[t];if(s>=0&&this.entityIds[s]===t)return this.instances[s]=n,n;const i=this.size;return this.ensureCapacity(i,t),this.sparse[t]=i,this.instances[i]=n,this.entityIds[i]=t,n}delete(t){if(this.size<=0)return!1;const e=this.sparse[t];if(!(e>=0&&this.entityIds[e]===t))return!1;let s=this.instances[e];if(this.sparse[t]=0,n(this.componentClass,s),this.size>1){const t=this.size-1,n=this.instances[t],s=this.entityIds[t];this.sparse[s]=e,this.instances[e]=n,this.entityIds[e]=s}return this.size-=1,this.instances.length=this.size,!0}clear(){let t=Array.from(this.entityIds);for(let e of t)this.delete(e)}lookup(t){return this.instances[this.sparse[t]]}keyOf(t){return this.entityIds[this.instances.indexOf(t)]}has(t){return this.entityIds[this.sparse[t]]===t}keys(){return this.createEntityIdBufferView()}values(){return this.instances}createEntityIdBufferView(){return new(0,this.entityIdArrayType)(this.entityIds.buffer,0,this.size)}}function r(t){if(t<=256)return Uint8Array;if(t<=65536)return Uint16Array;if(t<=4294967296)return Uint32Array;throw new Error(`Max value is too big - no typed uint array big enough for value "${t}".`)}function a(t){return Math.trunc(Number(t??0))}a.NONE=a(0);class c{static SomeOf(...t){return new c("SomeOf",t,null)}static NoneOf(...t){return new c("NoneOf",t,null)}name;keys;output;constructor(t,e,n){this.name=t,this.keys=e,this.output=n}}function u(t,e,n=void 0){const s=Object.keys(e);if(s.length<=0)return null;const i=Object.entries(e),o=Object.values(e);if(void 0===n){const e=h(t,o);if(!e)return null;n=t.components[e.name]?.keys()[0]}let r={};for(let t of s)r[t]=null;t:for(let[e,s]of i){const i=s.name;switch(i){case a.name:r[e]=n;continue t;case c.NoneOf.name:for(let e of s.keys){const s=e.name;if(t.components[s].has(n))return null}break;case c.SomeOf.name:for(let i of s.keys){const s=i.name,o=t.components[s];if(o.has(n)){r[e]=o.lookup(n);continue t}}r[e]=null;break;default:const o=t.components[i];if(!o.has(n))return null;r[e]=o.lookup(n)}}return r}function*l(t,e){const n=Object.keys(e);if(n.length<=0)return;const s=Object.entries(e),i=h(t,Object.values(e));if(!i)return;let o={};for(let t of n)o[t]=null;t:for(let e of t.components[i.name]?.keys()){e:for(let[n,i]of s){const s=i.name;switch(s){case a.name:o[n]=e;continue e;case c.NoneOf.name:for(let n of i.keys){const s=n.name;if(t.components[s].has(e))continue t}break;case c.SomeOf.name:for(let s of i.keys){const i=s.name,r=t.components[i];if(r.has(e)){o[n]=r.lookup(e);continue e}}o[n]=null;break;default:const r=t.components[s];if(!r.has(e))continue t;o[n]=r.lookup(e)}}yield o}}function h(t,e){let n=null,s=Number.POSITIVE_INFINITY;for(let i of e){const e=i.name;if(e===a.name)continue;let o=t.components[e];if(!o)return null;let r=o.size;r<s&&(n=i,s=r)}if(!n)throw new Error("Cannot find any non-EntityId component class to match for query.");return n}function f(t){for(let e of Object.values(t.components))e.clear();t.nextAvailableEntityId=1,t.unclaimedEntityIds.length=0,t.deadEntityIds.length=0}function m(t){let e=t.unclaimedEntityIds.pop();return void 0===e&&(e=t.nextAvailableEntityId,t.nextAvailableEntityId+=1),e}function y(t,e){t.deadEntityIds.push(e);for(let n of Object.values(t.components))n.delete(e);t.deadEntityIds.splice(t.deadEntityIds.indexOf(e),1),t.unclaimedEntityIds.push(e)}function d(t,e,n){if(t.deadEntityIds.includes(e))throw new Error("Cannot attach components to a dead entity.");if(!(n.name in t.components)){let e=new o(n);t.components[n.name]=e}return t.components[n.name].insert(e)}function p(t,e,n){if(!(n.name in t.components))throw new Error(`Cannot detach component - no mapping exists for component class "${n.name}".`);return t.components[n.name].delete(e)}function E(t,e,n){let s=t.components[n.name];return s?.has(e)?s.lookup(e):null}function I(t,e,n){return t.components[e.name].keyOf(n)}function b(t,e){return t.components[e.name]?.keys()??[]}function w(t,e){return t.components[e.name]?.values()??[]}function k(t,e){return t.components[e.name]?.values().length??0}var x=Object.freeze({__proto__:null,attachComponent:d,countComponents:k,createPool:function(){return{components:{},nextAvailableEntityId:1,unclaimedEntityIds:[],deadEntityIds:[]}},deleteEntity:y,detachComponent:p,find:u,findAll:l,instancesOf:w,keysOf:b,lookupComponent:E,lookupEntity:I,newEntity:m,resetPool:f});t.ComponentFactory=s,t.EntityId=a,t.EntityManager=class{components={};nextAvailableEntityId=1;unclaimedEntityIds=[];deadEntityIds=[];newEntity(){return m(this)}deleteEntity(t){y(this,t)}attachComponent(t,e){return d(this,t,e)}detachComponent(t,e){return p(this,t,e)}lookupComponent(t,e){return E(this,t,e)}lookupEntity(t,e){return I(this,t,e)}countComponents(t){return k(this,t)}keysOf(t){return b(this,t)}instancesOf(t){return w(this,t)}find(t,e){return u(this,t,e)}*findAll(t){yield*l(this,t)}resetPool(){f(this)}},t.LocalEntityPool=x,t.MatchFilter=c}));
//# sourceMappingURL=index.js.map
