!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(((t="undefined"!=typeof globalThis?globalThis:t||self).milque=t.milque||{},t.milque.scene={}))}(this,(function(t){"use strict";var e=1e-6,n="undefined"!=typeof Float32Array?Float32Array:Array;function r(){var t=new n(16);return n!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function o(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function i(t,e){var n=e[0],r=e[1],o=e[2],i=e[3],s=e[4],h=e[5],a=e[6],u=e[7],c=e[8],l=e[9],f=e[10],d=e[11],p=e[12],m=e[13],A=e[14],v=e[15],M=n*h-r*s,y=n*a-o*s,w=n*u-i*s,g=r*a-o*h,N=r*u-i*h,b=o*u-i*a,x=c*m-l*p,S=c*A-f*p,P=c*v-d*p,k=l*A-f*m,q=l*v-d*m,F=f*v-d*A,z=M*F-y*q+w*k+g*P-N*S+b*x;return z?(z=1/z,t[0]=(h*F-a*q+u*k)*z,t[1]=(o*q-r*F-i*k)*z,t[2]=(m*b-A*N+v*g)*z,t[3]=(f*N-l*b-d*g)*z,t[4]=(a*P-s*F-u*S)*z,t[5]=(n*F-o*P+i*S)*z,t[6]=(A*w-p*b-v*y)*z,t[7]=(c*b-f*w+d*y)*z,t[8]=(s*q-h*P+u*x)*z,t[9]=(r*P-n*q-i*x)*z,t[10]=(p*N-m*w+v*M)*z,t[11]=(l*w-c*N-d*M)*z,t[12]=(h*S-s*k-a*x)*z,t[13]=(n*k-r*S+o*x)*z,t[14]=(m*y-p*g-A*M)*z,t[15]=(c*g-l*y+f*M)*z,t):null}function s(t,n,r,o){var i,s,h,a,u,c,l,f,d,p,m,A,v,M,y,w,g,N,b,x,S,P,k,q,F=o[0],z=o[1],C=o[2],O=Math.hypot(F,z,C);return O<e?null:(F*=O=1/O,z*=O,C*=O,i=Math.sin(r),h=1-(s=Math.cos(r)),a=n[0],u=n[1],c=n[2],l=n[3],f=n[4],d=n[5],p=n[6],m=n[7],A=n[8],v=n[9],M=n[10],y=n[11],w=F*F*h+s,g=z*F*h+C*i,N=C*F*h-z*i,b=F*z*h-C*i,x=z*z*h+s,S=C*z*h+F*i,P=F*C*h+z*i,k=z*C*h-F*i,q=C*C*h+s,t[0]=a*w+f*g+A*N,t[1]=u*w+d*g+v*N,t[2]=c*w+p*g+M*N,t[3]=l*w+m*g+y*N,t[4]=a*b+f*x+A*S,t[5]=u*b+d*x+v*S,t[6]=c*b+p*x+M*S,t[7]=l*b+m*x+y*S,t[8]=a*P+f*k+A*q,t[9]=u*P+d*k+v*q,t[10]=c*P+p*k+M*q,t[11]=l*P+m*k+y*q,n!==t&&(t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15]),t)}function h(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t}function a(t,e){var r=new n(3);!function(t,e){var n=e[0],r=e[1],o=e[2],i=e[4],s=e[5],h=e[6],a=e[8],u=e[9],c=e[10];t[0]=Math.hypot(n,r,o),t[1]=Math.hypot(i,s,h),t[2]=Math.hypot(a,u,c)}(r,e);var o=1/r[0],i=1/r[1],s=1/r[2],h=e[0]*o,a=e[1]*i,u=e[2]*s,c=e[4]*o,l=e[5]*i,f=e[6]*s,d=e[8]*o,p=e[9]*i,m=e[10]*s,A=h+l+m,v=0;return A>0?(v=2*Math.sqrt(A+1),t[3]=.25*v,t[0]=(f-p)/v,t[1]=(d-u)/v,t[2]=(a-c)/v):h>l&&h>m?(v=2*Math.sqrt(1+h-l-m),t[3]=(f-p)/v,t[0]=.25*v,t[1]=(a+c)/v,t[2]=(d+u)/v):l>m?(v=2*Math.sqrt(1+l-h-m),t[3]=(d-u)/v,t[0]=(a+c)/v,t[1]=.25*v,t[2]=(f+p)/v):(v=2*Math.sqrt(1+m-h-l),t[3]=(a-c)/v,t[0]=(d+u)/v,t[1]=(f+p)/v,t[2]=.25*v),t}function u(t,e,n,r,o,i,s){var h=1/(e-n),a=1/(r-o),u=1/(i-s);return t[0]=-2*h,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*a,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*u,t[11]=0,t[12]=(e+n)*h,t[13]=(o+r)*a,t[14]=(s+i)*u,t[15]=1,t}function c(t,n,r,i){var s,h,a,u,c,l,f,d,p,m,A=n[0],v=n[1],M=n[2],y=i[0],w=i[1],g=i[2],N=r[0],b=r[1],x=r[2];return Math.abs(A-N)<e&&Math.abs(v-b)<e&&Math.abs(M-x)<e?o(t):(f=A-N,d=v-b,p=M-x,s=w*(p*=m=1/Math.hypot(f,d,p))-g*(d*=m),h=g*(f*=m)-y*p,a=y*d-w*f,(m=Math.hypot(s,h,a))?(s*=m=1/m,h*=m,a*=m):(s=0,h=0,a=0),u=d*a-p*h,c=p*s-f*a,l=f*h-d*s,(m=Math.hypot(u,c,l))?(u*=m=1/m,c*=m,l*=m):(u=0,c=0,l=0),t[0]=s,t[1]=u,t[2]=f,t[3]=0,t[4]=h,t[5]=c,t[6]=d,t[7]=0,t[8]=a,t[9]=l,t[10]=p,t[11]=0,t[12]=-(s*A+h*v+a*M),t[13]=-(u*A+c*v+l*M),t[14]=-(f*A+d*v+p*M),t[15]=1,t)}function l(){var t=new n(3);return n!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function f(t,e,r){var o=new n(3);return o[0]=t,o[1]=e,o[2]=r,o}function d(t,e,n,r){return t[0]=e,t[1]=n,t[2]=r,t}function p(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function m(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function A(t,e){var n=e[0],r=e[1],o=e[2],i=n*n+r*r+o*o;return i>0&&(i=1/Math.sqrt(i)),t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t}function v(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function M(t,e,n){var r=e[0],o=e[1],i=e[2],s=n[0],h=n[1],a=n[2];return t[0]=o*a-i*h,t[1]=i*s-r*a,t[2]=r*h-o*s,t}function y(t,e,n){var r=e[0],o=e[1],i=e[2],s=n[3]*r+n[7]*o+n[11]*i+n[15];return s=s||1,t[0]=(n[0]*r+n[4]*o+n[8]*i+n[12])/s,t[1]=(n[1]*r+n[5]*o+n[9]*i+n[13])/s,t[2]=(n[2]*r+n[6]*o+n[10]*i+n[14])/s,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var w=function(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t};function g(t,e,n){var r=e[0],o=e[1],i=e[2],s=e[3];return t[0]=n[0]*r+n[4]*o+n[8]*i+n[12]*s,t[1]=n[1]*r+n[5]*o+n[9]*i+n[13]*s,t[2]=n[2]*r+n[6]*o+n[10]*i+n[14]*s,t[3]=n[3]*r+n[7]*o+n[11]*i+n[15]*s,t}function N(){var t=new n(4);return n!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function b(t,n,r,o){var i,s,h,a,u,c=n[0],l=n[1],f=n[2],d=n[3],p=r[0],m=r[1],A=r[2],v=r[3];return(s=c*p+l*m+f*A+d*v)<0&&(s=-s,p=-p,m=-m,A=-A,v=-v),1-s>e?(i=Math.acos(s),h=Math.sin(i),a=Math.sin((1-o)*i)/h,u=Math.sin(o*i)/h):(a=1-o,u=o),t[0]=a*c+u*p,t[1]=a*l+u*m,t[2]=a*f+u*A,t[3]=a*d+u*v,t}l(),function(){var t,e=(t=new n(4),n!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();var x;l(),f(1,0,0),f(0,1,0),N(),N(),x=new n(9),n!=Float32Array&&(x[1]=0,x[2]=0,x[3]=0,x[5]=0,x[6]=0,x[7]=0),x[0]=1,x[4]=1,x[8]=1;const S=f(0,1,0);class P{constructor(t,e){this.projectionMatrix=t,this.viewMatrix=e}resize(t,e){return this}}const k=Math.PI/3;const q=Math.PI/180;const F=f(0,1,0);function z(t,e,n){t?(n.nodes[t].children.push(e),n.nodes[e].parent=t):(n.roots.push(e),n.nodes[e].parent=0)}function C(t,e,n){if(t){let r=n.nodes[t].children,o=r.indexOf(e);r.splice(o,1),n.nodes[e].parentNode=0}else{let t=n.roots,r=t.indexOf(e);t.splice(r,1),n.nodes[e].parentNode=0}}function O(t,e,n,r,o){if(n>=100)return;let i=r(e,t);if(!1===i)return;let s=t.nodes[e],h=o?o(s.children,e,t):s.children;for(let e of h)O(t,e,n+1,r,o);"function"==typeof i&&i(e,t)}function j(t,e){delete e.nodes[t]}t.ArcballCameraController=class{constructor(t=10){this.position=l(),this.forwardAmount=0,this.rightAmount=0,this.upAmount=0,this.yawAmount=0,this.pitchAmount=0,this.zoomAmount=0,this.cameraPosition=f(0,0,t),this.vec=l(),this.mat=r()}look(t,e,n=1){return this.pitchAmount+=e*n*-1,this.yawAmount+=t*n*-1,this}move(t,e,n=0,r=1){return this.forwardAmount+=t*r,this.rightAmount+=e*r,this.upAmount+=n*r,this}zoom(t,e=1){return this.zoomAmount+=t*e,this}apply(t){let{position:e,cameraPosition:n,forwardAmount:r,rightAmount:i,upAmount:h,pitchAmount:a,yawAmount:u,zoomAmount:l}=this;this.forwardAmount=0,this.rightAmount=0,this.upAmount=0,this.pitchAmount=0,this.yawAmount=0,this.zoomAmount=0;let f=this.vec,A=this.mat,M=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}(f,F);m(M,M,h),p(e,e,M),p(n,n,M);let g=d(f,t[0],t[4],t[8]);m(g,g,i),p(e,e,g),p(n,n,g);let N=d(f,-t[2],-t[6],-t[10]);m(N,N,l);let b=n[0]-e[0],x=Math.sign(b);Math.sign(b+N[0])!==x&&(N[0]=0),b=n[1]-e[1],Math.sign(b+N[1])!==x&&(N[1]=0),b=n[2]-e[2],Math.sign(b+N[2])!==x&&(N[2]=0),p(n,n,N);let S=d(f,-t[2],0,-t[10]);return m(S,S,r),p(e,e,S),p(n,n,S),M=F,N=d(f,-t[2],-t[6],-t[10]),v(N,M)*Math.sign(a)>.99&&(a=0),s(A,A,u,M),y(f,w(f,n,e),A),p(n,f,e),g=d(f,t[0],t[4],t[8]),o(A),s(A,A,a,g),y(f,w(f,n,e),A),p(n,f,e),c(t,n,e,M),t}},t.Camera=P,t.FirstPersonCameraController=class{constructor(t={locky:!1}){this.locky=t.locky,this.position=l(),this.forward=f(0,0,-1),this.right=f(1,0,0),this.up=f(0,1,0),this.forwardAmount=0,this.rightAmount=0,this.upAmount=0,this.pitch=0,this.yaw=-90}look(t,e,n=1){return this.pitch=Math.min(89.9,Math.max(-89.9,this.pitch+e*n)),this.yaw=(this.yaw+t*n)%360,this}move(t,e=0,n=0,r=1){return this.forwardAmount+=t*r,this.rightAmount+=e*r,this.upAmount+=n*r,this}apply(t){let{position:e,forward:n,right:r,up:o,forwardAmount:i,rightAmount:s,upAmount:h,pitch:a,yaw:u}=this,f=u*q,v=a*q,y=Math.cos(f),w=Math.cos(v),g=Math.sin(f),N=y*w,b=Math.sin(v),x=g*w;A(n,d(n,N,this.locky?0:b,x)),A(r,M(r,n,o));let S=l();return m(S,n,i),p(e,e,S),m(S,r,s),p(e,e,S),m(S,o,h),p(e,e,S),this.forwardAmount=0,this.rightAmount=0,this.upAmount=0,this.locky&&d(n,N,b,x),c(t,e,p(S,e,n),o),t}},t.OrthographicCamera=class extends P{constructor(t,e,n,o,i=-1e3,s=1e3){super(r(),r()),this.orthoBounds={left:void 0===t?void 0:Number(t),top:void 0===e?void 0:Number(e),right:void 0===n?void 0:Number(n),bottom:void 0===o?void 0:Number(o)},this.clippingPlane={near:Number(i),far:Number(s)}}resize(t,e){const{near:n,far:r}=this.clippingPlane,{left:o,top:i,right:s,bottom:h}=this.orthoBounds;let a=this.projectionMatrix,c=void 0!==o;if(void 0!==t)if(c){const c=t/e;u(a,o*c,s*c,h,i,n,r)}else u(a,0,t,e,0,n,r);else c?u(a,o,s,h,i,n,r):u(a,-1,1,1,-1,-1,1);return this}},t.PerspectiveCamera=class extends P{constructor(t=k,e=.1,n=1e3){super(r(),r()),this.fieldOfView=Number(t),this.clippingPlane={near:Number(e),far:Number(n)}}resize(t,e){const n=void 0===t?1:t/e,{near:r,far:o}=this.clippingPlane;return function(t,e,n,r,o){var i,s=1/Math.tan(e/2);t[0]=s/n,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=s,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=o&&o!==1/0?(i=1/(r-o),t[10]=(o+r)*i,t[14]=2*o*r*i):(t[10]=-1,t[14]=-2*r)}(this.projectionMatrix,this.fieldOfView,n,r,o),this}},t.SceneGraph=class{constructor(){this.nodes={},this.roots=[],this._nextAvailableSceneNodeId=1}createSceneNode(t){let e=this._nextAvailableSceneNodeId++,n={parent:0,children:[]};return this.nodes[e]=n,z(t,e,this),e}createSceneNodes(t,e){let n=[];for(let r=0;r<t;++r)n.push(this.createSceneNode(e));return n}deleteSceneNode(t){if(!(t in this.nodes))throw new Error("Cannot delete non-existant scene node for scene graph.");C(this.nodes[t].parent,t,this),O(this,t,0,j)}deleteSceneNodes(t){for(let e of t)this.deleteSceneNode(e)}getSceneNodeInfo(t){return this.nodes[t]}parentSceneNode(t,e){C(this.nodes[t].parent,t,this),z(e,t,this)}replaceSceneNode(t,e){let n=this.nodes[t],r=n.parent,o=n.children.slice();if(C(r,t,this),n.children.length=0,e){let t=this.nodes[e];C(t.parent,e,this),t.children.push(...o),z(r,e,this)}else if(r){this.nodes[r].children.push(...o)}else this.roots.push(...o);for(let t of o)this.nodes[t].parent=r}walk(t,e={}){const{from:n,childFilter:r}=e;let o;o=n?Array.isArray(n)?n:[n]:this.roots,r&&(o=r(o,0,this));for(let e of o)O(this,e,0,t,r)}},t.lookAt=function(t,e,n,r=0,o=1){let i=l(),s=N();h(i,t),a(s,t),c(t,i,f(e,n,r),S);let u=N();a(u,t),b(s,s,u,o),function(t,e,n){var r=e[0],o=e[1],i=e[2],s=e[3],h=r+r,a=o+o,u=i+i,c=r*h,l=r*a,f=r*u,d=o*a,p=o*u,m=i*u,A=s*h,v=s*a,M=s*u;t[0]=1-(d+m),t[1]=l+M,t[2]=f-v,t[3]=0,t[4]=l-M,t[5]=1-(c+m),t[6]=p+A,t[7]=0,t[8]=f+v,t[9]=p-A,t[10]=1-(c+d),t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1}(t,s,i)},t.panTo=function(t,e,n,r=0,o=1){let i=l();h(i,t),function(t,e,n){var r,o,i,s,h,a,u,c,l,f,d,p,m=n[0],A=n[1],v=n[2];e===t?(t[12]=e[0]*m+e[4]*A+e[8]*v+e[12],t[13]=e[1]*m+e[5]*A+e[9]*v+e[13],t[14]=e[2]*m+e[6]*A+e[10]*v+e[14],t[15]=e[3]*m+e[7]*A+e[11]*v+e[15]):(r=e[0],o=e[1],i=e[2],s=e[3],h=e[4],a=e[5],u=e[6],c=e[7],l=e[8],f=e[9],d=e[10],p=e[11],t[0]=r,t[1]=o,t[2]=i,t[3]=s,t[4]=h,t[5]=a,t[6]=u,t[7]=c,t[8]=l,t[9]=f,t[10]=d,t[11]=p,t[12]=r*m+h*A+l*v+e[12],t[13]=o*m+a*A+f*v+e[13],t[14]=i*m+u*A+d*v+e[14],t[15]=s*m+c*A+p*v+e[15])}(t,t,f((e-i[0])*o,(n-i[1])*o,(r-i[2])*o))},t.screenToWorldRay=function(t,e,o,s,h,a=!1){let u=function(t,e,r,o){var i=new n(4);return i[0]=t,i[1]=e,i[2]=r,i[3]=o,i}(e,o,-1,1),c=r();return i(c,s),g(u,u,c),u[2]=-1,u[3]=0,i(c,h),g(u,u,c),t[0]=u[0],t[1]=u[1],t[2]=u[2],a&&A(t,t),t},Object.defineProperty(t,"__esModule",{value:!0})}));
