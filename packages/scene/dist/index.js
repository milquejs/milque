!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(((t="undefined"!=typeof globalThis?globalThis:t||self).milque=t.milque||{},t.milque.scene={}))}(this,(function(t){"use strict";var e=1e-6,n="undefined"!=typeof Float32Array?Float32Array:Array;function r(){var t=new n(16);return n!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function o(t,e){var n=e[0],r=e[1],o=e[2],i=e[3],s=e[4],a=e[5],h=e[6],u=e[7],c=e[8],l=e[9],d=e[10],f=e[11],p=e[12],v=e[13],m=e[14],y=e[15],M=n*a-r*s,A=n*h-o*s,w=n*u-i*s,N=r*h-o*a,b=r*u-i*a,g=o*u-i*h,x=c*v-l*p,S=c*m-d*p,q=c*y-f*p,F=l*m-d*v,P=l*y-f*v,k=d*y-f*m,C=M*k-A*P+w*F+N*q-b*S+g*x;return C?(C=1/C,t[0]=(a*k-h*P+u*F)*C,t[1]=(o*P-r*k-i*F)*C,t[2]=(v*g-m*b+y*N)*C,t[3]=(d*b-l*g-f*N)*C,t[4]=(h*q-s*k-u*S)*C,t[5]=(n*k-o*q+i*S)*C,t[6]=(m*w-p*g-y*A)*C,t[7]=(c*g-d*w+f*A)*C,t[8]=(s*P-a*q+u*x)*C,t[9]=(r*q-n*P-i*x)*C,t[10]=(p*b-v*w+y*M)*C,t[11]=(l*w-c*b-f*M)*C,t[12]=(a*S-s*F-h*x)*C,t[13]=(n*F-r*S+o*x)*C,t[14]=(v*A-p*N-m*M)*C,t[15]=(c*N-l*A+d*M)*C,t):null}function i(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t}function s(t,e){var r=new n(3);!function(t,e){var n=e[0],r=e[1],o=e[2],i=e[4],s=e[5],a=e[6],h=e[8],u=e[9],c=e[10];t[0]=Math.hypot(n,r,o),t[1]=Math.hypot(i,s,a),t[2]=Math.hypot(h,u,c)}(r,e);var o=1/r[0],i=1/r[1],s=1/r[2],a=e[0]*o,h=e[1]*i,u=e[2]*s,c=e[4]*o,l=e[5]*i,d=e[6]*s,f=e[8]*o,p=e[9]*i,v=e[10]*s,m=a+l+v,y=0;return m>0?(y=2*Math.sqrt(m+1),t[3]=.25*y,t[0]=(d-p)/y,t[1]=(f-u)/y,t[2]=(h-c)/y):a>l&&a>v?(y=2*Math.sqrt(1+a-l-v),t[3]=(d-p)/y,t[0]=.25*y,t[1]=(h+c)/y,t[2]=(f+u)/y):l>v?(y=2*Math.sqrt(1+l-a-v),t[3]=(f-u)/y,t[0]=(h+c)/y,t[1]=.25*y,t[2]=(d+p)/y):(y=2*Math.sqrt(1+v-a-l),t[3]=(h-c)/y,t[0]=(f+u)/y,t[1]=(d+p)/y,t[2]=.25*y),t}function a(t,e,n,r,o,i,s){var a=1/(e-n),h=1/(r-o),u=1/(i-s);return t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*h,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*u,t[11]=0,t[12]=(e+n)*a,t[13]=(o+r)*h,t[14]=(s+i)*u,t[15]=1,t}function h(t,n,r,o){var i,s,a,h,u,c,l,d,f,p,v=n[0],m=n[1],y=n[2],M=o[0],A=o[1],w=o[2],N=r[0],b=r[1],g=r[2];return Math.abs(v-N)<e&&Math.abs(m-b)<e&&Math.abs(y-g)<e?function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(t):(l=v-N,d=m-b,f=y-g,i=A*(f*=p=1/Math.hypot(l,d,f))-w*(d*=p),s=w*(l*=p)-M*f,a=M*d-A*l,(p=Math.hypot(i,s,a))?(i*=p=1/p,s*=p,a*=p):(i=0,s=0,a=0),h=d*a-f*s,u=f*i-l*a,c=l*s-d*i,(p=Math.hypot(h,u,c))?(h*=p=1/p,u*=p,c*=p):(h=0,u=0,c=0),t[0]=i,t[1]=h,t[2]=l,t[3]=0,t[4]=s,t[5]=u,t[6]=d,t[7]=0,t[8]=a,t[9]=c,t[10]=f,t[11]=0,t[12]=-(i*v+s*m+a*y),t[13]=-(h*v+u*m+c*y),t[14]=-(l*v+d*m+f*y),t[15]=1,t)}function u(){var t=new n(3);return n!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function c(t,e,r){var o=new n(3);return o[0]=t,o[1]=e,o[2]=r,o}function l(t,e,n,r){return t[0]=e,t[1]=n,t[2]=r,t}function d(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function f(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function p(t,e){var n=e[0],r=e[1],o=e[2],i=n*n+r*r+o*o;return i>0&&(i=1/Math.sqrt(i)),t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t}function v(t,e,n){var r=e[0],o=e[1],i=e[2],s=n[0],a=n[1],h=n[2];return t[0]=o*h-i*a,t[1]=i*s-r*h,t[2]=r*a-o*s,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});function m(t,e,n){var r=e[0],o=e[1],i=e[2],s=e[3];return t[0]=n[0]*r+n[4]*o+n[8]*i+n[12]*s,t[1]=n[1]*r+n[5]*o+n[9]*i+n[13]*s,t[2]=n[2]*r+n[6]*o+n[10]*i+n[14]*s,t[3]=n[3]*r+n[7]*o+n[11]*i+n[15]*s,t}function y(){var t=new n(4);return n!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function M(t,n,r,o){var i,s,a,h,u,c=n[0],l=n[1],d=n[2],f=n[3],p=r[0],v=r[1],m=r[2],y=r[3];return(s=c*p+l*v+d*m+f*y)<0&&(s=-s,p=-p,v=-v,m=-m,y=-y),1-s>e?(i=Math.acos(s),a=Math.sin(i),h=Math.sin((1-o)*i)/a,u=Math.sin(o*i)/a):(h=1-o,u=o),t[0]=h*c+u*p,t[1]=h*l+u*v,t[2]=h*d+u*m,t[3]=h*f+u*y,t}u(),function(){var t,e=(t=new n(4),n!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();var A;u(),c(1,0,0),c(0,1,0),y(),y(),A=new n(9),n!=Float32Array&&(A[1]=0,A[2]=0,A[3]=0,A[5]=0,A[6]=0,A[7]=0),A[0]=1,A[4]=1,A[8]=1;const w=c(0,1,0);class N{constructor(t,e){this.projectionMatrix=t,this.viewMatrix=e}resize(t,e){return this}}const b=Math.PI/3;const g=Math.PI/180;function x(t,e,n){t?(n.nodes[t].children.push(e),n.nodes[e].parent=t):(n.roots.push(e),n.nodes[e].parent=0)}function S(t,e,n){if(t){let r=n.nodes[t].children,o=r.indexOf(e);r.splice(o,1),n.nodes[e].parentNode=0}else{let t=n.roots,r=t.indexOf(e);t.splice(r,1),n.nodes[e].parentNode=0}}function q(t,e,n,r,o){if(n>=100)return;let i=r(e,t);if(!1===i)return;let s=t.nodes[e],a=o?o(s.children,e,t):s.children;for(let e of a)q(t,e,n+1,r,o);"function"==typeof i&&i(e,t)}function F(t,e){delete e.nodes[t]}t.Camera=N,t.FirstPersonCameraController=class{constructor(t={locky:!1}){this.locky=t.locky,this.position=u(),this.forward=c(0,0,-1),this.right=c(1,0,0),this.up=c(0,1,0),this.forwardAmount=0,this.rightAmount=0,this.upAmount=0,this.pitch=0,this.yaw=-90}look(t,e,n=1){return n*=1e3,this.pitch=Math.min(89.9,Math.max(-89.9,this.pitch+e*n)),this.yaw=(this.yaw+t*n)%360,this}move(t,e=0,n=0,r=1){return this.forwardAmount+=t*r,this.rightAmount+=e*r,this.upAmount+=n*r,this}apply(t){let{position:e,forward:n,right:r,up:o,forwardAmount:i,rightAmount:s,upAmount:a,pitch:c,yaw:m}=this,y=m*g,M=c*g,A=Math.cos(y),w=Math.cos(M),N=Math.sin(y),b=A*w,x=Math.sin(M),S=N*w;p(n,l(n,b,this.locky?0:x,S)),p(r,v(r,n,o));let q=u();return f(q,n,i),d(e,e,q),f(q,r,s),d(e,e,q),f(q,o,a),d(e,e,q),this.forwardAmount=0,this.rightAmount=0,this.upAmount=0,this.locky&&l(n,b,x,S),h(t,e,d(q,e,n),o),t}},t.OrthographicCamera=class extends N{constructor(t,e,n,o,i=-1e3,s=1e3){super(r(),r()),this.orthoBounds={left:void 0===t?void 0:Number(t),top:void 0===e?void 0:Number(e),right:void 0===n?void 0:Number(n),bottom:void 0===o?void 0:Number(o)},this.clippingPlane={near:Number(i),far:Number(s)}}resize(t,e){const{near:n,far:r}=this.clippingPlane,{left:o,top:i,right:s,bottom:h}=this.orthoBounds;let u=this.projectionMatrix,c=void 0!==o;if(void 0!==t)if(c){const c=t/e;a(u,o*c,s*c,h,i,n,r)}else a(u,0,t,e,0,n,r);else c?a(u,o,s,h,i,n,r):a(u,-1,1,1,-1,-1,1);return this}},t.PerspectiveCamera=class extends N{constructor(t=b,e=.1,n=1e3){super(r(),r()),this.fieldOfView=Number(t),this.clippingPlane={near:Number(e),far:Number(n)}}resize(t,e){const n=void 0===t?1:t/e,{near:r,far:o}=this.clippingPlane;return function(t,e,n,r,o){var i,s=1/Math.tan(e/2);t[0]=s/n,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=s,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=o&&o!==1/0?(i=1/(r-o),t[10]=(o+r)*i,t[14]=2*o*r*i):(t[10]=-1,t[14]=-2*r)}(this.projectionMatrix,this.fieldOfView,n,r,o),this}},t.SceneGraph=class{constructor(){this.nodes={},this.roots=[],this._nextAvailableSceneNodeId=1}createSceneNode(t){let e=this._nextAvailableSceneNodeId++,n={parent:0,children:[]};return this.nodes[e]=n,x(t,e,this),e}createSceneNodes(t,e){let n=[];for(let r=0;r<t;++r)n.push(this.createSceneNode(e));return n}deleteSceneNode(t){if(!(t in this.nodes))throw new Error("Cannot delete non-existant scene node for scene graph.");S(this.nodes[t].parent,t,this),q(this,t,0,F)}deleteSceneNodes(t){for(let e of t)this.deleteSceneNode(e)}getSceneNodeInfo(t){return this.nodes[t]}parentSceneNode(t,e){S(this.nodes[t].parent,t,this),x(e,t,this)}replaceSceneNode(t,e){let n=this.nodes[t],r=n.parent,o=n.children.slice();if(S(r,t,this),n.children.length=0,e){let t=this.nodes[e];S(t.parent,e,this),t.children.push(...o),x(r,e,this)}else if(r){this.nodes[r].children.push(...o)}else this.roots.push(...o);for(let t of o)this.nodes[t].parent=r}walk(t,e={}){const{from:n,childFilter:r}=e;let o;o=n?Array.isArray(n)?n:[n]:this.roots,r&&(o=r(o,0,this));for(let e of o)q(this,e,0,t,r)}},t.lookAt=function(t,e,n,r=0,o=1){let a=u(),l=y();i(a,t),s(l,t),h(t,a,c(e,n,r),w);let d=y();s(d,t),M(l,l,d,o),function(t,e,n){var r=e[0],o=e[1],i=e[2],s=e[3],a=r+r,h=o+o,u=i+i,c=r*a,l=r*h,d=r*u,f=o*h,p=o*u,v=i*u,m=s*a,y=s*h,M=s*u;t[0]=1-(f+v),t[1]=l+M,t[2]=d-y,t[3]=0,t[4]=l-M,t[5]=1-(c+v),t[6]=p+m,t[7]=0,t[8]=d+y,t[9]=p-m,t[10]=1-(c+f),t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1}(t,l,a)},t.panTo=function(t,e,n,r=0,o=1){let s=u();i(s,t),function(t,e,n){var r,o,i,s,a,h,u,c,l,d,f,p,v=n[0],m=n[1],y=n[2];e===t?(t[12]=e[0]*v+e[4]*m+e[8]*y+e[12],t[13]=e[1]*v+e[5]*m+e[9]*y+e[13],t[14]=e[2]*v+e[6]*m+e[10]*y+e[14],t[15]=e[3]*v+e[7]*m+e[11]*y+e[15]):(r=e[0],o=e[1],i=e[2],s=e[3],a=e[4],h=e[5],u=e[6],c=e[7],l=e[8],d=e[9],f=e[10],p=e[11],t[0]=r,t[1]=o,t[2]=i,t[3]=s,t[4]=a,t[5]=h,t[6]=u,t[7]=c,t[8]=l,t[9]=d,t[10]=f,t[11]=p,t[12]=r*v+a*m+l*y+e[12],t[13]=o*v+h*m+d*y+e[13],t[14]=i*v+u*m+f*y+e[14],t[15]=s*v+c*m+p*y+e[15])}(t,t,c((e-s[0])*o,(n-s[1])*o,(r-s[2])*o))},t.screenToWorldRay=function(t,e,i,s,a,h=!1){let u=function(t,e,r,o){var i=new n(4);return i[0]=t,i[1]=e,i[2]=r,i[3]=o,i}(e,i,-1,1),c=r();return o(c,s),m(u,u,c),u[2]=-1,u[3]=0,o(c,a),m(u,u,c),t[0]=u[0],t[1]=u[1],t[2]=u[2],h&&p(t,t),t},Object.defineProperty(t,"__esModule",{value:!0})}));
