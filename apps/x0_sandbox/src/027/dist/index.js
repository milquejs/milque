!function(){"use strict";const e="noscale";class t extends HTMLElement{static get[Symbol.for("cuttleTemplate")](){let e=document.createElement("template");return e.innerHTML='<div class="container">\r\n    <label class="hidden" id="title">display-port</label>\r\n    <label class="hidden" id="fps">00</label>\r\n    <label class="hidden" id="dimension">0x0</label>\r\n    <canvas></canvas>\r\n    <slot></slot>\r\n</div>',Object.defineProperty(this,Symbol.for("cuttleTemplate"),{value:e}),e}static get[Symbol.for("cuttleStyle")](){let e=document.createElement("style");return e.innerHTML=":host{display:inline-block;color:#555}.container{display:flex;position:relative;width:100%;height:100%}canvas{background:#000;margin:auto;-ms-interpolation-mode:nearest-neighbor;image-rendering:-moz-crisp-edges;image-rendering:pixelated}label{font-family:monospace;color:currentColor;position:absolute}#title{left:.5rem;top:.5rem}#fps{right:.5rem;top:.5rem}#dimension{left:.5rem;bottom:.5rem}.hidden{display:none}:host([debug]) .container{outline:6px dashed rgba(0,0,0,.1);outline-offset:-4px;background-color:rgba(0,0,0,.1)}:host([mode=noscale]) canvas{margin:0;top:0;left:0}:host([mode=center]),:host([mode=fit]),:host([mode=stretch]){width:100%;height:100%}:host([full]){width:100vw!important;height:100vh!important}:host([disabled]){display:none}slot{display:flex;flex-direction:column;align-items:center;justify-content:center;position:absolute;width:100%;height:100%;top:0;left:0;pointer-events:none}::slotted(*){pointer-events:auto}",Object.defineProperty(this,Symbol.for("cuttleStyle"),{value:e}),e}static get observedAttributes(){return["onframe","width","height","disabled","debug","id","class"]}static get properties(){return{width:Number,height:Number,disabled:Boolean,debug:Boolean,mode:{type:String,value:"fit",observed:!1}}}get mode(){return this.getAttribute("mode")}set mode(e){this.setAttribute("mode",e)}get debug(){return this._debug}set debug(e){this.toggleAttribute("debug",e)}get disabled(){return this._disabled}set disabled(e){this.toggleAttribute("disabled",e)}get height(){return this._height}set height(e){this.setAttribute("height",String(e))}get width(){return this._width}set width(e){this.setAttribute("width",String(e))}static get customEvents(){return["frame"]}get onframe(){return this._onframe}set onframe(e){this._onframe&&this.removeEventListener("frame",this._onframe),this._onframe=e,this._onframe&&this.addEventListener("frame",e)}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleTemplate")].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleStyle")].cloneNode(!0)),this._canvasElement=this.shadowRoot.querySelector("canvas"),this._titleElement=this.shadowRoot.querySelector("#title"),this._fpsElement=this.shadowRoot.querySelector("#fps"),this._dimensionElement=this.shadowRoot.querySelector("#dimension"),this._animationRequestHandle=0,this._prevAnimationFrameTime=0,this._width=300,this._height=150,this.update=this.update.bind(this)}get canvas(){return this._canvasElement}connectedCallback(){if(Object.prototype.hasOwnProperty.call(this,"onframe")){let e=this.onframe;delete this.onframe,this.onframe=e}if(Object.prototype.hasOwnProperty.call(this,"width")){let e=this.width;delete this.width,this.width=e}if(Object.prototype.hasOwnProperty.call(this,"height")){let e=this.height;delete this.height,this.height=e}if(Object.prototype.hasOwnProperty.call(this,"disabled")){let e=this.disabled;delete this.disabled,this.disabled=e}if(Object.prototype.hasOwnProperty.call(this,"debug")){let e=this.debug;delete this.debug,this.debug=e}if(Object.prototype.hasOwnProperty.call(this,"mode")){let e=this.mode;delete this.mode,this.mode=e}this.hasAttribute("mode")||this.setAttribute("mode","fit"),this.hasAttribute("tabindex")||this.setAttribute("tabindex",0),this.updateCanvasSize(),this.resume()}disconnectedCallback(){this.pause()}attributeChangedCallback(e,t,s){switch(e){case"width":this._width=Number(s);break;case"height":this._height=Number(s);break;case"disabled":this._disabled=null!==s;break;case"debug":this._debug=null!==s;break;case"onframe":this.onframe=new Function("event","with(document){with(this){"+s+"}}").bind(this)}((e,t,s)=>{switch(e){case"disabled":s?(this.update(0),this.pause()):this.resume();break;case"id":case"class":this._titleElement.innerHTML=`display-port${this.className?"."+this.className:""}${this.hasAttribute("id")?"#"+this.getAttribute("id"):""}`;break;case"debug":this._titleElement.classList.toggle("hidden",s),this._fpsElement.classList.toggle("hidden",s),this._dimensionElement.classList.toggle("hidden",s)}})(e,0,s)}pause(){cancelAnimationFrame(this._animationRequestHandle)}resume(){this._animationRequestHandle=requestAnimationFrame(this.update)}update(t){this._animationRequestHandle=requestAnimationFrame(this.update),this.updateCanvasSize();const s=t-this._prevAnimationFrameTime;if(this._prevAnimationFrameTime=t,this.debug){const t=s<=0?"--":String(Math.round(1e3/s)).padStart(2,"0");if(this._fpsElement.innerText!==t&&(this._fpsElement.innerText=t),this.mode===e){let e=`${this._width}x${this._height}`;this._dimensionElement.innerText!==e&&(this._dimensionElement.innerText=e)}else{let e=`${this._width}x${this._height}|${this.shadowRoot.host.clientWidth}x${this.shadowRoot.host.clientHeight}`;this._dimensionElement.innerText!==e&&(this._dimensionElement.innerText=e)}}this.dispatchEvent(new CustomEvent("frame",{detail:{now:t,prevTime:this._prevAnimationFrameTime,deltaTime:s,canvas:this._canvasElement},bubbles:!1,composed:!0}))}updateCanvasSize(){let t=this.shadowRoot.host.getBoundingClientRect();const s=t.width,n=t.height;let i=this._canvasElement,r=this._width,o=this._height;const a=this.mode;if("stretch"===a)r=s,o=n;else if(a!==e){if(s<r||n<o||"fit"===a){let e=s/r,t=n/o;e<t?(r=s,o*=e):(r*=t,o=n)}}r=Math.floor(r),o=Math.floor(o),i.clientWidth===r&&i.clientHeight===o||(i.width=this._width,i.height=this._height,i.style=`width: ${r}px; height: ${o}px`,this.dispatchEvent(new CustomEvent("resize",{detail:{width:r,height:o},bubbles:!1,composed:!0})))}}window.customElements.define("display-port",t);const s=1,n=2,i=3,r={NULL:0,DOWN:1,UP:2,MOVE:3,parse(e){if("string"!=typeof e)return r.NULL;switch(e.toLowerCase()){case"down":return r.DOWN;case"up":return r.UP;case"move":return r.MOVE;default:return r.NULL}}},o="*";class a{static isAxis(e){return!1}static isButton(e){return!1}constructor(e,t){this.deviceName=e,this.eventTarget=t,this.listeners={}}destroy(){this.listeners={}}addInputListener(e,t){let s=this.listeners[e];s?s.push(t):(s=[t],this.listeners[e]=s)}removeInputListener(e,t){let s=this.listeners[e];s&&(s.indexOf(t),s.splice(t,1))}dispatchInput(e){const{keyCode:t}=e,s=this.listeners[t];let n=!1;if(s){for(let t of s)n|=t(e);return n}for(let t of this.listeners["*"])n|=t(e);return n}}class l{static createAdapter(e,t,s,n,i,r){return{target:e,adapterId:t,deviceName:s,keyCode:n,scale:i,eventCode:r}}constructor(){this.adapters={"*":u()}}add(e){for(let t of e){const{deviceName:e,keyCode:s}=t;let n;e in this.adapters?n=this.adapters[e]:(n=u(),this.adapters[e]=n),s in n?n[s].push(t):n[s]=[t]}}delete(e){for(let t of e){const{deviceName:e,keyCode:s}=t;if(e in this.adapters){let n=this.adapters[e];if(s in n){let e=n[s],i=e.indexOf(t);i>=0&&e.splice(i,1)}}}}clear(){for(let e in this.adapters)this.adapters[e]=u()}poll(e,t,s){const n=this.findAdapters(e,t);for(let e of n){const t=e.eventCode;if(t===r.NULL){const{target:t,scale:n}=e,i=s.value*n;t.poll(i,e)}else{const{target:n,scale:i}=e,r=s.getEvent(t)*i;n.poll(r,e)}}return n.length>0}update(e,t,s){let n=!1;for(let i of this.findAdapters(e,t)){const e=i.eventCode;if(e!==r.NULL){const{target:t,scale:r}=i,o=s.getEvent(e)*r;t.update(o,i),n=!0}}return n}reset(e,t,s){let n=!1;for(let s of this.findAdapters(e,t))s.target.reset(),n=!0;return n}findAdapters(e,t){let s=[];if(e in this.adapters){let n=this.adapters[e];t in n&&s.push(...n[t]),s.push(...n["*"])}let n=this.adapters["*"];return t in n&&s.push(...n[t]),s.push(...n["*"]),s}}function u(){return{[o]:[]}}class h{constructor(){this.value=0}update(e){this.value=e}poll(){this.value=0}getEvent(e){return 0}getState(){return this.value}}class c extends h{constructor(){super(),this.update=this.update.bind(this),this.adapters=[],this.values=[],this.next={values:[],value:0}}hydrate(e){Array.isArray(e)||(e=[e]);let t=[],s=0;for(let n of e){"string"==typeof n&&(n={key:n});const{key:e,scale:i=1,event:o="null"}=n,{deviceName:a,keyCode:u}=d(e),h=r.parse(o),c=Number(i);let p=l.createAdapter(this,s,a,u,c,h);t.push(p),++s}this.adapters=t,this.values=new Array(t.length).fill(0),this.next={values:new Array(t.length).fill(0),value:0}}poll(e,t){const s=t.adapterId;let n=this.values[s];this.values[s]=e,this.value=this.value-n+e,this.next.values[s]=0,this.next.value+=e-n}update(e,t){const s=t.adapterId;let n=this.next.values[s];this.next.values[s]=e,this.next.value+=e-n}reset(){this.values.fill(0),this.value=0,this.next.values.fill(0),this.next.value=0}}function d(e){let t=e.indexOf(":");if(t>=0)return{deviceName:e.substring(0,t),keyCode:e.substring(t+1)};throw new Error("Invalid key string - missing device separator ':'.")}function p(e,t){return`${e}:${t}`}class m extends h{constructor(){super(),this.delta=0,this.next={delta:0}}update(e,t){this.value=e,this.next.delta+=t}poll(){this.delta=this.next.delta,this.next.delta=0}getEvent(e){switch(e){case r.MOVE:return this.delta;default:return super.getEvent(e)}}}class f extends h{constructor(){super(),this.down=!1,this.up=!1,this.next={down:!1,up:!1}}update(e){e?this.next.down=!0:this.next.up=!0}poll(){const{up:e,down:t}=this.next;this.value?this.up&&!e&&(this.value=0):t&&(this.value=1),this.down=t,this.up=e,this.next.down=!1,this.next.up=!1}getEvent(e){switch(e){case r.DOWN:return 1&this.down;case r.UP:return 1&this.up;default:return super.getEvent(e)}}}const b=1,v=2;class _{constructor(e){this.onInputEvent=this.onInputEvent.bind(this),this.onAnimationFrame=this.onAnimationFrame.bind(this);let t={},s={};for(let n of e){const e=n.deviceName;if(e in t)throw new Error(`Another device with name '${e}' already exists.`);t[e]=n,s[e]={},n.addInputListener(o,this.onInputEvent)}this.devices=t,this.keySources=s,this.listeners={poll:[],update:[]},this._autopoll=!1,this._animationFrameHandle=null}destroy(){this.clearKeySources();for(let e in this.devices){let t=this.devices[e];t.removeInputListener(o,this.onInputEvent),t.destroy()}this.devices={}}poll(e=performance.now()){for(const e in this.keySources){const t=this.keySources[e];for(const s in t){let n=t[s];n.poll(),this.dispatchInputEvent(v,e,s,n)}}this.dispatchPollEvent(e)}addEventListener(e,t){e in this.listeners?this.listeners[e].unshift(t):this.listeners[e]=[t]}removeEventListener(e,t){if(e in this.listeners){let s=this.listeners[e],n=s.indexOf(t);s.splice(n,1)}}countEventListeners(e){if(!(e in this.listeners))throw new Error(`Cannot count listeners for unknown event '${e}'.`);return this.listeners[e].length}dispatchEvent(e,t){for(let s of this.listeners[e])s(t)}dispatchInputEvent(e,t,s,n){this.dispatchEvent("input",{stage:e,deviceName:t,keyCode:s,input:n})}dispatchPollEvent(e){this.dispatchEvent("poll",{now:e})}onInputEvent(e){const t=e.deviceName;switch(e.type){case s:{const s=e.keyCode;let n=this.keySources[t][s];if(n)return n.update(e.event===r.DOWN),this.dispatchInputEvent(b,t,s,n),!0}break;case n:{let s=this.keySources[t],n=s.PosX;n&&(n.update(e.x,e.dx),this.dispatchInputEvent(b,t,"PosX",n));let i=s.PosY;i&&(i.update(e.y,e.dy),this.dispatchInputEvent(b,t,"PosY",i))}break;case i:{let s=this.keySources[t],n=s.WheelX;n&&(n.update(e.dx,e.dx),this.dispatchInputEvent(b,t,"WheelX",n));let i=s.WheelY;i&&(i.update(e.dy,e.dy),this.dispatchInputEvent(b,t,"WheelY",i));let r=s.WheelZ;r&&(r.update(e.dz,e.dz),this.dispatchInputEvent(b,t,"WheelZ",r))}}}onAnimationFrame(e){this._autopoll&&(this._animationFrameHandle=requestAnimationFrame(this.onAnimationFrame),this.poll(e))}set autopoll(e){this._autopoll=e,this._animationFrameHandle&&(cancelAnimationFrame(this._animationFrameHandle),this._animationFrameHandle=null),e&&(this._animationFrameHandle=requestAnimationFrame(this.onAnimationFrame))}get autopoll(){return this._autopoll}addKeySource(e,t){if(!(e in this.devices))throw new Error("Invalid device name - missing device with name in source.");let s,n=this.devices[e];if(n.constructor.isAxis(t))s=new m;else{if(!n.constructor.isButton(t))throw new Error(`Unknown key code '${t}' for device ${e}.`);s=new f}if(this.keySources[e][t])throw new Error("Cannot add duplicate key source for the same device and key code.");return this.keySources[e][t]=s,this}deleteKeySource(e,t){if(!this.keySources[e][t])throw new Error("Cannot delete missing key source for the device and key code.");delete this.keySources[e][t]}getKeySource(e,t){return this.keySources[e][t]}hasKeySource(e,t){return e in this.keySources&&t in this.keySources[e]}clearKeySources(){for(let e in this.devices)this.keySources[e]={}}}class y extends a{static isAxis(e){return!1}static isButton(e){return!0}constructor(e,t={}){super("Keyboard",e);const{repeat:n=!1}=t;this.repeat=n,this._eventObject={target:e,deviceName:this.deviceName,keyCode:"",event:r.NULL,type:s,value:0,control:!1,shift:!1,alt:!1},this.onKeyDown=this.onKeyDown.bind(this),this.onKeyUp=this.onKeyUp.bind(this),e.addEventListener("keydown",this.onKeyDown),e.addEventListener("keyup",this.onKeyUp)}destroy(){let e=this.eventTarget;e.removeEventListener("keydown",this.onKeyDown),e.removeEventListener("keyup",this.onKeyUp),super.destroy()}onKeyDown(e){if(e.repeat)return e.preventDefault(),e.stopPropagation(),!1;let t=this._eventObject;return t.keyCode=e.code,t.event=r.DOWN,t.value=1,t.control=e.ctrlKey,t.shift=e.shiftKey,t.alt=e.altKey,this.dispatchInput(t)?(e.preventDefault(),e.stopPropagation(),!1):void 0}onKeyUp(e){let t=this._eventObject;if(t.keyCode=e.code,t.event=r.UP,t.value=1,t.control=e.ctrlKey,t.shift=e.shiftKey,t.alt=e.altKey,this.dispatchInput(t))return e.preventDefault(),e.stopPropagation(),!1}}class g extends a{static isAxis(e){return"PosX"===e||"PosY"===e||"WheelX"===e||"WheelY"===e||"WheelZ"===e}static isButton(e){return!this.isAxis(e)}constructor(e,t={eventsOnFocus:!0}){super("Mouse",e),this.canvasTarget=e instanceof HTMLCanvasElement&&e||e.canvas||e.querySelector("canvas")||e.shadowRoot&&e.shadowRoot.querySelector("canvas")||e,this.eventsOnFocus=t.eventsOnFocus,this._downHasFocus=!1,this._eventObject={target:e,deviceName:this.deviceName,keyCode:"",event:r.NULL,type:s,value:0,control:!1,shift:!1,alt:!1},this._positionObject={target:e,deviceName:this.deviceName,keyCode:"Position",event:r.MOVE,type:n,x:0,y:0,dx:0,dy:0},this._wheelObject={target:e,deviceName:this.deviceName,keyCode:"Wheel",event:r.MOVE,type:i,dx:0,dy:0,dz:0},this.onMouseDown=this.onMouseDown.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onContextMenu=this.onContextMenu.bind(this),this.onWheel=this.onWheel.bind(this),e.addEventListener("mousedown",this.onMouseDown),e.addEventListener("contextmenu",this.onContextMenu),e.addEventListener("wheel",this.onWheel),document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onMouseUp)}destroy(){let e=this.eventTarget;e.removeEventListener("mousedown",this.onMouseDown),e.removeEventListener("contextmenu",this.onContextMenu),e.removeEventListener("wheel",this.onWheel),document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp),super.destroy()}setPointerLock(e=!0){e?this.eventTarget.requestPointerLock():this.eventTarget.exitPointerLock()}hasPointerLock(){return document.pointerLockElement===this.eventTarget}onMouseDown(e){this._downHasFocus=!0;let t=this._eventObject;if(t.keyCode="Button"+e.button,t.event=r.DOWN,t.value=1,t.control=e.ctrlKey,t.shift=e.shiftKey,t.alt=e.altKey,this.dispatchInput(t)&&document.activeElement===this.eventTarget)return e.preventDefault(),e.stopPropagation(),!1}onContextMenu(e){return e.preventDefault(),e.stopPropagation(),!1}onWheel(e){let t=this._wheelObject;switch(e.deltaMode){case WheelEvent.DOM_DELTA_LINE:t.dx=10*e.deltaX,t.dy=10*e.deltaY,t.dz=10*e.deltaZ;break;case WheelEvent.DOM_DELTA_PAGE:t.dx=100*e.deltaX,t.dy=100*e.deltaY,t.dz=100*e.deltaZ;break;case WheelEvent.DOM_DELTA_PIXEL:default:t.dx=e.deltaX,t.dy=e.deltaY,t.dz=e.deltaZ}if(this.dispatchInput(t))return e.preventDefault(),e.stopPropagation(),!1}onMouseUp(e){if(!this._downHasFocus)return;this._downHasFocus=!1;let t=this._eventObject;return t.keyCode="Button"+e.button,t.event=r.UP,t.value=1,t.control=e.ctrlKey,t.shift=e.shiftKey,t.alt=e.altKey,this.dispatchInput(t)?(e.preventDefault(),e.stopPropagation(),!1):void 0}onMouseMove(e){if(this.eventsOnFocus&&document.activeElement!==this.eventTarget)return;const t=this.canvasTarget,{clientWidth:s,clientHeight:n}=t,i=t.getBoundingClientRect();let r=e.movementX/s,o=e.movementY/n,a=(e.clientX-i.left)/s,l=(e.clientY-i.top)/n,u=this._positionObject;u.x=a,u.y=l,u.dx=r,u.dy=o,this.dispatchInput(u)}}const E=Symbol("keySourceRefCount");const w=Symbol("inputEventSource");function S(e){return Object.prototype.hasOwnProperty.call(e,w)&&Object.getOwnPropertyDescriptor(e,w).value}class A extends HTMLElement{static get[Symbol.for("cuttleTemplate")](){let e=document.createElement("template");return e.innerHTML='<div>\r\n    <label id="title">\r\n        input-source\r\n    </label>\r\n    <span>|</span>\r\n    <p>\r\n        <label for="poll">poll</label>\r\n        <output id="poll"></output>\r\n    </p>\r\n    <p>\r\n        <label for="focus">focus</label>\r\n        <output id="focus"></output>\r\n    </p>\r\n</div>\r\n',Object.defineProperty(this,Symbol.for("cuttleTemplate"),{value:e}),e}static get[Symbol.for("cuttleStyle")](){let e=document.createElement("style");return e.innerHTML=':host{display:inline-block}div{font-family:monospace;color:#666;outline:1px solid #666;padding:4px}p{display:inline;margin:0;padding:0}#focus:empty:after,#poll:empty:after{content:"✗";color:red}',Object.defineProperty(this,Symbol.for("cuttleStyle"),{value:e}),e}static for(e){return new A(e)}static get observedAttributes(){return["oninput","onpoll","for","autopoll","id","class"]}static get properties(){return{for:String,autopoll:Boolean}}get autopoll(){return this._autopoll}set autopoll(e){this.toggleAttribute("autopoll",e)}get for(){return this._for}set for(e){this.setAttribute("for",e)}static get customEvents(){return["input","poll"]}get onpoll(){return this._onpoll}set onpoll(e){this._onpoll&&this.removeEventListener("poll",this._onpoll),this._onpoll=e,this._onpoll&&this.addEventListener("poll",e)}get oninput(){return this._oninput}set oninput(e){this._oninput&&this.removeEventListener("input",this._oninput),this._oninput=e,this._oninput&&this.addEventListener("input",e)}constructor(e){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleTemplate")].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleStyle")].cloneNode(!0)),this._containerElement=this.shadowRoot.querySelector("div"),this._titleElement=this.shadowRoot.querySelector("#title"),this._pollElement=this.shadowRoot.querySelector("#poll"),this._focusElement=this.shadowRoot.querySelector("#focus"),this._pollCount=0,this._pollCountDelay=0,this._eventTarget=null,this._eventSource=null,this._keySourceRefCount={},this.onSourcePoll=this.onSourcePoll.bind(this),this.onSourceInput=this.onSourceInput.bind(this),this.onTargetFocus=this.onTargetFocus.bind(this),this.onTargetBlur=this.onTargetBlur.bind(this),e&&this.setEventTarget(e)}connectedCallback(){if(Object.prototype.hasOwnProperty.call(this,"oninput")){let e=this.oninput;delete this.oninput,this.oninput=e}if(Object.prototype.hasOwnProperty.call(this,"onpoll")){let e=this.onpoll;delete this.onpoll,this.onpoll=e}if(Object.prototype.hasOwnProperty.call(this,"for")){let e=this.for;delete this.for,this.for=e}if(Object.prototype.hasOwnProperty.call(this,"autopoll")){let e=this.autopoll;delete this.autopoll,this.autopoll=e}this.hasAttribute("tabindex")||this.setAttribute("tabindex",0),this.hasAttribute("for")||this._eventTarget||this.setEventTarget(this)}disconnectedCallback(){this.clearEventTarget()}attributeChangedCallback(e,t,s){switch(e){case"for":this._for=s;break;case"autopoll":this._autopoll=null!==s;break;case"oninput":this.oninput=new Function("event","with(document){with(this){"+s+"}}").bind(this);break;case"onpoll":this.onpoll=new Function("event","with(document){with(this){"+s+"}}").bind(this)}((e,t,s)=>{switch(e){case"for":this.setEventTarget(s?document.getElementById(s):this);break;case"id":case"class":{let e=this.className?"."+this.className:"",t=this.hasAttribute("id")?"#"+this.getAttribute("id"):"";this._titleElement.innerHTML=e+t}}})(e,0,s)}poll(e){this._eventSource.poll(e)}onSourceInput({stage:e,deviceName:t,keyCode:s,input:n}){this.dispatchEvent(new CustomEvent("input",{composed:!0,bubbles:!1,detail:{stage:e,deviceName:t,keyCode:s,input:n}}))}onSourcePoll({now:e}){this._pollCount+=1,this.dispatchEvent(new CustomEvent("poll",{composed:!0,bubbles:!1})),e-this._pollCountDelay>1e3&&(this._pollCountDelay=e,this._pollCount>0?(this._pollElement.innerHTML="✓",this._pollCount=0):this._pollElement.innerHTML="")}onTargetFocus(){this._focusElement.innerHTML="✓"}onTargetBlur(){this._focusElement.innerHTML=""}setEventTarget(e){if(this.clearEventTarget(),!e)throw new Error("Cannot set null as event target for input source.");let t;S(e)?t=function(e){return Object.getOwnPropertyDescriptor(e,w).value}(e):(t=new _([new y(e),new g(e)]),function(e,t){Object.defineProperty(e,w,{value:t,configurable:!0})}(e,t),function(e){E in e||(e[E]={})}(t)),this._eventSource=t,this._eventTarget=e;let s=this.autopoll;s&&(this._eventSource.autopoll=s),t.addEventListener("poll",this.onSourcePoll),t.addEventListener("input",this.onSourceInput),e.addEventListener("focus",this.onTargetFocus),e.addEventListener("blur",this.onTargetBlur)}clearEventTarget(){let e=this._eventTarget,t=this._eventSource;this._eventTarget=null,this._eventSource=null,e&&(e.removeEventListener("focus",this.onTargetFocus),e.removeEventListener("blur",this.onTargetBlur),t.removeEventListener("poll",this.onSourcePoll),t.removeEventListener("input",this.onSourceInput),t.countEventListeners("input")<=0&&(t.destroy(),function(e){Object.defineProperty(e,w,{value:null,configurable:!0})}(e)))}enableKeySource(e,t){if(!e||!t)throw new Error("Invalid device name or key code for key source.");let s=this._eventSource;1===function(e,t,s){const n=p(t,s);let i=e[E],r=i[n]+1||1;return i[n]=r,r}(s,e,t)&&s.addKeySource(e,t)}disableKeySource(e,t){if(!e||!t)throw new Error("Invalid device name or key code for key source.");let s=this._eventSource;0===function(e,t,s){const n=p(t,s);let i=e[E],r=i[n]-1||0;return i[n]=Math.max(r,0),r}(s,e,t)&&s.deleteKeySource(e,t)}getKeySource(e,t){if(!e||!t)throw new Error("Invalid device name or key code for key source.");return this._eventSource.getKeySource(e,t)}hasKeySource(e,t){if(!e||!t)throw new Error("Invalid device name or key code for key source.");return this._eventSource.hasKeySource(e,t)}clearKeySources(){let e=this._eventSource;e.clearKeySources(),function(e){e[E]={}}(e)}get keySources(){return this._eventSource.keySources}get devices(){return this._eventSource.devices}}window.customElements.define("input-source",A);class T{constructor(e=null,t=null,s=!0){this.source=null,this._disabled=s,this._ignoreInput=s,this.adapters=new l,this.inputs={},this.onSourceInput=this.onSourceInput.bind(this),this.onSourcePoll=this.onSourcePoll.bind(this),(e||t)&&this._setupInputs(N(e),t),s||this.attach()}get disabled(){return this._disabled}set disabled(e){this.toggle(!e)}setInputMap(e){return this._setupInputs(this.source,e),this}setInputSource(e){return this._setupInputs(N(e),null),this}attach(){if(!this.source)throw new Error("Missing input source to attach context.");return this.toggle(!0),this}detach(){return this.toggle(!1),this._setupInputs(null,null),this}_setupInputs(e,t){const s=this.disabled;this.disabled=!0;const n=this.source,i=this.inputs,r=n!==e&&n,o=this.inputs&&t;if(r||o){r&&(n.removeEventListener("poll",this.onSourcePoll),n.removeEventListener("input",this.onSourceInput));for(let e in i){let{adapters:t}=i[e];for(let e of t){const{deviceName:t,keyCode:s}=e;n.disableKeySource(t,s)}}o&&(this.adapters.clear(),this.inputs={})}if(t){let e={};for(let s in t){let n=t[s],r=i[s]||new c;r.hydrate(n);let o=r.adapters;this.adapters.add(o),e[s]=r}this.inputs=e}if(e){const t=this.inputs;for(let s in t){let{adapters:n}=t[s];for(let t of n){const{deviceName:s,keyCode:n}=t;e.enableKeySource(s,n)}}this.source!==e&&(e.addEventListener("poll",this.onSourcePoll),e.addEventListener("input",this.onSourceInput),this.source=e)}this.disabled=s}onSourceInput(e){if(e.detail.consumed||this._ignoreInput){const{deviceName:t,keyCode:s,input:n}=e;this.adapters.reset(t,s,n)}else{const{stage:t,deviceName:s,keyCode:n,input:i}=e.detail;switch(t){case v:this.adapters.poll(s,n,i);break;case b:this.adapters.update(s,n,i);break;default:throw new Error("Unknown input source stage.")}e.consumed=!0}}onSourcePoll(e){this._ignoreInput!==this.disabled&&(this._ignoreInput=this.disabled)}toggle(e=this._disabled){if(e){if(!this.source)throw new Error("Input source must be set before enabling input context.");Object.keys(this.inputs).length<=0&&console.warn("No inputs found for enabled input context - did you forget to setInputMap()?")}return this._disabled=!e,this}getInput(e){if(e in this.inputs)return this.inputs[e];{let t=new c;return this.inputs[e]=t,t}}hasInput(e){return e in this.inputs&&this.inputs[e].adapters.length>0}getInputValue(e){return e in this.inputs?this.inputs[e].value:0}}function N(e){if(e instanceof A)return e;{let t=e,s=S(t),n=new A(t);return s||(n.autopoll=!0),n}}class x extends HTMLElement{static get[Symbol.for("cuttleTemplate")](){let e=document.createElement("template");return e.innerHTML='<kbd>\r\n    <span id="key"><slot></slot></span>\r\n    <span id="value" class="hidden"></span>\r\n</kbd>\r\n',Object.defineProperty(this,Symbol.for("cuttleTemplate"),{value:e}),e}static get[Symbol.for("cuttleStyle")](){let e=document.createElement("style");return e.innerHTML='kbd{position:relative;display:inline-block;border-radius:3px;border:1px solid #888;font-size:.85em;font-weight:700;text-rendering:optimizeLegibility;line-height:12px;height:14px;padding:2px 4px;color:#444;background-color:#eee;box-shadow:inset 0 -3px 0 #aaa;overflow:hidden}kbd:empty:after{content:"<?>";opacity:.6}.disabled{opacity:.6;box-shadow:none;background-color:#aaa}.hidden{display:none}#value{position:absolute;top:0;bottom:0;right:0;font-size:.85em;padding:2px 4px 0;color:#ccc;background-color:#333;box-shadow:inset 0 3px 0 #222}',Object.defineProperty(this,Symbol.for("cuttleStyle"),{value:e}),e}static get properties(){return{name:String,value:String,disabled:Boolean}}get disabled(){return this._disabled}set disabled(e){this.toggleAttribute("disabled",e)}get value(){return this._value}set value(e){this.setAttribute("value",e)}get name(){return this._name}set name(e){this.setAttribute("name",e)}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleTemplate")].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleStyle")].cloneNode(!0)),this._keyboardElement=this.shadowRoot.querySelector("kbd"),this._keyElement=this.shadowRoot.querySelector("#key"),this._valueElement=this.shadowRoot.querySelector("#value")}attributeChangedCallback(e,t,s){switch(e){case"name":this._name=s;break;case"value":this._value=s;break;case"disabled":this._disabled=null!==s}((e,t,s)=>{switch(e){case"name":this._keyElement.innerText=s;break;case"value":null!==s?(this._valueElement.classList.toggle("hidden",!1),this._valueElement.innerText=s,this._keyboardElement.style.paddingRight=`${this._valueElement.clientWidth+4}px`):this._valueElement.classList.toggle("hidden",!0);break;case"disabled":this._keyboardElement.classList.toggle("disabled",null!==s)}})(e,0,s)}connectedCallback(){if(Object.prototype.hasOwnProperty.call(this,"name")){let e=this.name;delete this.name,this.name=e}if(Object.prototype.hasOwnProperty.call(this,"value")){let e=this.value;delete this.value,this.value=e}if(Object.prototype.hasOwnProperty.call(this,"disabled")){let e=this.disabled;delete this.disabled,this.disabled=e}}static get observedAttributes(){return["name","value","disabled"]}}window.customElements.define("input-key",x);class L extends HTMLElement{static get[Symbol.for("cuttleTemplate")](){let e=document.createElement("template");return e.innerHTML='<table>\r\n    <thead>\r\n        <tr class="tableHeader">\r\n            <th colspan=4>\r\n                <slot id="title">input-map</slot>\r\n            </th>\r\n        </tr>\r\n        <tr class="colHeader">\r\n            <th>name</th>\r\n            <th>key</th>\r\n            <th>mod</th>\r\n            <th>value</th>\r\n        </tr>\r\n    </thead>\r\n    <tbody>\r\n    </tbody>\r\n</table>\r\n',Object.defineProperty(this,Symbol.for("cuttleTemplate"),{value:e}),e}static get[Symbol.for("cuttleStyle")](){let e=document.createElement("style");return e.innerHTML=":host{display:block}table{border-collapse:collapse}table,td,th{border:1px solid #666}td,th{padding:5px 10px}td{text-align:center}thead th{padding:0}.colHeader>th{font-size:.8em;padding:0 10px;letter-spacing:3px;background-color:#aaa;color:#666}.colHeader>th,output{font-family:monospace}output{border-radius:.3em;padding:3px}tr:not(.primary) .name,tr:not(.primary) .value{opacity:.3}tr:nth-child(2n){background-color:#eee}",Object.defineProperty(this,Symbol.for("cuttleStyle"),{value:e}),e}static get customEvents(){return["load"]}get onload(){return this._onload}set onload(e){this._onload&&this.removeEventListener("load",this._onload),this._onload=e,this._onload&&this.addEventListener("load",e)}static get observedAttributes(){return["onload","src","id","class"]}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleTemplate")].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleStyle")].cloneNode(!0)),this._src="",this._inputMap=null,this._tableElements={},this._titleElement=this.shadowRoot.querySelector("#title"),this._bodyElement=this.shadowRoot.querySelector("tbody"),this._children=this.shadowRoot.querySelector("slot")}get map(){return this._inputMap}get mapElements(){return this._tableElements}connectedCallback(){if(Object.prototype.hasOwnProperty.call(this,"onload")){let e=this.onload;delete this.onload,this.onload=e}!function(e,t){if(Object.prototype.hasOwnProperty.call(e,t)){let s=e[t];delete e[t],e[t]=s}}(this,"src")}attributeChangedCallback(e,t,s){switch(e){case"onload":this.onload=new Function("event","with(document){with(this){"+s+"}}").bind(this)}((e,t,s)=>{switch(e){case"src":if(this._src!==s)if(this._src=s,s.trim().startsWith("{")){let e=JSON.parse(s);this._setInputMap(e)}else fetch(s).then((e=>e.json())).then((e=>this._setInputMap(e)));break;case"id":case"class":this._titleElement.innerHTML=`input-port${this.className?"."+this.className:""}${this.hasAttribute("id")?"#"+this.getAttribute("id"):""}`}})(e,0,s)}get src(){return this.getAttribute("src")}set src(e){switch(typeof e){case"object":{let t=JSON.stringify(e);this._src=t,this._setInputMap(e),this.setAttribute("src",t)}break;case"string":this.setAttribute("src",e);break;default:this.setAttribute("src",JSON.stringify(e))}}_setInputMap(e){let t={},s=[];for(let n in e){let i=[];I(i,n,e[n]),t[n]=i,s.push(...i)}this._bodyElement.innerHTML="";for(let e of s)this._bodyElement.appendChild(e);this._inputMap=e,this._tableElements=t,this.dispatchEvent(new CustomEvent("load",{bubbles:!1,composed:!0,detail:{map:e}}))}}function I(e,t,s){if(Array.isArray(s)){I(e,t,s[0]);let n=s.length;for(let i=1;i<n;++i)e.push(M(t,s[i],!1))}else e.push(M(t,s,!0));return e}function M(e,t,s=!0){if("object"==typeof t){const{key:n,event:i,scale:r}=t;return O(e,n,i,r,0,s)}return O(e,t,null,1,0,s)}function O(e,t,s,n,i,r=!0){let o=document.createElement("tr");r&&o.classList.add("primary");{let t=document.createElement("td");t.textContent=e,t.classList.add("name"),o.appendChild(t)}{let e=document.createElement("td");e.classList.add("key");let s=new x;s.innerText=t,e.appendChild(s),o.appendChild(e)}{let e=document.createElement("td"),t=document.createElement("samp"),i=[];"string"==typeof s&&"null"!==s&&i.push(s),"number"==typeof n&&1!==n&&i.push(`×(${n.toFixed(2)})`),t.innerText=i.join(" "),e.classList.add("mod"),e.appendChild(t),o.appendChild(e)}{let e=document.createElement("td"),t=document.createElement("output");t.innerText=Number(i).toFixed(2),t.classList.add("value"),e.appendChild(t),o.appendChild(e)}return o}window.customElements.define("input-map",L);class C extends HTMLElement{static get[Symbol.for("cuttleTemplate")](){let e=document.createElement("template");return e.innerHTML="<input-map>\r\n    <slot></slot>\r\n    <input-source></input-source>\r\n</input-map>\r\n",Object.defineProperty(this,Symbol.for("cuttleTemplate"),{value:e}),e}static get[Symbol.for("cuttleStyle")](){let e=document.createElement("style");return e.innerHTML=":host{display:inline-block}",Object.defineProperty(this,Symbol.for("cuttleStyle"),{value:e}),e}static get properties(){return{for:String,disabled:Boolean}}get disabled(){return this._disabled}set disabled(e){this.toggleAttribute("disabled",e)}get for(){return this._for}set for(e){this.setAttribute("for",e)}static get observedAttributes(){return["for","disabled","src","id","class"]}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleTemplate")].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleStyle")].cloneNode(!0)),this._inputContext=new T,this._mapElement=this.shadowRoot.querySelector("input-map"),this._sourceElement=this.shadowRoot.querySelector("input-source"),this.onInputMapLoad=this.onInputMapLoad.bind(this),this.onInputSourcePoll=this.onInputSourcePoll.bind(this),this._mapElement.addEventListener("load",this.onInputMapLoad),this._sourceElement.addEventListener("poll",this.onInputSourcePoll)}get context(){return this._inputContext}get source(){return this._sourceElement}get map(){return this._mapElement.map}onInputMapLoad(){let e=this._sourceElement,t=this._mapElement.map;e&&t&&(this._inputContext.setInputMap(t).setInputSource(e).attach(),this._inputContext.disabled=this._disabled)}onInputSourcePoll(){for(let[e,t]of Object.entries(this._mapElement.mapElements)){let s=this._inputContext.getInputValue(e);t[0].querySelector("output").innerText=Number(s).toFixed(2)}}connectedCallback(){if(Object.prototype.hasOwnProperty.call(this,"for")){let e=this.for;delete this.for,this.for=e}if(Object.prototype.hasOwnProperty.call(this,"disabled")){let e=this.disabled;delete this.disabled,this.disabled=e}!function(e,t){if(Object.prototype.hasOwnProperty.call(e,t)){let s=e[t];delete e[t],e[t]=s}}(this,"src")}attributeChangedCallback(e,t,s){switch(e){case"for":this._for=s;break;case"disabled":this._disabled=null!==s}((e,t,s)=>{switch(e){case"for":{let e=document.getElementById(s);S(s?e:this._sourceElement)||(this._sourceElement.autopoll=!0),e instanceof A&&e._eventTarget?(this._sourceElement.setEventTarget(e._eventTarget),this._sourceElement.className=e.className,this._sourceElement.id=e.id):this._sourceElement.for=s;let t=this._sourceElement,n=this._mapElement.map;n&&(this._inputContext.setInputMap(n).setInputSource(t).attach(),this._inputContext.disabled=this._disabled)}break;case"src":this._mapElement.src=s;break;case"disabled":{let e=this._sourceElement,t=this._mapElement.map;e&&t&&(this._inputContext.disabled=this._disabled)}break;case"id":this._sourceElement.id=s;break;case"class":this._sourceElement.className=s}})(e,0,s)}get src(){return this._mapElement.src}set src(e){this._mapElement.src=e}getInput(e){return this._inputContext.getInput(e)}getInputValue(e){return this._inputContext.getInputValue(e)}}window.customElements.define("input-context",C);var k="undefined"!=typeof Float32Array?Float32Array:Array;function R(){var e=new k(16);return k!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function P(e,t,s){var n,i,r,o,a,l,u,h,c,d,p,m,f=s[0],b=s[1],v=s[2];return t===e?(e[12]=t[0]*f+t[4]*b+t[8]*v+t[12],e[13]=t[1]*f+t[5]*b+t[9]*v+t[13],e[14]=t[2]*f+t[6]*b+t[10]*v+t[14],e[15]=t[3]*f+t[7]*b+t[11]*v+t[15]):(n=t[0],i=t[1],r=t[2],o=t[3],a=t[4],l=t[5],u=t[6],h=t[7],c=t[8],d=t[9],p=t[10],m=t[11],e[0]=n,e[1]=i,e[2]=r,e[3]=o,e[4]=a,e[5]=l,e[6]=u,e[7]=h,e[8]=c,e[9]=d,e[10]=p,e[11]=m,e[12]=n*f+a*b+c*v+t[12],e[13]=i*f+l*b+d*v+t[13],e[14]=r*f+u*b+p*v+t[14],e[15]=o*f+h*b+m*v+t[15]),e}function F(){var e=new k(3);return k!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function D(e,t,s){var n=new k(3);return n[0]=e,n[1]=t,n[2]=s,n}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});function U(){var e=new k(4);return k!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}F(),function(){var e,t=(e=new k(4),k!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e)}();var H;async function j(e,t){return(await fetch(e)).text()}async function B(e,t){let s=await fetch(e);return function(e){const t=[],s=[],n=[],i=[],r=[],o=[],a=/^#.*/g,l=/v\s+(\S+)\s+(\S+)\s+(\S+)/g,u=/vn\s+(\S+)\s+(\S+)\s+(\S+)/g,h=/vt\s+(\S+)\s+(\S+)/g,c=/f\s+(([^/\s]*)\/([^/\s]*)\/?([^/\s]*))\s+(([^/\s]*)\/([^/\s]*)\/?([^/\s]*))\s+(([^/\s]*)\/([^/\s]*)\/?([^/\s]*))(\s+(([^/\s]*)\/([^/\s]*)\/?([^/\s]*)))?/g,d=/f\s+([^/\s]+)\s+([^/\s]+)\s+([^/\s]+)/g;let p,m,f,b,v,_,y=!1,g=null;e=e.replace(a,"");for(;null!=(g=l.exec(e));)p=Number.parseFloat(g[1]),m=Number.parseFloat(g[2]),f=Number.parseFloat(g[3]),t.push(p),t.push(m),t.push(f);for(;null!=(g=u.exec(e));)p=Number.parseFloat(g[1]),m=Number.parseFloat(g[2]),f=Number.parseFloat(g[3]),n.push(p),n.push(m),n.push(f);for(;null!=(g=h.exec(e));)p=Number.parseFloat(g[1]),m=Number.parseFloat(g[2]),s.push(p),s.push(m);for(;null!=(g=c.exec(e));)p=Number.parseInt(g[2]),Number.isNaN(p)&&(p=1),m=Number.parseInt(g[6]),Number.isNaN(m)&&(m=1),f=Number.parseInt(g[10]),Number.isNaN(f)&&(f=1),i.push(p),i.push(m),i.push(f),p=Number.parseInt(g[4]),Number.isNaN(p)?(p=Number.parseInt(g[3]),m=Number.parseInt(g[7]),f=Number.parseInt(g[11]),o.push(p),o.push(m),o.push(f),r.push(1),r.push(1),r.push(1)):(m=Number.parseInt(g[8]),Number.isNaN(m)&&(m=1),f=Number.parseInt(g[12]),Number.isNaN(f)&&(f=1),o.push(p),o.push(m),o.push(f),p=Number.parseInt(g[3]),Number.isNaN(p)&&(p=1),m=Number.parseInt(g[7]),Number.isNaN(m)&&(m=1),f=Number.parseInt(g[11]),Number.isNaN(f)&&(f=1),r.push(p),r.push(m),r.push(f)),void 0!==g[13]&&(b=Number.parseInt(g[15]),Number.isNaN(b)&&(b=1),i.push(b),b=Number.parseInt(g[17]),Number.isNaN(b)?(b=Number.parseInt(g[16]),o.push(b),r.push(1)):(o.push(b),b=Number.parseInt(g[16]),r.push(b)),y=!0);for(;null!=(g=d.exec(e));)p=Number.parseInt(g[2]),m=Number.parseInt(g[6]),f=Number.parseInt(g[10]),i.push(p),i.push(m),i.push(f),r.push(1),r.push(1),r.push(1),o.push(1),o.push(1),o.push(1),void 0!==g[13]&&(b=Number.parseInt(g[14]),i.push(b),r.push(1),o.push(1),y=!0);_=i.length;const E=new Float32Array(3*_);for(let e=0;e<_;++e)v=i[e]-1,E[3*e+0]=t[3*v+0],E[3*e+1]=t[3*v+1],E[3*e+2]=t[3*v+2];_=r.length;const w=new Float32Array(2*_);for(let e=0;e<_;++e)v=r[e]-1,w[2*e+0]=s[2*v+0],w[2*e+1]=s[2*v+1];_=o.length;const S=new Float32Array(3*_);for(let e=0;e<_;++e)v=o[e]-1,S[3*e+0]=n[3*v+0],S[3*e+1]=n[3*v+1],S[3*e+2]=n[3*v+2];_=i.length;const A=new Uint16Array(_);for(let e=0;e<_;++e)A[e]=e;y&&console.warn("WebGL does not support quad faces, only triangles.");return{positions:E,texcoords:w,normals:S,indices:A}}(await s.text())}function V(e){return"undefined"!=typeof WebGL2RenderingContext&&e instanceof WebGL2RenderingContext}function K(e,t){switch(t){case e.FLOAT:return 1;case e.FLOAT_VEC2:return 2;case e.FLOAT_VEC3:return 3;case e.FLOAT_VEC4:case e.FLOAT_MAT2:return 4;case e.FLOAT_MAT3:return 9;case e.FLOAT_MAT4:return 16;default:throw new Error("Invalid vertex attribute type.")}}F(),D(1,0,0),D(0,1,0),U(),U(),H=new k(9),k!=Float32Array&&(H[1]=0,H[2]=0,H[3]=0,H[5]=0,H[6]=0,H[7]=0),H[0]=1,H[4]=1,H[8]=1;class W{constructor(e,t){this.gl=e,this.target=t}data(e,t){const s=this.gl,n=this.target;if(!ArrayBuffer.isView(e))throw new Error("Source data must be a typed array.");return s.bufferData(n,e,t||s.STATIC_DRAW),this}subData(e,t=0,s,n){const i=this.gl,r=this.target;if(!ArrayBuffer.isView(e))throw new Error("Source data must be a typed array.");if(s)if(V(i))i.bufferSubData(r,t,e,s,n);else{const o=n?e.subarray(s,s+n):e.subarray(s);i.bufferSubData(r,t,o)}else i.bufferSubData(r,t,e);return this}}class q extends W{static from(e,t,s){return new q(e,t,s)}constructor(e,t,s){super(e,t),this.handle=s||e.createBuffer(),e.bindBuffer(t,this.handle)}build(){return this.handle}}function Y(e,t){switch(t){case Int8Array:return e.BYTE;case Uint8Array:return e.UNSIGNED_BYTE;case Int16Array:return e.SHORT;case Uint16Array:return e.UNSIGNED_SHORT;case Int32Array:return e.INT;case Uint32Array:return e.UNSIGNED_INT;case Float32Array:return e.FLOAT;default:throw new Error("Cannot find valid buffer type for typed array.")}}class G extends q{constructor(e,t){super(e,t),this.bufferType=e.FLOAT}data(e,t){let s=super.data(e,t);const n=e.constructor;return this.bufferType=Y(this.gl,n),s}subData(e,t,s,n){let i=super.subData(e,t,s,n);const r=e.constructor;return this.bufferType=Y(this.gl,r),i}build(){const e=super.build(),t=this.gl,s=this.target,n=this.bufferType;return new z(t,s,n,e)}}class z{static from(e,t){return new G(e,t)}constructor(e,t,s,n){this.gl=e,this.target=t,this.handle=n,this.type=s,this.bindContext=new X(e,this)}bind(e){return e.bindBuffer(this.target,this.handle),this.bindContext.gl=e,this.bindContext}}class X extends W{constructor(e,t){super(e,t.target),this.parent=t}}function $(e,t){switch(t){case e.FLOAT:return e.uniform1f;case e.FLOAT_VEC2:return e.uniform2fv;case e.FLOAT_VEC3:return e.uniform3fv;case e.FLOAT_VEC4:return e.uniform4fv;case e.INT:return e.uniform1i;case e.INT_VEC2:return e.uniform2iv;case e.INT_VEC3:return e.uniform3iv;case e.INT_VEC4:return e.uniform4iv;case e.BOOL:return e.uniform1i;case e.BOOL_VEC2:return e.uniform2iv;case e.BOOL_VEC3:return e.uniform3iv;case e.BOOL_VEC4:return e.uniform4iv;case e.FLOAT_MAT2:return J;case e.FLOAT_MAT3:return Q;case e.FLOAT_MAT4:return ee;case e.SAMPLER_2D:case e.SAMPLER_CUBE:return e.uniform1i}if(V(e))switch(t){case e.UNSIGNED_INT:return e.uniform1ui;case e.UNSIGNED_INT_VEC2:return e.uniform2uiv;case e.UNSIGNED_INT_VEC3:return e.uniform3uiv;case e.UNSIGNED_INT_VEC4:return e.uniform4uiv;case e.FLOAT_MAT2x3:return te;case e.FLOAT_MAT2x4:return se;case e.FLOAT_MAT3x2:return ne;case e.FLOAT_MAT3x4:return ie;case e.FLOAT_MAT4x2:return re;case e.FLOAT_MAT4x3:return oe;case e.SAMPLER_3D:case e.SAMPLER_2D_SHADOW:case e.SAMPLER_2D_ARRAY:case e.SAMPLER_2D_ARRAY_SHADOW:case e.SAMPLER_CUBE_SHADOW:case e.INT_SAMPLER_2D:case e.INT_SAMPLER_3D:case e.INT_SAMPLER_CUBE:case e.INT_SAMPLER_2D_ARRAY:case e.UNSIGNED_INT_SAMPLER_2D:case e.UNSIGNED_INT_SAMPLER_3D:case e.UNSIGNED_INT_SAMPLER_CUBE:case e.UNSIGNED_INT_SAMPLER_2D_ARRAY:return e.uniform1i}throw new Error("Cannot find uniform function for gl enum.")}function Z(e,t){switch(t){case e.FLOAT:return e.uniform1fv;case e.FLOAT_VEC2:return e.uniform2fv;case e.FLOAT_VEC3:return e.uniform3fv;case e.FLOAT_VEC4:return e.uniform4fv;case e.INT:return e.uniform1iv;case e.INT_VEC2:return e.uniform2iv;case e.INT_VEC3:return e.uniform3iv;case e.INT_VEC4:return e.uniform4iv;case e.BOOL:return e.uniform1iv;case e.BOOL_VEC2:return e.uniform2iv;case e.BOOL_VEC3:return e.uniform3iv;case e.BOOL_VEC4:return e.uniform4iv;case e.FLOAT_MAT2:return J;case e.FLOAT_MAT3:return Q;case e.FLOAT_MAT4:return ee;case e.SAMPLER_2D:case e.SAMPLER_CUBE:return e.uniform1iv}if(V(e))switch(t){case e.UNSIGNED_INT:return e.uniform1uiv;case e.UNSIGNED_INT_VEC2:return e.uniform2uiv;case e.UNSIGNED_INT_VEC3:return e.uniform3uiv;case e.UNSIGNED_INT_VEC4:return e.uniform4uiv;case e.FLOAT_MAT2x3:return te;case e.FLOAT_MAT2x4:return se;case e.FLOAT_MAT3x2:return ne;case e.FLOAT_MAT3x4:return ie;case e.FLOAT_MAT4x2:return re;case e.FLOAT_MAT4x3:return oe;case e.SAMPLER_3D:case e.SAMPLER_2D_SHADOW:case e.SAMPLER_2D_ARRAY:case e.SAMPLER_2D_ARRAY_SHADOW:case e.SAMPLER_CUBE_SHADOW:case e.INT_SAMPLER_2D:case e.INT_SAMPLER_3D:case e.INT_SAMPLER_CUBE:case e.INT_SAMPLER_2D_ARRAY:case e.UNSIGNED_INT_SAMPLER_2D:case e.UNSIGNED_INT_SAMPLER_3D:case e.UNSIGNED_INT_SAMPLER_CUBE:case e.UNSIGNED_INT_SAMPLER_2D_ARRAY:return e.uniform1iv}throw new Error("Cannot find array uniform function for gl enum.")}function J(e,t){this.uniformMatrix2fv(e,!1,t)}function Q(e,t){this.uniformMatrix3fv(e,!1,t)}function ee(e,t){this.uniformMatrix4fv(e,!1,t)}function te(e,t){this.uniformMatrix2x3fv(e,!1,t)}function se(e,t){this.uniformMatrix2x4fv(e,!1,t)}function ne(e,t){this.uniformMatrix3x2fv(e,!1,t)}function ie(e,t){this.uniformMatrix3x4fv(e,!1,t)}function re(e,t){this.uniformMatrix4x2fv(e,!1,t)}function oe(e,t){this.uniformMatrix4x3fv(e,!1,t)}class ae{static from(e,t){return new ae(e,t)}constructor(e,t){this.handle=t||e.createProgram(),this.shaders=[],this.gl=e}shader(e,t){let s=function(e,t,s){let n=e.createShader(t);return e.shaderSource(n,s),e.compileShader(n),e.getShaderParameter(n,e.COMPILE_STATUS)||(console.error(e.getShaderInfoLog(n)+`\nFailed to compile shader:\n${s}`),e.deleteShader(n)),n}(this.gl,e,t);return this.shaders.push(s),this}link(){return function(e,t,s){for(let n of s)e.attachShader(t,n);e.linkProgram(t);for(let n of s)e.detachShader(t,n),e.deleteShader(n);e.getProgramParameter(t,e.LINK_STATUS)||(console.error(e.getProgramInfoLog(t)),e.deleteProgram(t))}(this.gl,this.handle,this.shaders),this.shaders.length=0,this.handle}}class le extends ae{constructor(e){super(e)}link(){const e=super.link();return new ue(this.gl,e)}}class ue{static from(e){return new le(e)}constructor(e,t){this.handle=t,this.activeUniforms=function(e,t){let s={};const n=function(e,t){let s=[];const n=e.getProgramParameter(t,e.ACTIVE_UNIFORMS);for(let i=0;i<n;++i){let n=e.getActiveUniform(t,i);if(!n)break;s.push(n)}return s}(e,t);for(let i of n){const n=i.name,r=i.size,o=i.type,a=e.getUniformLocation(t,n);let l;l=r<=1?$(e,o):Z(e,o),s[n]={type:o,length:r,location:a,set:l}}return s}(e,t),this.activeAttributes=function(e,t){let s={};const n=function(e,t){let s=[];const n=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES);for(let i=0;i<n;++i){let n=e.getActiveAttrib(t,i);n&&s.push(n)}return s}(e,t);for(let i of n){const n=i.name,r=i.size,o=i.type,a=e.getAttribLocation(t,n),l=K(e,o);s[n]={type:o,length:r,location:a,size:l}}return s}(e,t),this.drawContext=new he(e,this)}bind(e){return e.useProgram(this.handle),this.drawContext.gl=e,this.drawContext}}class he{constructor(e,t){this.gl=e,this.parent=t}uniform(e,t){const s=this.parent.activeUniforms;if(e in s){let n=s[e],i=n.location;n.set.call(this.gl,i,t)}return this}attribute(e,t,s,n=!1,i=0,r=0){const o=this.gl,a=this.parent.activeAttributes;if(e in a){let l=a[e],u=l.location,h=l.size;s?(o.bindBuffer(o.ARRAY_BUFFER,s),o.vertexAttribPointer(u,h,t,n,i,r),o.enableVertexAttribArray(u)):o.disableVertexAttribArray(u)}return this}draw(e,t,s,n,i=null){return function(e,t,s,n,i){i?(e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,i),e.drawElements(t,n,e.UNSIGNED_SHORT,s)):e.drawArrays(t,s,n)}(e,t,s,n,i),this.parent}}D(0,1,0);const ce=Math.PI/3;class de extends class{constructor(e,t,s){this.canvas=e,this.projectionMatrix=t,this.viewMatrix=s,this.resize=this.resize.bind(this),e.addEventListener("resize",this.resize),setTimeout(this.resize,0)}destroy(){this.canvas.removeEventListener("resize",this.resize)}resize(){}}{constructor(e,t=ce,s=.1,n=1e3){super(e,R(),R()),this.fieldOfView=t,this.clippingPlane={near:s,far:n}}resize(){const e=this.canvas.width/this.canvas.height,{near:t,far:s}=this.clippingPlane;!function(e,t,s,n,i){var r,o=1/Math.tan(t/2);e[0]=o/s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=o,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=i&&i!==1/0?(r=1/(n-i),e[10]=(i+n)*r,e[14]=2*i*n*r):(e[10]=-1,e[14]=-2*n)}(this.projectionMatrix,this.fieldOfView,e,t,s)}}window.addEventListener("DOMContentLoaded",(async function(){const e=document.querySelector("#main"),t=document.querySelector("#input");t.source.autopoll=!0;const s=e.canvas.getContext("webgl");if(!s)throw new Error("Your browser does not support WebGL.");s.enable(s.DEPTH_TEST);const n=await j("main.vert"),i=await j("main.frag"),r=await B("cube.obj"),o=await async function(e,t){return new Promise(((t,s)=>{let n=new Image;n.addEventListener("load",(()=>{t(n)})),n.addEventListener("error",(e=>{s(e)})),n.src=e}))}("people/hairguy.png"),a=ue.from(s).shader(s.VERTEX_SHADER,n).shader(s.FRAGMENT_SHADER,i).link(),l=function(e,t){return{position:z.from(e,e.ARRAY_BUFFER).data(t.positions).build(),texcoord:z.from(e,e.ARRAY_BUFFER).data(t.texcoords).build(),normal:z.from(e,e.ARRAY_BUFFER).data(t.normals).build(),element:z.from(e,e.ELEMENT_ARRAY_BUFFER).data(t.indices).build(),elementOffset:0,elementCount:t.indices.length}}(s,r),u={[Symbol.iterator](){return this.instances[Symbol.iterator]()},instances:[],create(e=0,t=0,s=0,n=e+1,i=t+1,r=s+1){let o=e,a=t,l=s,u=n,h=i,c=r;o>u&&(o=n,u=e),a>h&&(a=i,h=t),l>c&&(l=r,c=s);let d=(u-o)/2,p=(h-a)/2,m=(c-l)/2,f=o+d,b=a+p,v=l+m,_=R();!function(e,t,s,n){var i=t[0],r=t[1],o=t[2],a=t[3],l=i+i,u=r+r,h=o+o,c=i*l,d=i*u,p=i*h,m=r*u,f=r*h,b=o*h,v=a*l,_=a*u,y=a*h,g=n[0],E=n[1],w=n[2];e[0]=(1-(m+b))*g,e[1]=(d+y)*g,e[2]=(p-_)*g,e[3]=0,e[4]=(d-y)*E,e[5]=(1-(c+b))*E,e[6]=(f+v)*E,e[7]=0,e[8]=(p+_)*w,e[9]=(f-v)*w,e[10]=(1-(c+m))*w,e[11]=0,e[12]=s[0],e[13]=s[1],e[14]=s[2],e[15]=1}(_,U(),D(f,b,v),D(d,p,m));let y={transform:_,color:D(1*Math.random(),1*Math.random(),1*Math.random())};return this.instances.push(y),y}},h=u.create();u.create(2,1),u.create(-10,-1,-10,10,-2,10);const c=s.createTexture();s.bindTexture(s.TEXTURE_2D,c),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,o),s.generateMipmap(s.TEXTURE_2D),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST);const d=new de(e.canvas);t.context.getInput("PointerX"),t.context.getInput("PointerY"),t.context.getInput("PointerDown"),t.context.getInput("LookX"),t.context.getInput("LookY");const p=t.context.getInput("MoveX"),m=t.context.getInput("MoveY"),f=t.context.getInput("MoveZ");e.addEventListener("frame",(({deltaTime:e})=>{let t=p.value,n=m.value,i=f.value;P(h.transform,h.transform,[t,n,i]),function(e,t,s,n=0,i=1){let r=F();!function(e,t){e[0]=t[12],e[1]=t[13],e[2]=t[14]}(r,e),P(e,e,D((t-r[0])*i,(s-r[1])*i,(n-r[2])*i))}(d.viewMatrix),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,c);let r=a.bind(s).uniform("u_projection",d.projectionMatrix).uniform("u_view",d.viewMatrix).attribute("a_position",l.position.type,l.position.handle).attribute("a_texcoord",l.texcoord.type,l.texcoord.handle);for(let e of u)r.uniform("u_model",e.transform).uniform("u_color",e.color).uniform("u_texture",0).draw(s,s.TRIANGLES,l.elementOffset,l.elementCount,l.element.handle)}))}))}();
